---
title: Intergiciel de mise en cache des réponses dans ASP.NET Core
author: rick-anderson
description: Découvrez comment configurer et utiliser le middleware de mise en cache des réponses dans ASP.NET Core.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 02/07/2020
uid: performance/caching/middleware
ms.openlocfilehash: 4deac15538d4607bd611c4e072daae39447681c1
ms.sourcegitcommit: 9a129f5f3e31cc449742b164d5004894bfca90aa
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78655735"
---
# <a name="response-caching-middleware-in-aspnet-core"></a><span data-ttu-id="ca950-103">Intergiciel de mise en cache des réponses dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="ca950-103">Response Caching Middleware in ASP.NET Core</span></span>

<span data-ttu-id="ca950-104">Par [John Luo](https://github.com/JunTaoLuo)</span><span class="sxs-lookup"><span data-stu-id="ca950-104">By [John Luo](https://github.com/JunTaoLuo)</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="ca950-105">Cet article explique comment configurer l’intergiciel (middleware) de mise en cache des réponses dans une application ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="ca950-105">This article explains how to configure Response Caching Middleware in an ASP.NET Core app.</span></span> <span data-ttu-id="ca950-106">L’intergiciel détermine quand les réponses sont pouvant être mises en cache, stocke les réponses et sert les réponses du cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-106">The middleware determines when responses are cacheable, stores responses, and serves responses from cache.</span></span> <span data-ttu-id="ca950-107">Pour obtenir une présentation de la mise en cache HTTP et de l’attribut [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) , consultez [mise en cache des réponses](xref:performance/caching/response).</span><span class="sxs-lookup"><span data-stu-id="ca950-107">For an introduction to HTTP caching and the [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute, see [Response Caching](xref:performance/caching/response).</span></span>

<span data-ttu-id="ca950-108">[Affichez ou téléchargez l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="ca950-108">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="configuration"></a><span data-ttu-id="ca950-109">Configuration</span><span class="sxs-lookup"><span data-stu-id="ca950-109">Configuration</span></span>

<span data-ttu-id="ca950-110">L’intergiciel (middleware) de mise en cache des réponses est implicitement disponible pour les applications ASP.NET Core via le Framework partagé.</span><span class="sxs-lookup"><span data-stu-id="ca950-110">Response Caching Middleware is implicitly available for ASP.NET Core apps via the shared framework.</span></span>

<span data-ttu-id="ca950-111">Dans `Startup.ConfigureServices`, ajoutez l’intergiciel (middleware) de mise en cache des réponses à la collection de services :</span><span class="sxs-lookup"><span data-stu-id="ca950-111">In `Startup.ConfigureServices`, add the Response Caching Middleware to the service collection:</span></span>

[!code-csharp[](middleware/samples/3.x/ResponseCachingMiddleware/Startup.cs?name=snippet1&highlight=3)]

<span data-ttu-id="ca950-112">Configurez l’application pour utiliser l’intergiciel avec la méthode d’extension <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*>, qui ajoute l’intergiciel au pipeline de traitement des requêtes dans `Startup.Configure`:</span><span class="sxs-lookup"><span data-stu-id="ca950-112">Configure the app to use the middleware with the <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*> extension method, which adds the middleware to the request processing pipeline in `Startup.Configure`:</span></span>

[!code-csharp[](middleware/samples/3.x/ResponseCachingMiddleware/Startup.cs?name=snippet2&highlight=16)]

<span data-ttu-id="ca950-113">L’exemple d’application ajoute des en-têtes pour contrôler la mise en cache lors des requêtes suivantes :</span><span class="sxs-lookup"><span data-stu-id="ca950-113">The sample app adds headers to control caching on subsequent requests:</span></span>

* <span data-ttu-id="ca950-114">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; met en cache les réponses pouvant être mises en cache pendant 10 secondes.</span><span class="sxs-lookup"><span data-stu-id="ca950-114">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; Caches cacheable responses for up to 10 seconds.</span></span>
* <span data-ttu-id="ca950-115">[Modifier](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; configure l’intergiciel pour traiter une réponse mise en cache uniquement si l’en-tête [accepter-encodage](https://tools.ietf.org/html/rfc7231#section-5.3.4) des demandes suivantes correspond à celui de la demande d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-115">[Vary](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; Configures the middleware to serve a cached response only if the [Accept-Encoding](https://tools.ietf.org/html/rfc7231#section-5.3.4) header of subsequent requests matches that of the original request.</span></span>

[!code-csharp[](middleware/samples_snippets/3.x/AddHeaders.cs)]

<span data-ttu-id="ca950-116">L’intergiciel (middleware) de mise en cache des réponses met uniquement en cache les réponses du serveur qui génèrent un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="ca950-116">Response Caching Middleware only caches server responses that result in a 200 (OK) status code.</span></span> <span data-ttu-id="ca950-117">Toutes les autres réponses, y compris les [pages d’erreur](xref:fundamentals/error-handling), sont ignorées par l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="ca950-117">Any other responses, including [error pages](xref:fundamentals/error-handling), are ignored by the middleware.</span></span>

> [!WARNING]
> <span data-ttu-id="ca950-118">Les réponses contenant du contenu pour les clients authentifiés doivent être marquées comme ne pouvant pas être mises en cache pour empêcher l’intergiciel de stocker et desservir ces réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-118">Responses containing content for authenticated clients must be marked as not cacheable to prevent the middleware from storing and serving those responses.</span></span> <span data-ttu-id="ca950-119">Pour plus d’informations sur la façon dont l’intergiciel détermine si une réponse peut être mise en cache, consultez [conditions de mise en cache](#conditions-for-caching) .</span><span class="sxs-lookup"><span data-stu-id="ca950-119">See [Conditions for caching](#conditions-for-caching) for details on how the middleware determines if a response is cacheable.</span></span>

## <a name="options"></a><span data-ttu-id="ca950-120">Options</span><span class="sxs-lookup"><span data-stu-id="ca950-120">Options</span></span>

<span data-ttu-id="ca950-121">Les options de mise en cache des réponses sont indiquées dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="ca950-121">Response caching options are shown in the following table.</span></span>

| <span data-ttu-id="ca950-122">Option</span><span class="sxs-lookup"><span data-stu-id="ca950-122">Option</span></span> | <span data-ttu-id="ca950-123">Description</span><span class="sxs-lookup"><span data-stu-id="ca950-123">Description</span></span> |
| ------ | ----------- |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize> | <span data-ttu-id="ca950-124">Plus grande taille pouvant être mise en cache pour le corps de la réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-124">The largest cacheable size for the response body in bytes.</span></span> <span data-ttu-id="ca950-125">La valeur par défaut est `64 * 1024 * 1024` (64 Mo).</span><span class="sxs-lookup"><span data-stu-id="ca950-125">The default value is `64 * 1024 * 1024` (64 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit> | <span data-ttu-id="ca950-126">Taille limite de l’intergiciel (middleware) du cache de réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-126">The size limit for the response cache middleware in bytes.</span></span> <span data-ttu-id="ca950-127">La valeur par défaut est `100 * 1024 * 1024` (100 Mo).</span><span class="sxs-lookup"><span data-stu-id="ca950-127">The default value is `100 * 1024 * 1024` (100 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.UseCaseSensitivePaths> | <span data-ttu-id="ca950-128">Détermine si les réponses sont mises en cache sur les chemins d’accès sensibles à la casse.</span><span class="sxs-lookup"><span data-stu-id="ca950-128">Determines if responses are cached on case-sensitive paths.</span></span> <span data-ttu-id="ca950-129">La valeur par défaut est `false`.</span><span class="sxs-lookup"><span data-stu-id="ca950-129">The default value is `false`.</span></span> |

<span data-ttu-id="ca950-130">L’exemple suivant configure l’intergiciel (middleware) sur :</span><span class="sxs-lookup"><span data-stu-id="ca950-130">The following example configures the middleware to:</span></span>

* <span data-ttu-id="ca950-131">Met en cache les réponses dont la taille du corps est inférieure ou égale à 1 024 octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-131">Cache responses with a body size smaller than or equal to 1,024 bytes.</span></span>
* <span data-ttu-id="ca950-132">Stockez les réponses en respectant les chemins sensibles à la casse.</span><span class="sxs-lookup"><span data-stu-id="ca950-132">Store the responses by case-sensitive paths.</span></span> <span data-ttu-id="ca950-133">Par exemple, `/page1` et `/Page1` sont stockés séparément.</span><span class="sxs-lookup"><span data-stu-id="ca950-133">For example, `/page1` and `/Page1` are stored separately.</span></span>

```csharp
services.AddResponseCaching(options =>
{
    options.MaximumBodySize = 1024;
    options.UseCaseSensitivePaths = true;
});
```

## <a name="varybyquerykeys"></a><span data-ttu-id="ca950-134">VaryByQueryKeys</span><span class="sxs-lookup"><span data-stu-id="ca950-134">VaryByQueryKeys</span></span>

<span data-ttu-id="ca950-135">Lorsque vous utilisez des contrôleurs d’API Web ou des contrôleurs d’API MVC/Web ou Razor Pages modèles de page, l’attribut [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) spécifie les paramètres nécessaires pour définir les en-têtes appropriés pour la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-135">When using MVC / web API controllers or Razor Pages page models, the [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute specifies the parameters necessary for setting the appropriate headers for response caching.</span></span> <span data-ttu-id="ca950-136">Le seul paramètre de l’attribut `[ResponseCache]` qui requiert strictement l’intergiciel est <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, qui ne correspond pas à un en-tête HTTP réel.</span><span class="sxs-lookup"><span data-stu-id="ca950-136">The only parameter of the `[ResponseCache]` attribute that strictly requires the middleware is <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, which doesn't correspond to an actual HTTP header.</span></span> <span data-ttu-id="ca950-137">Pour plus d’informations, consultez <xref:performance/caching/response#responsecache-attribute>.</span><span class="sxs-lookup"><span data-stu-id="ca950-137">For more information, see <xref:performance/caching/response#responsecache-attribute>.</span></span>

<span data-ttu-id="ca950-138">Quand vous n’utilisez pas l’attribut `[ResponseCache]`, la mise en cache des réponses peut être modifiée avec `VaryByQueryKeys`.</span><span class="sxs-lookup"><span data-stu-id="ca950-138">When not using the `[ResponseCache]` attribute, response caching can be varied with `VaryByQueryKeys`.</span></span> <span data-ttu-id="ca950-139">Utilisez le <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directement à partir de [HttpContext. Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span><span class="sxs-lookup"><span data-stu-id="ca950-139">Use the <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directly from the [HttpContext.Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span></span>

```csharp
var responseCachingFeature = context.HttpContext.Features.Get<IResponseCachingFeature>();

if (responseCachingFeature != null)
{
    responseCachingFeature.VaryByQueryKeys = new[] { "MyKey" };
}
```

<span data-ttu-id="ca950-140">L’utilisation d’une valeur unique égale à `*` dans `VaryByQueryKeys` fait varier le cache par tous les paramètres de requête de demande.</span><span class="sxs-lookup"><span data-stu-id="ca950-140">Using a single value equal to `*` in `VaryByQueryKeys` varies the cache by all request query parameters.</span></span>

## <a name="http-headers-used-by-response-caching-middleware"></a><span data-ttu-id="ca950-141">En-têtes HTTP utilisés par l’intergiciel (middleware) de mise en cache des réponses</span><span class="sxs-lookup"><span data-stu-id="ca950-141">HTTP headers used by Response Caching Middleware</span></span>

<span data-ttu-id="ca950-142">Le tableau suivant fournit des informations sur les en-têtes HTTP qui affectent la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-142">The following table provides information on HTTP headers that affect response caching.</span></span>

| <span data-ttu-id="ca950-143">En-tête</span><span class="sxs-lookup"><span data-stu-id="ca950-143">Header</span></span> | <span data-ttu-id="ca950-144">Détails</span><span class="sxs-lookup"><span data-stu-id="ca950-144">Details</span></span> |
| ------ | ------- |
| `Authorization` | <span data-ttu-id="ca950-145">La réponse n’est pas mise en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="ca950-145">The response isn't cached if the header exists.</span></span> |
| `Cache-Control` | <span data-ttu-id="ca950-146">L’intergiciel prend uniquement en compte les réponses de mise en cache marquées avec la directive de cache `public`.</span><span class="sxs-lookup"><span data-stu-id="ca950-146">The middleware only considers caching responses marked with the `public` cache directive.</span></span> <span data-ttu-id="ca950-147">Contrôlez la mise en cache avec les paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="ca950-147">Control caching with the following parameters:</span></span><ul><li><span data-ttu-id="ca950-148">âge maximal</span><span class="sxs-lookup"><span data-stu-id="ca950-148">max-age</span></span></li><li><span data-ttu-id="ca950-149">Max-obsolète&#8224;</span><span class="sxs-lookup"><span data-stu-id="ca950-149">max-stale&#8224;</span></span></li><li><span data-ttu-id="ca950-150">min-frais</span><span class="sxs-lookup"><span data-stu-id="ca950-150">min-fresh</span></span></li><li><span data-ttu-id="ca950-151">must-revalidate</span><span class="sxs-lookup"><span data-stu-id="ca950-151">must-revalidate</span></span></li><li><span data-ttu-id="ca950-152">no-cache</span><span class="sxs-lookup"><span data-stu-id="ca950-152">no-cache</span></span></li><li><span data-ttu-id="ca950-153">non-Store</span><span class="sxs-lookup"><span data-stu-id="ca950-153">no-store</span></span></li><li><span data-ttu-id="ca950-154">uniquement-en cas de mise en cache</span><span class="sxs-lookup"><span data-stu-id="ca950-154">only-if-cached</span></span></li><li><span data-ttu-id="ca950-155">private</span><span class="sxs-lookup"><span data-stu-id="ca950-155">private</span></span></li><li><span data-ttu-id="ca950-156">public</span><span class="sxs-lookup"><span data-stu-id="ca950-156">public</span></span></li><li><span data-ttu-id="ca950-157">s-maxage</span><span class="sxs-lookup"><span data-stu-id="ca950-157">s-maxage</span></span></li><li><span data-ttu-id="ca950-158">proxy-revalidate&#8225;</span><span class="sxs-lookup"><span data-stu-id="ca950-158">proxy-revalidate&#8225;</span></span></li></ul><span data-ttu-id="ca950-159">&#8224;Si aucune limite n’est spécifiée pour `max-stale`, l’intergiciel n’entreprend aucune action.</span><span class="sxs-lookup"><span data-stu-id="ca950-159">&#8224;If no limit is specified to `max-stale`, the middleware takes no action.</span></span><br><span data-ttu-id="ca950-160">&#8225;`proxy-revalidate` a le même effet que `must-revalidate`.</span><span class="sxs-lookup"><span data-stu-id="ca950-160">&#8225;`proxy-revalidate` has the same effect as `must-revalidate`.</span></span><br><br><span data-ttu-id="ca950-161">Pour plus d’informations, consultez [RFC 7231 : Request Cache-Control directives](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span><span class="sxs-lookup"><span data-stu-id="ca950-161">For more information, see [RFC 7231: Request Cache-Control Directives](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span></span> |
| `Pragma` | <span data-ttu-id="ca950-162">Un en-tête de `Pragma: no-cache` dans la demande produit le même effet que `Cache-Control: no-cache`.</span><span class="sxs-lookup"><span data-stu-id="ca950-162">A `Pragma: no-cache` header in the request produces the same effect as `Cache-Control: no-cache`.</span></span> <span data-ttu-id="ca950-163">Cet en-tête est substitué par les directives pertinentes dans l’en-tête `Cache-Control`, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="ca950-163">This header is overridden by the relevant directives in the `Cache-Control` header, if present.</span></span> <span data-ttu-id="ca950-164">Pris en compte pour la compatibilité descendante avec HTTP/1.0.</span><span class="sxs-lookup"><span data-stu-id="ca950-164">Considered for backward compatibility with HTTP/1.0.</span></span> |
| `Set-Cookie` | <span data-ttu-id="ca950-165">La réponse n’est pas mise en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="ca950-165">The response isn't cached if the header exists.</span></span> <span data-ttu-id="ca950-166">Tout intergiciel dans le pipeline de traitement des demandes qui définit un ou plusieurs cookies empêche l’intergiciel (middleware) de mise en cache des réponses de mettre en cache la réponse (par exemple, le [fournisseur TempData basé sur les cookies](xref:fundamentals/app-state#tempdata)).</span><span class="sxs-lookup"><span data-stu-id="ca950-166">Any middleware in the request processing pipeline that sets one or more cookies prevents the Response Caching Middleware from caching the response (for example, the [cookie-based TempData provider](xref:fundamentals/app-state#tempdata)).</span></span>  |
| `Vary` | <span data-ttu-id="ca950-167">L’en-tête `Vary` est utilisé pour faire varier la réponse mise en cache par un autre en-tête.</span><span class="sxs-lookup"><span data-stu-id="ca950-167">The `Vary` header is used to vary the cached response by another header.</span></span> <span data-ttu-id="ca950-168">Par exemple, mettez en cache les réponses par encodage en incluant l’en-tête `Vary: Accept-Encoding`, qui met en cache les réponses pour les demandes avec des en-têtes `Accept-Encoding: gzip` et `Accept-Encoding: text/plain` séparément.</span><span class="sxs-lookup"><span data-stu-id="ca950-168">For example, cache responses by encoding by including the `Vary: Accept-Encoding` header, which caches responses for requests with headers `Accept-Encoding: gzip` and `Accept-Encoding: text/plain` separately.</span></span> <span data-ttu-id="ca950-169">Une réponse avec une valeur d’en-tête de `*` n’est jamais stockée.</span><span class="sxs-lookup"><span data-stu-id="ca950-169">A response with a header value of `*` is never stored.</span></span> |
| `Expires` | <span data-ttu-id="ca950-170">Une réponse considérée comme périmée par cet en-tête n’est pas stockée ou récupérée, sauf si elle est remplacée par d’autres en-têtes de `Cache-Control`.</span><span class="sxs-lookup"><span data-stu-id="ca950-170">A response deemed stale by this header isn't stored or retrieved unless overridden by other `Cache-Control` headers.</span></span> |
| `If-None-Match` | <span data-ttu-id="ca950-171">La réponse complète est traitée à partir du cache si la valeur n’est pas `*` et que la `ETag` de la réponse ne correspond à aucune des valeurs fournies.</span><span class="sxs-lookup"><span data-stu-id="ca950-171">The full response is served from cache if the value isn't `*` and the `ETag` of the response doesn't match any of the values provided.</span></span> <span data-ttu-id="ca950-172">Dans le cas contraire, une réponse 304 (non modifiée) est traitée.</span><span class="sxs-lookup"><span data-stu-id="ca950-172">Otherwise, a 304 (Not Modified) response is served.</span></span> |
| `If-Modified-Since` | <span data-ttu-id="ca950-173">Si l’en-tête `If-None-Match` n’est pas présent, une réponse complète est traitée à partir du cache si la date de réponse mise en cache est plus récente que la valeur fournie.</span><span class="sxs-lookup"><span data-stu-id="ca950-173">If the `If-None-Match` header isn't present, a full response is served from cache if the cached response date is newer than the value provided.</span></span> <span data-ttu-id="ca950-174">Dans le cas contraire, une réponse *304-non modifiée* est traitée.</span><span class="sxs-lookup"><span data-stu-id="ca950-174">Otherwise, a *304 - Not Modified* response is served.</span></span> |
| `Date` | <span data-ttu-id="ca950-175">En cas de service à partir du cache, l’en-tête `Date` est défini par l’intergiciel (middleware) s’il n’a pas été fourni dans la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-175">When serving from cache, the `Date` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Content-Length` | <span data-ttu-id="ca950-176">En cas de service à partir du cache, l’en-tête `Content-Length` est défini par l’intergiciel (middleware) s’il n’a pas été fourni dans la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-176">When serving from cache, the `Content-Length` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Age` | <span data-ttu-id="ca950-177">L’en-tête `Age` envoyé dans la réponse d’origine est ignoré.</span><span class="sxs-lookup"><span data-stu-id="ca950-177">The `Age` header sent in the original response is ignored.</span></span> <span data-ttu-id="ca950-178">L’intergiciel (middleware) calcule une nouvelle valeur lors de la fourniture d’une réponse mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-178">The middleware computes a new value when serving a cached response.</span></span> |

## <a name="caching-respects-request-cache-control-directives"></a><span data-ttu-id="ca950-179">Mise en cache respecte les directives de contrôle de cache de demande</span><span class="sxs-lookup"><span data-stu-id="ca950-179">Caching respects request Cache-Control directives</span></span>

<span data-ttu-id="ca950-180">L’intergiciel respecte les règles de la [spécification de mise en cache HTTP 1,1](https://tools.ietf.org/html/rfc7234#section-5.2).</span><span class="sxs-lookup"><span data-stu-id="ca950-180">The middleware respects the rules of the [HTTP 1.1 Caching specification](https://tools.ietf.org/html/rfc7234#section-5.2).</span></span> <span data-ttu-id="ca950-181">Les règles requièrent un cache pour honorer un en-tête de `Cache-Control` valide envoyé par le client.</span><span class="sxs-lookup"><span data-stu-id="ca950-181">The rules require a cache to honor a valid `Cache-Control` header sent by the client.</span></span> <span data-ttu-id="ca950-182">Dans le cadre de la spécification, un client peut faire des demandes avec une valeur d’en-tête `no-cache` et forcer le serveur à générer une nouvelle réponse pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="ca950-182">Under the specification, a client can make requests with a `no-cache` header value and force the server to generate a new response for every request.</span></span> <span data-ttu-id="ca950-183">Actuellement, il n’y a pas de contrôle du développeur sur ce comportement de mise en cache lors de l’utilisation de l’intergiciel (middleware), car l’intergiciel respecte la spécification officielle de mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-183">Currently, there's no developer control over this caching behavior when using the middleware because the middleware adheres to the official caching specification.</span></span>

<span data-ttu-id="ca950-184">Pour plus de contrôle sur le comportement de mise en cache, explorez les autres fonctionnalités de mise en cache de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="ca950-184">For more control over caching behavior, explore other caching features of ASP.NET Core.</span></span> <span data-ttu-id="ca950-185">Consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="ca950-185">See the following topics:</span></span>

* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

## <a name="troubleshooting"></a><span data-ttu-id="ca950-186">Dépannage</span><span class="sxs-lookup"><span data-stu-id="ca950-186">Troubleshooting</span></span>

<span data-ttu-id="ca950-187">Si le comportement de mise en cache n’est pas le même que prévu, vérifiez que les réponses sont mises en cache et peuvent être servies à partir du cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-187">If caching behavior isn't as expected, confirm that responses are cacheable and capable of being served from the cache.</span></span> <span data-ttu-id="ca950-188">Examinez les en-têtes entrants de la demande et les en-têtes sortants de la réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-188">Examine the request's incoming headers and the response's outgoing headers.</span></span> <span data-ttu-id="ca950-189">Activez la [journalisation](xref:fundamentals/logging/index) pour faciliter le débogage.</span><span class="sxs-lookup"><span data-stu-id="ca950-189">Enable [logging](xref:fundamentals/logging/index) to help with debugging.</span></span>

<span data-ttu-id="ca950-190">Lors du test et du dépannage du comportement de mise en cache, un navigateur peut définir des en-têtes de demande qui affectent la mise en cache de façon indésirable.</span><span class="sxs-lookup"><span data-stu-id="ca950-190">When testing and troubleshooting caching behavior, a browser may set request headers that affect caching in undesirable ways.</span></span> <span data-ttu-id="ca950-191">Par exemple, un navigateur peut définir l’en-tête `Cache-Control` sur `no-cache` ou `max-age=0` lors de l’actualisation d’une page.</span><span class="sxs-lookup"><span data-stu-id="ca950-191">For example, a browser may set the `Cache-Control` header to `no-cache` or `max-age=0` when refreshing a page.</span></span> <span data-ttu-id="ca950-192">Les outils suivants peuvent définir explicitement des en-têtes de demande et sont préférés pour le test de mise en cache :</span><span class="sxs-lookup"><span data-stu-id="ca950-192">The following tools can explicitly set request headers and are preferred for testing caching:</span></span>

* [<span data-ttu-id="ca950-193">Fiddler</span><span class="sxs-lookup"><span data-stu-id="ca950-193">Fiddler</span></span>](https://www.telerik.com/fiddler)
* [<span data-ttu-id="ca950-194">Postman</span><span class="sxs-lookup"><span data-stu-id="ca950-194">Postman</span></span>](https://www.getpostman.com/)

### <a name="conditions-for-caching"></a><span data-ttu-id="ca950-195">Conditions de mise en cache</span><span class="sxs-lookup"><span data-stu-id="ca950-195">Conditions for caching</span></span>

* <span data-ttu-id="ca950-196">La demande doit aboutir à une réponse du serveur avec un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="ca950-196">The request must result in a server response with a 200 (OK) status code.</span></span>
* <span data-ttu-id="ca950-197">La méthode de demande doit être obtenir ou HEAD.</span><span class="sxs-lookup"><span data-stu-id="ca950-197">The request method must be GET or HEAD.</span></span>
* <span data-ttu-id="ca950-198">Dans `Startup.Configure`, l’intergiciel (middleware) de mise en cache des réponses doit être placé avant l’intergiciel (middleware) qui requiert la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-198">In `Startup.Configure`, Response Caching Middleware must be placed before middleware that require caching.</span></span> <span data-ttu-id="ca950-199">Pour plus d’informations, consultez <xref:fundamentals/middleware/index>.</span><span class="sxs-lookup"><span data-stu-id="ca950-199">For more information, see <xref:fundamentals/middleware/index>.</span></span>
* <span data-ttu-id="ca950-200">L’en-tête `Authorization` ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-200">The `Authorization` header must not be present.</span></span>
* <span data-ttu-id="ca950-201">`Cache-Control` paramètres d’en-tête doivent être valides, et la réponse doit être marquée `public` et non marquée `private`.</span><span class="sxs-lookup"><span data-stu-id="ca950-201">`Cache-Control` header parameters must be valid, and the response must be marked `public` and not marked `private`.</span></span>
* <span data-ttu-id="ca950-202">L’en-tête `Pragma: no-cache` ne doit pas être présent si l’en-tête `Cache-Control` n’est pas présent, car l’en-tête `Cache-Control` remplace l’en-tête `Pragma` lorsqu’il est présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-202">The `Pragma: no-cache` header must not be present if the `Cache-Control` header isn't present, as the `Cache-Control` header overrides the `Pragma` header when present.</span></span>
* <span data-ttu-id="ca950-203">L’en-tête `Set-Cookie` ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-203">The `Set-Cookie` header must not be present.</span></span>
* <span data-ttu-id="ca950-204">`Vary` paramètres d’en-tête doivent être valides et non égaux à `*`.</span><span class="sxs-lookup"><span data-stu-id="ca950-204">`Vary` header parameters must be valid and not equal to `*`.</span></span>
* <span data-ttu-id="ca950-205">La valeur d’en-tête `Content-Length` (si elle est définie) doit correspondre à la taille du corps de la réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-205">The `Content-Length` header value (if set) must match the size of the response body.</span></span>
* <span data-ttu-id="ca950-206">Le <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> n’est pas utilisé.</span><span class="sxs-lookup"><span data-stu-id="ca950-206">The <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> isn't used.</span></span>
* <span data-ttu-id="ca950-207">La réponse ne doit pas être périmée comme spécifié par l’en-tête `Expires` et les directives de cache `max-age` et `s-maxage`.</span><span class="sxs-lookup"><span data-stu-id="ca950-207">The response must not be stale as specified by the `Expires` header and the `max-age` and `s-maxage` cache directives.</span></span>
* <span data-ttu-id="ca950-208">La mise en mémoire tampon des réponses doit réussir.</span><span class="sxs-lookup"><span data-stu-id="ca950-208">Response buffering must be successful.</span></span> <span data-ttu-id="ca950-209">La taille de la réponse doit être inférieure à la <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>configurée ou par défaut.</span><span class="sxs-lookup"><span data-stu-id="ca950-209">The size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>.</span></span> <span data-ttu-id="ca950-210">La taille du corps de la réponse doit être inférieure à la <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>configurée ou par défaut.</span><span class="sxs-lookup"><span data-stu-id="ca950-210">The body size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>.</span></span>
* <span data-ttu-id="ca950-211">La réponse doit être mise en cache conformément aux spécifications de la [norme RFC 7234](https://tools.ietf.org/html/rfc7234) .</span><span class="sxs-lookup"><span data-stu-id="ca950-211">The response must be cacheable according to the [RFC 7234](https://tools.ietf.org/html/rfc7234) specifications.</span></span> <span data-ttu-id="ca950-212">Par exemple, la directive `no-store` ne doit pas exister dans les champs d’en-tête de demande ou de réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-212">For example, the `no-store` directive must not exist in request or response header fields.</span></span> <span data-ttu-id="ca950-213">Pour plus d’informations, consultez la *section 3 : stockage des réponses dans les caches* de [RFC 7234](https://tools.ietf.org/html/rfc7234) .</span><span class="sxs-lookup"><span data-stu-id="ca950-213">See *Section 3: Storing Responses in Caches* of [RFC 7234](https://tools.ietf.org/html/rfc7234) for details.</span></span>

> [!NOTE]
> <span data-ttu-id="ca950-214">Le système anti-contrefaçon pour générer des jetons sécurisés pour empêcher les attaques par falsification de requête intersites (CSRF) définit les en-têtes `Cache-Control` et `Pragma` sur `no-cache` afin que les réponses ne soient pas mises en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-214">The Antiforgery system for generating secure tokens to prevent Cross-Site Request Forgery (CSRF) attacks sets the `Cache-Control` and `Pragma` headers to `no-cache` so that responses aren't cached.</span></span> <span data-ttu-id="ca950-215">Pour plus d’informations sur la façon de désactiver des jetons anti-contrefaçon pour les éléments de formulaire HTML, consultez <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span><span class="sxs-lookup"><span data-stu-id="ca950-215">For information on how to disable antiforgery tokens for HTML form elements, see <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="ca950-216">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="ca950-216">Additional resources</span></span>

* <xref:fundamentals/startup>
* <xref:fundamentals/middleware/index>
* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="ca950-217">Cet article explique comment configurer l’intergiciel (middleware) de mise en cache des réponses dans une application ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="ca950-217">This article explains how to configure Response Caching Middleware in an ASP.NET Core app.</span></span> <span data-ttu-id="ca950-218">L’intergiciel détermine quand les réponses sont pouvant être mises en cache, stocke les réponses et sert les réponses du cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-218">The middleware determines when responses are cacheable, stores responses, and serves responses from cache.</span></span> <span data-ttu-id="ca950-219">Pour obtenir une présentation de la mise en cache HTTP et de l’attribut [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) , consultez [mise en cache des réponses](xref:performance/caching/response).</span><span class="sxs-lookup"><span data-stu-id="ca950-219">For an introduction to HTTP caching and the [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute, see [Response Caching](xref:performance/caching/response).</span></span>

<span data-ttu-id="ca950-220">[Affichez ou téléchargez l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="ca950-220">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="configuration"></a><span data-ttu-id="ca950-221">Configuration</span><span class="sxs-lookup"><span data-stu-id="ca950-221">Configuration</span></span>

<span data-ttu-id="ca950-222">Utilisez le logiciel [Microsoft. AspNetCore. app](xref:fundamentals/metapackage-app) ou ajoutez une référence de package au package [Microsoft. AspNetCore. ResponseCaching](https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/) .</span><span class="sxs-lookup"><span data-stu-id="ca950-222">Use the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app) or add a package reference to the [Microsoft.AspNetCore.ResponseCaching](https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/) package.</span></span>

<span data-ttu-id="ca950-223">Dans `Startup.ConfigureServices`, ajoutez l’intergiciel (middleware) de mise en cache des réponses à la collection de services :</span><span class="sxs-lookup"><span data-stu-id="ca950-223">In `Startup.ConfigureServices`, add the Response Caching Middleware to the service collection:</span></span>

[!code-csharp[](middleware/samples/2.x/ResponseCachingMiddleware/Startup.cs?name=snippet1&highlight=3)]

<span data-ttu-id="ca950-224">Configurez l’application pour utiliser l’intergiciel avec la méthode d’extension <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*>, qui ajoute l’intergiciel au pipeline de traitement des requêtes dans `Startup.Configure`:</span><span class="sxs-lookup"><span data-stu-id="ca950-224">Configure the app to use the middleware with the <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*> extension method, which adds the middleware to the request processing pipeline in `Startup.Configure`:</span></span>

[!code-csharp[](middleware/samples/2.x/ResponseCachingMiddleware/Startup.cs?name=snippet2&highlight=14)]

<span data-ttu-id="ca950-225">L’exemple d’application ajoute des en-têtes pour contrôler la mise en cache lors des requêtes suivantes :</span><span class="sxs-lookup"><span data-stu-id="ca950-225">The sample app adds headers to control caching on subsequent requests:</span></span>

* <span data-ttu-id="ca950-226">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; met en cache les réponses pouvant être mises en cache pendant 10 secondes.</span><span class="sxs-lookup"><span data-stu-id="ca950-226">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; Caches cacheable responses for up to 10 seconds.</span></span>
* <span data-ttu-id="ca950-227">[Modifier](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; configure l’intergiciel pour traiter une réponse mise en cache uniquement si l’en-tête [accepter-encodage](https://tools.ietf.org/html/rfc7231#section-5.3.4) des demandes suivantes correspond à celui de la demande d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-227">[Vary](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; Configures the middleware to serve a cached response only if the [Accept-Encoding](https://tools.ietf.org/html/rfc7231#section-5.3.4) header of subsequent requests matches that of the original request.</span></span>

[!code-csharp[](middleware/samples_snippets/2.x/AddHeaders.cs)]

<span data-ttu-id="ca950-228">L’intergiciel (middleware) de mise en cache des réponses met uniquement en cache les réponses du serveur qui génèrent un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="ca950-228">Response Caching Middleware only caches server responses that result in a 200 (OK) status code.</span></span> <span data-ttu-id="ca950-229">Toutes les autres réponses, y compris les [pages d’erreur](xref:fundamentals/error-handling), sont ignorées par l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="ca950-229">Any other responses, including [error pages](xref:fundamentals/error-handling), are ignored by the middleware.</span></span>

> [!WARNING]
> <span data-ttu-id="ca950-230">Les réponses contenant du contenu pour les clients authentifiés doivent être marquées comme ne pouvant pas être mises en cache pour empêcher l’intergiciel de stocker et desservir ces réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-230">Responses containing content for authenticated clients must be marked as not cacheable to prevent the middleware from storing and serving those responses.</span></span> <span data-ttu-id="ca950-231">Pour plus d’informations sur la façon dont l’intergiciel détermine si une réponse peut être mise en cache, consultez [conditions de mise en cache](#conditions-for-caching) .</span><span class="sxs-lookup"><span data-stu-id="ca950-231">See [Conditions for caching](#conditions-for-caching) for details on how the middleware determines if a response is cacheable.</span></span>

## <a name="options"></a><span data-ttu-id="ca950-232">Options</span><span class="sxs-lookup"><span data-stu-id="ca950-232">Options</span></span>

<span data-ttu-id="ca950-233">Les options de mise en cache des réponses sont indiquées dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="ca950-233">Response caching options are shown in the following table.</span></span>

| <span data-ttu-id="ca950-234">Option</span><span class="sxs-lookup"><span data-stu-id="ca950-234">Option</span></span> | <span data-ttu-id="ca950-235">Description</span><span class="sxs-lookup"><span data-stu-id="ca950-235">Description</span></span> |
| ------ | ----------- |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize> | <span data-ttu-id="ca950-236">Plus grande taille pouvant être mise en cache pour le corps de la réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-236">The largest cacheable size for the response body in bytes.</span></span> <span data-ttu-id="ca950-237">La valeur par défaut est `64 * 1024 * 1024` (64 Mo).</span><span class="sxs-lookup"><span data-stu-id="ca950-237">The default value is `64 * 1024 * 1024` (64 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit> | <span data-ttu-id="ca950-238">Taille limite de l’intergiciel (middleware) du cache de réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-238">The size limit for the response cache middleware in bytes.</span></span> <span data-ttu-id="ca950-239">La valeur par défaut est `100 * 1024 * 1024` (100 Mo).</span><span class="sxs-lookup"><span data-stu-id="ca950-239">The default value is `100 * 1024 * 1024` (100 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.UseCaseSensitivePaths> | <span data-ttu-id="ca950-240">Détermine si les réponses sont mises en cache sur les chemins d’accès sensibles à la casse.</span><span class="sxs-lookup"><span data-stu-id="ca950-240">Determines if responses are cached on case-sensitive paths.</span></span> <span data-ttu-id="ca950-241">La valeur par défaut est `false`.</span><span class="sxs-lookup"><span data-stu-id="ca950-241">The default value is `false`.</span></span> |

<span data-ttu-id="ca950-242">L’exemple suivant configure l’intergiciel (middleware) sur :</span><span class="sxs-lookup"><span data-stu-id="ca950-242">The following example configures the middleware to:</span></span>

* <span data-ttu-id="ca950-243">Met en cache les réponses dont la taille du corps est inférieure ou égale à 1 024 octets.</span><span class="sxs-lookup"><span data-stu-id="ca950-243">Cache responses with a body size smaller than or equal to 1,024 bytes.</span></span>
* <span data-ttu-id="ca950-244">Stockez les réponses en respectant les chemins sensibles à la casse.</span><span class="sxs-lookup"><span data-stu-id="ca950-244">Store the responses by case-sensitive paths.</span></span> <span data-ttu-id="ca950-245">Par exemple, `/page1` et `/Page1` sont stockés séparément.</span><span class="sxs-lookup"><span data-stu-id="ca950-245">For example, `/page1` and `/Page1` are stored separately.</span></span>

```csharp
services.AddResponseCaching(options =>
{
    options.MaximumBodySize = 1024;
    options.UseCaseSensitivePaths = true;
});
```

## <a name="varybyquerykeys"></a><span data-ttu-id="ca950-246">VaryByQueryKeys</span><span class="sxs-lookup"><span data-stu-id="ca950-246">VaryByQueryKeys</span></span>

<span data-ttu-id="ca950-247">Lorsque vous utilisez des contrôleurs d’API Web ou des contrôleurs d’API MVC/Web ou Razor Pages modèles de page, l’attribut [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) spécifie les paramètres nécessaires pour définir les en-têtes appropriés pour la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-247">When using MVC / web API controllers or Razor Pages page models, the [`[ResponseCache]`](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute specifies the parameters necessary for setting the appropriate headers for response caching.</span></span> <span data-ttu-id="ca950-248">Le seul paramètre de l’attribut `[ResponseCache]` qui requiert strictement l’intergiciel est <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, qui ne correspond pas à un en-tête HTTP réel.</span><span class="sxs-lookup"><span data-stu-id="ca950-248">The only parameter of the `[ResponseCache]` attribute that strictly requires the middleware is <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, which doesn't correspond to an actual HTTP header.</span></span> <span data-ttu-id="ca950-249">Pour plus d’informations, consultez <xref:performance/caching/response#responsecache-attribute>.</span><span class="sxs-lookup"><span data-stu-id="ca950-249">For more information, see <xref:performance/caching/response#responsecache-attribute>.</span></span>

<span data-ttu-id="ca950-250">Quand vous n’utilisez pas l’attribut `[ResponseCache]`, la mise en cache des réponses peut être modifiée avec `VaryByQueryKeys`.</span><span class="sxs-lookup"><span data-stu-id="ca950-250">When not using the `[ResponseCache]` attribute, response caching can be varied with `VaryByQueryKeys`.</span></span> <span data-ttu-id="ca950-251">Utilisez le <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directement à partir de [HttpContext. Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span><span class="sxs-lookup"><span data-stu-id="ca950-251">Use the <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directly from the [HttpContext.Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span></span>

```csharp
var responseCachingFeature = context.HttpContext.Features.Get<IResponseCachingFeature>();

if (responseCachingFeature != null)
{
    responseCachingFeature.VaryByQueryKeys = new[] { "MyKey" };
}
```

<span data-ttu-id="ca950-252">L’utilisation d’une valeur unique égale à `*` dans `VaryByQueryKeys` fait varier le cache par tous les paramètres de requête de demande.</span><span class="sxs-lookup"><span data-stu-id="ca950-252">Using a single value equal to `*` in `VaryByQueryKeys` varies the cache by all request query parameters.</span></span>

## <a name="http-headers-used-by-response-caching-middleware"></a><span data-ttu-id="ca950-253">En-têtes HTTP utilisés par l’intergiciel (middleware) de mise en cache des réponses</span><span class="sxs-lookup"><span data-stu-id="ca950-253">HTTP headers used by Response Caching Middleware</span></span>

<span data-ttu-id="ca950-254">Le tableau suivant fournit des informations sur les en-têtes HTTP qui affectent la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="ca950-254">The following table provides information on HTTP headers that affect response caching.</span></span>

| <span data-ttu-id="ca950-255">En-tête</span><span class="sxs-lookup"><span data-stu-id="ca950-255">Header</span></span> | <span data-ttu-id="ca950-256">Détails</span><span class="sxs-lookup"><span data-stu-id="ca950-256">Details</span></span> |
| ------ | ------- |
| `Authorization` | <span data-ttu-id="ca950-257">La réponse n’est pas mise en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="ca950-257">The response isn't cached if the header exists.</span></span> |
| `Cache-Control` | <span data-ttu-id="ca950-258">L’intergiciel prend uniquement en compte les réponses de mise en cache marquées avec la directive de cache `public`.</span><span class="sxs-lookup"><span data-stu-id="ca950-258">The middleware only considers caching responses marked with the `public` cache directive.</span></span> <span data-ttu-id="ca950-259">Contrôlez la mise en cache avec les paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="ca950-259">Control caching with the following parameters:</span></span><ul><li><span data-ttu-id="ca950-260">âge maximal</span><span class="sxs-lookup"><span data-stu-id="ca950-260">max-age</span></span></li><li><span data-ttu-id="ca950-261">Max-obsolète&#8224;</span><span class="sxs-lookup"><span data-stu-id="ca950-261">max-stale&#8224;</span></span></li><li><span data-ttu-id="ca950-262">min-frais</span><span class="sxs-lookup"><span data-stu-id="ca950-262">min-fresh</span></span></li><li><span data-ttu-id="ca950-263">must-revalidate</span><span class="sxs-lookup"><span data-stu-id="ca950-263">must-revalidate</span></span></li><li><span data-ttu-id="ca950-264">no-cache</span><span class="sxs-lookup"><span data-stu-id="ca950-264">no-cache</span></span></li><li><span data-ttu-id="ca950-265">non-Store</span><span class="sxs-lookup"><span data-stu-id="ca950-265">no-store</span></span></li><li><span data-ttu-id="ca950-266">uniquement-en cas de mise en cache</span><span class="sxs-lookup"><span data-stu-id="ca950-266">only-if-cached</span></span></li><li><span data-ttu-id="ca950-267">private</span><span class="sxs-lookup"><span data-stu-id="ca950-267">private</span></span></li><li><span data-ttu-id="ca950-268">public</span><span class="sxs-lookup"><span data-stu-id="ca950-268">public</span></span></li><li><span data-ttu-id="ca950-269">s-maxage</span><span class="sxs-lookup"><span data-stu-id="ca950-269">s-maxage</span></span></li><li><span data-ttu-id="ca950-270">proxy-revalidate&#8225;</span><span class="sxs-lookup"><span data-stu-id="ca950-270">proxy-revalidate&#8225;</span></span></li></ul><span data-ttu-id="ca950-271">&#8224;Si aucune limite n’est spécifiée pour `max-stale`, l’intergiciel n’entreprend aucune action.</span><span class="sxs-lookup"><span data-stu-id="ca950-271">&#8224;If no limit is specified to `max-stale`, the middleware takes no action.</span></span><br><span data-ttu-id="ca950-272">&#8225;`proxy-revalidate` a le même effet que `must-revalidate`.</span><span class="sxs-lookup"><span data-stu-id="ca950-272">&#8225;`proxy-revalidate` has the same effect as `must-revalidate`.</span></span><br><br><span data-ttu-id="ca950-273">Pour plus d’informations, consultez [RFC 7231 : Request Cache-Control directives](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span><span class="sxs-lookup"><span data-stu-id="ca950-273">For more information, see [RFC 7231: Request Cache-Control Directives](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span></span> |
| `Pragma` | <span data-ttu-id="ca950-274">Un en-tête de `Pragma: no-cache` dans la demande produit le même effet que `Cache-Control: no-cache`.</span><span class="sxs-lookup"><span data-stu-id="ca950-274">A `Pragma: no-cache` header in the request produces the same effect as `Cache-Control: no-cache`.</span></span> <span data-ttu-id="ca950-275">Cet en-tête est substitué par les directives pertinentes dans l’en-tête `Cache-Control`, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="ca950-275">This header is overridden by the relevant directives in the `Cache-Control` header, if present.</span></span> <span data-ttu-id="ca950-276">Pris en compte pour la compatibilité descendante avec HTTP/1.0.</span><span class="sxs-lookup"><span data-stu-id="ca950-276">Considered for backward compatibility with HTTP/1.0.</span></span> |
| `Set-Cookie` | <span data-ttu-id="ca950-277">La réponse n’est pas mise en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="ca950-277">The response isn't cached if the header exists.</span></span> <span data-ttu-id="ca950-278">Tout intergiciel dans le pipeline de traitement des demandes qui définit un ou plusieurs cookies empêche l’intergiciel (middleware) de mise en cache des réponses de mettre en cache la réponse (par exemple, le [fournisseur TempData basé sur les cookies](xref:fundamentals/app-state#tempdata)).</span><span class="sxs-lookup"><span data-stu-id="ca950-278">Any middleware in the request processing pipeline that sets one or more cookies prevents the Response Caching Middleware from caching the response (for example, the [cookie-based TempData provider](xref:fundamentals/app-state#tempdata)).</span></span>  |
| `Vary` | <span data-ttu-id="ca950-279">L’en-tête `Vary` est utilisé pour faire varier la réponse mise en cache par un autre en-tête.</span><span class="sxs-lookup"><span data-stu-id="ca950-279">The `Vary` header is used to vary the cached response by another header.</span></span> <span data-ttu-id="ca950-280">Par exemple, mettez en cache les réponses par encodage en incluant l’en-tête `Vary: Accept-Encoding`, qui met en cache les réponses pour les demandes avec des en-têtes `Accept-Encoding: gzip` et `Accept-Encoding: text/plain` séparément.</span><span class="sxs-lookup"><span data-stu-id="ca950-280">For example, cache responses by encoding by including the `Vary: Accept-Encoding` header, which caches responses for requests with headers `Accept-Encoding: gzip` and `Accept-Encoding: text/plain` separately.</span></span> <span data-ttu-id="ca950-281">Une réponse avec une valeur d’en-tête de `*` n’est jamais stockée.</span><span class="sxs-lookup"><span data-stu-id="ca950-281">A response with a header value of `*` is never stored.</span></span> |
| `Expires` | <span data-ttu-id="ca950-282">Une réponse considérée comme périmée par cet en-tête n’est pas stockée ou récupérée, sauf si elle est remplacée par d’autres en-têtes de `Cache-Control`.</span><span class="sxs-lookup"><span data-stu-id="ca950-282">A response deemed stale by this header isn't stored or retrieved unless overridden by other `Cache-Control` headers.</span></span> |
| `If-None-Match` | <span data-ttu-id="ca950-283">La réponse complète est traitée à partir du cache si la valeur n’est pas `*` et que la `ETag` de la réponse ne correspond à aucune des valeurs fournies.</span><span class="sxs-lookup"><span data-stu-id="ca950-283">The full response is served from cache if the value isn't `*` and the `ETag` of the response doesn't match any of the values provided.</span></span> <span data-ttu-id="ca950-284">Dans le cas contraire, une réponse 304 (non modifiée) est traitée.</span><span class="sxs-lookup"><span data-stu-id="ca950-284">Otherwise, a 304 (Not Modified) response is served.</span></span> |
| `If-Modified-Since` | <span data-ttu-id="ca950-285">Si l’en-tête `If-None-Match` n’est pas présent, une réponse complète est traitée à partir du cache si la date de réponse mise en cache est plus récente que la valeur fournie.</span><span class="sxs-lookup"><span data-stu-id="ca950-285">If the `If-None-Match` header isn't present, a full response is served from cache if the cached response date is newer than the value provided.</span></span> <span data-ttu-id="ca950-286">Dans le cas contraire, une réponse *304-non modifiée* est traitée.</span><span class="sxs-lookup"><span data-stu-id="ca950-286">Otherwise, a *304 - Not Modified* response is served.</span></span> |
| `Date` | <span data-ttu-id="ca950-287">En cas de service à partir du cache, l’en-tête `Date` est défini par l’intergiciel (middleware) s’il n’a pas été fourni dans la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-287">When serving from cache, the `Date` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Content-Length` | <span data-ttu-id="ca950-288">En cas de service à partir du cache, l’en-tête `Content-Length` est défini par l’intergiciel (middleware) s’il n’a pas été fourni dans la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="ca950-288">When serving from cache, the `Content-Length` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Age` | <span data-ttu-id="ca950-289">L’en-tête `Age` envoyé dans la réponse d’origine est ignoré.</span><span class="sxs-lookup"><span data-stu-id="ca950-289">The `Age` header sent in the original response is ignored.</span></span> <span data-ttu-id="ca950-290">L’intergiciel (middleware) calcule une nouvelle valeur lors de la fourniture d’une réponse mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-290">The middleware computes a new value when serving a cached response.</span></span> |

## <a name="caching-respects-request-cache-control-directives"></a><span data-ttu-id="ca950-291">Mise en cache respecte les directives de contrôle de cache de demande</span><span class="sxs-lookup"><span data-stu-id="ca950-291">Caching respects request Cache-Control directives</span></span>

<span data-ttu-id="ca950-292">L’intergiciel respecte les règles de la [spécification de mise en cache HTTP 1,1](https://tools.ietf.org/html/rfc7234#section-5.2).</span><span class="sxs-lookup"><span data-stu-id="ca950-292">The middleware respects the rules of the [HTTP 1.1 Caching specification](https://tools.ietf.org/html/rfc7234#section-5.2).</span></span> <span data-ttu-id="ca950-293">Les règles requièrent un cache pour honorer un en-tête de `Cache-Control` valide envoyé par le client.</span><span class="sxs-lookup"><span data-stu-id="ca950-293">The rules require a cache to honor a valid `Cache-Control` header sent by the client.</span></span> <span data-ttu-id="ca950-294">Dans le cadre de la spécification, un client peut faire des demandes avec une valeur d’en-tête `no-cache` et forcer le serveur à générer une nouvelle réponse pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="ca950-294">Under the specification, a client can make requests with a `no-cache` header value and force the server to generate a new response for every request.</span></span> <span data-ttu-id="ca950-295">Actuellement, il n’y a pas de contrôle du développeur sur ce comportement de mise en cache lors de l’utilisation de l’intergiciel (middleware), car l’intergiciel respecte la spécification officielle de mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-295">Currently, there's no developer control over this caching behavior when using the middleware because the middleware adheres to the official caching specification.</span></span>

<span data-ttu-id="ca950-296">Pour plus de contrôle sur le comportement de mise en cache, explorez les autres fonctionnalités de mise en cache de ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="ca950-296">For more control over caching behavior, explore other caching features of ASP.NET Core.</span></span> <span data-ttu-id="ca950-297">Consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="ca950-297">See the following topics:</span></span>

* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

## <a name="troubleshooting"></a><span data-ttu-id="ca950-298">Dépannage</span><span class="sxs-lookup"><span data-stu-id="ca950-298">Troubleshooting</span></span>

<span data-ttu-id="ca950-299">Si le comportement de mise en cache n’est pas le même que prévu, vérifiez que les réponses sont mises en cache et peuvent être servies à partir du cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-299">If caching behavior isn't as expected, confirm that responses are cacheable and capable of being served from the cache.</span></span> <span data-ttu-id="ca950-300">Examinez les en-têtes entrants de la demande et les en-têtes sortants de la réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-300">Examine the request's incoming headers and the response's outgoing headers.</span></span> <span data-ttu-id="ca950-301">Activez la [journalisation](xref:fundamentals/logging/index) pour faciliter le débogage.</span><span class="sxs-lookup"><span data-stu-id="ca950-301">Enable [logging](xref:fundamentals/logging/index) to help with debugging.</span></span>

<span data-ttu-id="ca950-302">Lors du test et du dépannage du comportement de mise en cache, un navigateur peut définir des en-têtes de demande qui affectent la mise en cache de façon indésirable.</span><span class="sxs-lookup"><span data-stu-id="ca950-302">When testing and troubleshooting caching behavior, a browser may set request headers that affect caching in undesirable ways.</span></span> <span data-ttu-id="ca950-303">Par exemple, un navigateur peut définir l’en-tête `Cache-Control` sur `no-cache` ou `max-age=0` lors de l’actualisation d’une page.</span><span class="sxs-lookup"><span data-stu-id="ca950-303">For example, a browser may set the `Cache-Control` header to `no-cache` or `max-age=0` when refreshing a page.</span></span> <span data-ttu-id="ca950-304">Les outils suivants peuvent définir explicitement des en-têtes de demande et sont préférés pour le test de mise en cache :</span><span class="sxs-lookup"><span data-stu-id="ca950-304">The following tools can explicitly set request headers and are preferred for testing caching:</span></span>

* [<span data-ttu-id="ca950-305">Fiddler</span><span class="sxs-lookup"><span data-stu-id="ca950-305">Fiddler</span></span>](https://www.telerik.com/fiddler)
* [<span data-ttu-id="ca950-306">Postman</span><span class="sxs-lookup"><span data-stu-id="ca950-306">Postman</span></span>](https://www.getpostman.com/)

### <a name="conditions-for-caching"></a><span data-ttu-id="ca950-307">Conditions de mise en cache</span><span class="sxs-lookup"><span data-stu-id="ca950-307">Conditions for caching</span></span>

* <span data-ttu-id="ca950-308">La demande doit aboutir à une réponse du serveur avec un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="ca950-308">The request must result in a server response with a 200 (OK) status code.</span></span>
* <span data-ttu-id="ca950-309">La méthode de demande doit être obtenir ou HEAD.</span><span class="sxs-lookup"><span data-stu-id="ca950-309">The request method must be GET or HEAD.</span></span>
* <span data-ttu-id="ca950-310">Dans `Startup.Configure`, l’intergiciel (middleware) de mise en cache des réponses doit être placé avant l’intergiciel (middleware) qui requiert la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-310">In `Startup.Configure`, Response Caching Middleware must be placed before middleware that require caching.</span></span> <span data-ttu-id="ca950-311">Pour plus d’informations, consultez <xref:fundamentals/middleware/index>.</span><span class="sxs-lookup"><span data-stu-id="ca950-311">For more information, see <xref:fundamentals/middleware/index>.</span></span>
* <span data-ttu-id="ca950-312">L’en-tête `Authorization` ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-312">The `Authorization` header must not be present.</span></span>
* <span data-ttu-id="ca950-313">`Cache-Control` paramètres d’en-tête doivent être valides, et la réponse doit être marquée `public` et non marquée `private`.</span><span class="sxs-lookup"><span data-stu-id="ca950-313">`Cache-Control` header parameters must be valid, and the response must be marked `public` and not marked `private`.</span></span>
* <span data-ttu-id="ca950-314">L’en-tête `Pragma: no-cache` ne doit pas être présent si l’en-tête `Cache-Control` n’est pas présent, car l’en-tête `Cache-Control` remplace l’en-tête `Pragma` lorsqu’il est présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-314">The `Pragma: no-cache` header must not be present if the `Cache-Control` header isn't present, as the `Cache-Control` header overrides the `Pragma` header when present.</span></span>
* <span data-ttu-id="ca950-315">L’en-tête `Set-Cookie` ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="ca950-315">The `Set-Cookie` header must not be present.</span></span>
* <span data-ttu-id="ca950-316">`Vary` paramètres d’en-tête doivent être valides et non égaux à `*`.</span><span class="sxs-lookup"><span data-stu-id="ca950-316">`Vary` header parameters must be valid and not equal to `*`.</span></span>
* <span data-ttu-id="ca950-317">La valeur d’en-tête `Content-Length` (si elle est définie) doit correspondre à la taille du corps de la réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-317">The `Content-Length` header value (if set) must match the size of the response body.</span></span>
* <span data-ttu-id="ca950-318">Le <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> n’est pas utilisé.</span><span class="sxs-lookup"><span data-stu-id="ca950-318">The <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> isn't used.</span></span>
* <span data-ttu-id="ca950-319">La réponse ne doit pas être périmée comme spécifié par l’en-tête `Expires` et les directives de cache `max-age` et `s-maxage`.</span><span class="sxs-lookup"><span data-stu-id="ca950-319">The response must not be stale as specified by the `Expires` header and the `max-age` and `s-maxage` cache directives.</span></span>
* <span data-ttu-id="ca950-320">La mise en mémoire tampon des réponses doit réussir.</span><span class="sxs-lookup"><span data-stu-id="ca950-320">Response buffering must be successful.</span></span> <span data-ttu-id="ca950-321">La taille de la réponse doit être inférieure à la <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>configurée ou par défaut.</span><span class="sxs-lookup"><span data-stu-id="ca950-321">The size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>.</span></span> <span data-ttu-id="ca950-322">La taille du corps de la réponse doit être inférieure à la <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>configurée ou par défaut.</span><span class="sxs-lookup"><span data-stu-id="ca950-322">The body size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>.</span></span>
* <span data-ttu-id="ca950-323">La réponse doit être mise en cache conformément aux spécifications de la [norme RFC 7234](https://tools.ietf.org/html/rfc7234) .</span><span class="sxs-lookup"><span data-stu-id="ca950-323">The response must be cacheable according to the [RFC 7234](https://tools.ietf.org/html/rfc7234) specifications.</span></span> <span data-ttu-id="ca950-324">Par exemple, la directive `no-store` ne doit pas exister dans les champs d’en-tête de demande ou de réponse.</span><span class="sxs-lookup"><span data-stu-id="ca950-324">For example, the `no-store` directive must not exist in request or response header fields.</span></span> <span data-ttu-id="ca950-325">Pour plus d’informations, consultez la *section 3 : stockage des réponses dans les caches* de [RFC 7234](https://tools.ietf.org/html/rfc7234) .</span><span class="sxs-lookup"><span data-stu-id="ca950-325">See *Section 3: Storing Responses in Caches* of [RFC 7234](https://tools.ietf.org/html/rfc7234) for details.</span></span>

> [!NOTE]
> <span data-ttu-id="ca950-326">Le système anti-contrefaçon pour générer des jetons sécurisés pour empêcher les attaques par falsification de requête intersites (CSRF) définit les en-têtes `Cache-Control` et `Pragma` sur `no-cache` afin que les réponses ne soient pas mises en cache.</span><span class="sxs-lookup"><span data-stu-id="ca950-326">The Antiforgery system for generating secure tokens to prevent Cross-Site Request Forgery (CSRF) attacks sets the `Cache-Control` and `Pragma` headers to `no-cache` so that responses aren't cached.</span></span> <span data-ttu-id="ca950-327">Pour plus d’informations sur la façon de désactiver des jetons anti-contrefaçon pour les éléments de formulaire HTML, consultez <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span><span class="sxs-lookup"><span data-stu-id="ca950-327">For information on how to disable antiforgery tokens for HTML form elements, see <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="ca950-328">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="ca950-328">Additional resources</span></span>

* <xref:fundamentals/startup>
* <xref:fundamentals/middleware/index>
* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end
