---
title: Réponse mise en cache d’intergiciel (middleware) dans ASP.NET Core
author: guardrex
description: Découvrez comment configurer et utiliser le middleware de mise en cache des réponses dans ASP.NET Core.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 07/05/2019
uid: performance/caching/middleware
ms.openlocfilehash: d6756ce16396133da643cc08ca0f48369479ad3a
ms.sourcegitcommit: b9e914ef274b5ec359582f299724af6234dce135
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/05/2019
ms.locfileid: "67596150"
---
# <a name="response-caching-middleware-in-aspnet-core"></a><span data-ttu-id="a42fc-103">Réponse mise en cache d’intergiciel (middleware) dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="a42fc-103">Response Caching Middleware in ASP.NET Core</span></span>

<span data-ttu-id="a42fc-104">Par [Luke Latham](https://github.com/guardrex) et [John Luo](https://github.com/JunTaoLuo)</span><span class="sxs-lookup"><span data-stu-id="a42fc-104">By [Luke Latham](https://github.com/guardrex) and [John Luo](https://github.com/JunTaoLuo)</span></span>

<span data-ttu-id="a42fc-105">[Affichez ou téléchargez l’exemple de code](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="a42fc-105">[View or download sample code](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/middleware/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

<span data-ttu-id="a42fc-106">Cet article explique comment configurer l’intergiciel de mise en cache des réponses dans une application ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a42fc-106">This article explains how to configure Response Caching Middleware in an ASP.NET Core app.</span></span> <span data-ttu-id="a42fc-107">L’intergiciel (middleware) détermine lorsque les réponses sont mis en cache, les magasins de réponses et les réponses sert à partir du cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-107">The middleware determines when responses are cacheable, stores responses, and serves responses from cache.</span></span> <span data-ttu-id="a42fc-108">Pour une introduction à la mise en cache HTTP et le [[ResponseCache]](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) d’attribut, consultez [la mise en cache de réponse](xref:performance/caching/response).</span><span class="sxs-lookup"><span data-stu-id="a42fc-108">For an introduction to HTTP caching and the [[ResponseCache]](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute, see [Response Caching](xref:performance/caching/response).</span></span>

## <a name="configuration"></a><span data-ttu-id="a42fc-109">Configuration</span><span class="sxs-lookup"><span data-stu-id="a42fc-109">Configuration</span></span>

<span data-ttu-id="a42fc-110">Utilisez le [Microsoft.AspNetCore.App métapackage](xref:fundamentals/metapackage-app) ou ajouter une référence de package à la [Microsoft.AspNetCore.ResponseCaching](https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/) package.</span><span class="sxs-lookup"><span data-stu-id="a42fc-110">Use the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app) or add a package reference to the [Microsoft.AspNetCore.ResponseCaching](https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/) package.</span></span>

<span data-ttu-id="a42fc-111">Dans `Startup.ConfigureServices`, ajoutez l’intergiciel de mise en cache de réponse à la collection de service :</span><span class="sxs-lookup"><span data-stu-id="a42fc-111">In `Startup.ConfigureServices`, add the Response Caching Middleware to the service collection:</span></span>

[!code-csharp[](middleware/samples/2.x/ResponseCachingMiddleware/Startup.cs?name=snippet1&highlight=3)]

<span data-ttu-id="a42fc-112">Configurer l’application pour utiliser l’intergiciel (middleware) avec la <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*> méthode d’extension, qui ajoute l’intergiciel (middleware) au pipeline de traitement de demande dans `Startup.Configure`:</span><span class="sxs-lookup"><span data-stu-id="a42fc-112">Configure the app to use the middleware with the <xref:Microsoft.AspNetCore.Builder.ResponseCachingExtensions.UseResponseCaching*> extension method, which adds the middleware to the request processing pipeline in `Startup.Configure`:</span></span>

[!code-csharp[](middleware/samples/2.x/ResponseCachingMiddleware/Startup.cs?name=snippet2&highlight=14)]

<span data-ttu-id="a42fc-113">L’exemple d’application ajoute des en-têtes pour contrôler la mise en cache sur les demandes suivantes :</span><span class="sxs-lookup"><span data-stu-id="a42fc-113">The sample app adds headers to control caching on subsequent requests:</span></span>

* <span data-ttu-id="a42fc-114">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; met en cache des réponses d’être mis en cache pendant 10 secondes.</span><span class="sxs-lookup"><span data-stu-id="a42fc-114">[Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2) &ndash; Caches cacheable responses for up to 10 seconds.</span></span>
* <span data-ttu-id="a42fc-115">[Varier](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; configure l’intergiciel (middleware) pour répondre à un réponse mise en cache uniquement si le [ `Accept-Encoding` ](https://tools.ietf.org/html/rfc7231#section-5.3.4) en-tête des demandes suivantes correspondent à ceux de la demande d’origine.</span><span class="sxs-lookup"><span data-stu-id="a42fc-115">[Vary](https://tools.ietf.org/html/rfc7231#section-7.1.4) &ndash; Configures the middleware to serve a cached response only if the [`Accept-Encoding`](https://tools.ietf.org/html/rfc7231#section-5.3.4) header of subsequent requests matches that of the original request.</span></span>

[!code-csharp[](middleware/samples_snippets/2.x/AddHeaders.cs)]

<span data-ttu-id="a42fc-116">Intergiciel de mise en cache des réponses met uniquement en cache les réponses du serveur qui entraînent un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="a42fc-116">Response Caching Middleware only caches server responses that result in a 200 (OK) status code.</span></span> <span data-ttu-id="a42fc-117">Autres réponses, y compris [pages d’erreurs](xref:fundamentals/error-handling), sont ignorés par l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="a42fc-117">Any other responses, including [error pages](xref:fundamentals/error-handling), are ignored by the middleware.</span></span>

> [!WARNING]
> <span data-ttu-id="a42fc-118">Réponses contenant le contenu pour les clients authentifiés doivent être marqués comme non mis en cache pour empêcher l’intergiciel (middleware) à partir de stockage et traitement des ces réponses.</span><span class="sxs-lookup"><span data-stu-id="a42fc-118">Responses containing content for authenticated clients must be marked as not cacheable to prevent the middleware from storing and serving those responses.</span></span> <span data-ttu-id="a42fc-119">Consultez [Conditions pour la mise en cache](#conditions-for-caching) pour plus d’informations sur la façon dont l’intergiciel (middleware) détermine si une réponse est mis en cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-119">See [Conditions for caching](#conditions-for-caching) for details on how the middleware determines if a response is cacheable.</span></span>

## <a name="options"></a><span data-ttu-id="a42fc-120">Options</span><span class="sxs-lookup"><span data-stu-id="a42fc-120">Options</span></span>

<span data-ttu-id="a42fc-121">Options de mise en cache de réponse sont affichées dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="a42fc-121">Response caching options are shown in the following table.</span></span>

| <span data-ttu-id="a42fc-122">Option</span><span class="sxs-lookup"><span data-stu-id="a42fc-122">Option</span></span> | <span data-ttu-id="a42fc-123">Description</span><span class="sxs-lookup"><span data-stu-id="a42fc-123">Description</span></span> |
| ------ | ----------- |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize> | <span data-ttu-id="a42fc-124">La plus grande taille mis en cache pour le corps de réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="a42fc-124">The largest cacheable size for the response body in bytes.</span></span> <span data-ttu-id="a42fc-125">La valeur par défaut est `64 * 1024 * 1024` (64 Mo).</span><span class="sxs-lookup"><span data-stu-id="a42fc-125">The default value is `64 * 1024 * 1024` (64 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit> | <span data-ttu-id="a42fc-126">La limite de taille de l’intergiciel de cache de réponse en octets.</span><span class="sxs-lookup"><span data-stu-id="a42fc-126">The size limit for the response cache middleware in bytes.</span></span> <span data-ttu-id="a42fc-127">La valeur par défaut est `100 * 1024 * 1024` (100 Mo).</span><span class="sxs-lookup"><span data-stu-id="a42fc-127">The default value is `100 * 1024 * 1024` (100 MB).</span></span> |
| <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.UseCaseSensitivePaths> | <span data-ttu-id="a42fc-128">Détermine si les réponses sont mises en cache sur les chemins d’accès de la casse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-128">Determines if responses are cached on case-sensitive paths.</span></span> <span data-ttu-id="a42fc-129">La valeur par défaut est `false`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-129">The default value is `false`.</span></span> |

<span data-ttu-id="a42fc-130">L’exemple suivant configure l’intergiciel (middleware) pour :</span><span class="sxs-lookup"><span data-stu-id="a42fc-130">The following example configures the middleware to:</span></span>

* <span data-ttu-id="a42fc-131">Cache des réponses avec une taille de corps inférieure ou égale à 1 024 octets.</span><span class="sxs-lookup"><span data-stu-id="a42fc-131">Cache responses with a body size smaller than or equal to 1,024 bytes.</span></span>
* <span data-ttu-id="a42fc-132">Store les réponses par les chemins d’accès de la casse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-132">Store the responses by case-sensitive paths.</span></span> <span data-ttu-id="a42fc-133">Par exemple, `/page1` et `/Page1` sont stockées séparément.</span><span class="sxs-lookup"><span data-stu-id="a42fc-133">For example, `/page1` and `/Page1` are stored separately.</span></span>

```csharp
services.AddResponseCaching(options =>
{
    options.MaximumBodySize = 1024;
    options.UseCaseSensitivePaths = true;
});
```

## <a name="varybyquerykeys"></a><span data-ttu-id="a42fc-134">VaryByQueryKeys</span><span class="sxs-lookup"><span data-stu-id="a42fc-134">VaryByQueryKeys</span></span>

<span data-ttu-id="a42fc-135">Lorsque vous utilisez MVC / web contrôleurs d’API ou des modèles de page Pages Razor, le [[ResponseCache]](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribut spécifie les paramètres nécessaires pour définir les en-têtes appropriés pour la mise en cache de réponse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-135">When using MVC / web API controllers or Razor Pages page models, the [[ResponseCache]](xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute) attribute specifies the parameters necessary for setting the appropriate headers for response caching.</span></span> <span data-ttu-id="a42fc-136">Le seul paramètre de la `[ResponseCache]` attribut nécessitant strictement l’intergiciel (middleware) est <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, qui ne correspond pas à un en-tête HTTP réelle.</span><span class="sxs-lookup"><span data-stu-id="a42fc-136">The only parameter of the `[ResponseCache]` attribute that strictly requires the middleware is <xref:Microsoft.AspNetCore.Mvc.ResponseCacheAttribute.VaryByQueryKeys>, which doesn't correspond to an actual HTTP header.</span></span> <span data-ttu-id="a42fc-137">Pour plus d'informations, consultez <xref:performance/caching/response#responsecache-attribute>.</span><span class="sxs-lookup"><span data-stu-id="a42fc-137">For more information, see <xref:performance/caching/response#responsecache-attribute>.</span></span>

<span data-ttu-id="a42fc-138">Lorsque vous N'utilisez pas le `[ResponseCache]` attribut, la mise en cache de réponse peut être modifiée avec `VaryByQueryKeys`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-138">When not using the `[ResponseCache]` attribute, response caching can be varied with `VaryByQueryKeys`.</span></span> <span data-ttu-id="a42fc-139">Utilisez le <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directement à partir de la [HttpContext.Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span><span class="sxs-lookup"><span data-stu-id="a42fc-139">Use the <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingFeature> directly from the [HttpContext.Features](xref:Microsoft.AspNetCore.Http.HttpContext.Features):</span></span>

```csharp
var responseCachingFeature = context.HttpContext.Features.Get<IResponseCachingFeature>();

if (responseCachingFeature != null)
{
    responseCachingFeature.VaryByQueryKeys = new[] { "MyKey" };
}
```

<span data-ttu-id="a42fc-140">En utilisant une seule valeur égale à `*` dans `VaryByQueryKeys` varie le cache par tous les paramètres de requête de demande.</span><span class="sxs-lookup"><span data-stu-id="a42fc-140">Using a single value equal to `*` in `VaryByQueryKeys` varies the cache by all request query parameters.</span></span>

## <a name="http-headers-used-by-response-caching-middleware"></a><span data-ttu-id="a42fc-141">En-têtes HTTP utilisés par l’intergiciel de mise en cache des réponses</span><span class="sxs-lookup"><span data-stu-id="a42fc-141">HTTP headers used by Response Caching Middleware</span></span>

<span data-ttu-id="a42fc-142">Le tableau suivant fournit des informations sur les en-têtes HTTP qui affectent la mise en cache de réponse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-142">The following table provides information on HTTP headers that affect response caching.</span></span>

| <span data-ttu-id="a42fc-143">Header</span><span class="sxs-lookup"><span data-stu-id="a42fc-143">Header</span></span> | <span data-ttu-id="a42fc-144">Détails</span><span class="sxs-lookup"><span data-stu-id="a42fc-144">Details</span></span> |
| ------ | ------- |
| `Authorization` | <span data-ttu-id="a42fc-145">La réponse n’est pas mis en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="a42fc-145">The response isn't cached if the header exists.</span></span> |
| `Cache-Control` | <span data-ttu-id="a42fc-146">Le middleware considère uniquement la mise en cache des réponses marquées avec la `public` directive de cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-146">The middleware only considers caching responses marked with the `public` cache directive.</span></span> <span data-ttu-id="a42fc-147">Contrôler la mise en cache avec les paramètres suivants :</span><span class="sxs-lookup"><span data-stu-id="a42fc-147">Control caching with the following parameters:</span></span><ul><li><span data-ttu-id="a42fc-148">max-age</span><span class="sxs-lookup"><span data-stu-id="a42fc-148">max-age</span></span></li><li><span data-ttu-id="a42fc-149">obsolescence maximale&#8224;</span><span class="sxs-lookup"><span data-stu-id="a42fc-149">max-stale&#8224;</span></span></li><li><span data-ttu-id="a42fc-150">frais de min</span><span class="sxs-lookup"><span data-stu-id="a42fc-150">min-fresh</span></span></li><li><span data-ttu-id="a42fc-151">doit-revalidate.</span><span class="sxs-lookup"><span data-stu-id="a42fc-151">must-revalidate</span></span></li><li><span data-ttu-id="a42fc-152">non-cache</span><span class="sxs-lookup"><span data-stu-id="a42fc-152">no-cache</span></span></li><li><span data-ttu-id="a42fc-153">non-store</span><span class="sxs-lookup"><span data-stu-id="a42fc-153">no-store</span></span></li><li><span data-ttu-id="a42fc-154">only-if-cached</span><span class="sxs-lookup"><span data-stu-id="a42fc-154">only-if-cached</span></span></li><li><span data-ttu-id="a42fc-155">private</span><span class="sxs-lookup"><span data-stu-id="a42fc-155">private</span></span></li><li><span data-ttu-id="a42fc-156">public</span><span class="sxs-lookup"><span data-stu-id="a42fc-156">public</span></span></li><li><span data-ttu-id="a42fc-157">s-maxage</span><span class="sxs-lookup"><span data-stu-id="a42fc-157">s-maxage</span></span></li><li><span data-ttu-id="a42fc-158">proxy-revalidate&#8225;</span><span class="sxs-lookup"><span data-stu-id="a42fc-158">proxy-revalidate&#8225;</span></span></li></ul><span data-ttu-id="a42fc-159">&#8224;Si aucune limite n’est spécifiée pour `max-stale`, l’intergiciel (middleware) n’effectue aucune action.</span><span class="sxs-lookup"><span data-stu-id="a42fc-159">&#8224;If no limit is specified to `max-stale`, the middleware takes no action.</span></span><br><span data-ttu-id="a42fc-160">&#8225;`proxy-revalidate`a le même effet que `must-revalidate`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-160">&#8225;`proxy-revalidate` has the same effect as `must-revalidate`.</span></span><br><br><span data-ttu-id="a42fc-161">Pour plus d’informations, consultez [7231 relative aux RFC : Demander des Directives de Cache-Control](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span><span class="sxs-lookup"><span data-stu-id="a42fc-161">For more information, see [RFC 7231: Request Cache-Control Directives](https://tools.ietf.org/html/rfc7234#section-5.2.1).</span></span> |
| `Pragma` | <span data-ttu-id="a42fc-162">Un `Pragma: no-cache` en-tête dans la requête produit le même effet que `Cache-Control: no-cache`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-162">A `Pragma: no-cache` header in the request produces the same effect as `Cache-Control: no-cache`.</span></span> <span data-ttu-id="a42fc-163">Cet en-tête est remplacé par les directives pertinentes dans le `Cache-Control` en-tête, le cas échéant.</span><span class="sxs-lookup"><span data-stu-id="a42fc-163">This header is overridden by the relevant directives in the `Cache-Control` header, if present.</span></span> <span data-ttu-id="a42fc-164">Considéré comme pour la compatibilité descendante avec HTTP/1.0.</span><span class="sxs-lookup"><span data-stu-id="a42fc-164">Considered for backward compatibility with HTTP/1.0.</span></span> |
| `Set-Cookie` | <span data-ttu-id="a42fc-165">La réponse n’est pas mis en cache si l’en-tête existe.</span><span class="sxs-lookup"><span data-stu-id="a42fc-165">The response isn't cached if the header exists.</span></span> <span data-ttu-id="a42fc-166">N’importe quel intergiciel (middleware) dans le pipeline de traitement de la requête qui définit un ou plusieurs cookies empêche l’intergiciel de mise en cache de réponse de la mise en cache la réponse (par exemple, le [fournisseur TempData basé sur cookie](xref:fundamentals/app-state#tempdata)).</span><span class="sxs-lookup"><span data-stu-id="a42fc-166">Any middleware in the request processing pipeline that sets one or more cookies prevents the Response Caching Middleware from caching the response (for example, the [cookie-based TempData provider](xref:fundamentals/app-state#tempdata)).</span></span>  |
| `Vary` | <span data-ttu-id="a42fc-167">Le `Vary` en-tête est utilisé pour faire varier la réponse mise en cache par un autre en-tête.</span><span class="sxs-lookup"><span data-stu-id="a42fc-167">The `Vary` header is used to vary the cached response by another header.</span></span> <span data-ttu-id="a42fc-168">Par exemple, mettre en cache les réponses par l’encodage en incluant le `Vary: Accept-Encoding` en-tête, qui met en cache des réponses aux requêtes avec des en-têtes `Accept-Encoding: gzip` et `Accept-Encoding: text/plain` séparément.</span><span class="sxs-lookup"><span data-stu-id="a42fc-168">For example, cache responses by encoding by including the `Vary: Accept-Encoding` header, which caches responses for requests with headers `Accept-Encoding: gzip` and `Accept-Encoding: text/plain` separately.</span></span> <span data-ttu-id="a42fc-169">Une réponse avec une valeur d’en-tête de `*` n’est jamais stocké.</span><span class="sxs-lookup"><span data-stu-id="a42fc-169">A response with a header value of `*` is never stored.</span></span> |
| `Expires` | <span data-ttu-id="a42fc-170">Une réponse jugée obsolète par cet en-tête n’est pas stockée ou récupérée sauf substitution par d’autres `Cache-Control` en-têtes.</span><span class="sxs-lookup"><span data-stu-id="a42fc-170">A response deemed stale by this header isn't stored or retrieved unless overridden by other `Cache-Control` headers.</span></span> |
| `If-None-Match` | <span data-ttu-id="a42fc-171">La réponse complète est pris en charge à partir du cache si la valeur n’est pas `*` et `ETag` de la réponse ne correspond à aucune des valeurs fournies.</span><span class="sxs-lookup"><span data-stu-id="a42fc-171">The full response is served from cache if the value isn't `*` and the `ETag` of the response doesn't match any of the values provided.</span></span> <span data-ttu-id="a42fc-172">Sinon, une réponse 304 (non modifié) est pris en charge.</span><span class="sxs-lookup"><span data-stu-id="a42fc-172">Otherwise, a 304 (Not Modified) response is served.</span></span> |
| `If-Modified-Since` | <span data-ttu-id="a42fc-173">Si le `If-None-Match` en-tête n’est pas présent, une réponse complète est traitée à partir du cache si la date de la réponse mise en cache est plus récente que la valeur fournie.</span><span class="sxs-lookup"><span data-stu-id="a42fc-173">If the `If-None-Match` header isn't present, a full response is served from cache if the cached response date is newer than the value provided.</span></span> <span data-ttu-id="a42fc-174">Sinon, un *304 - non modifié* réponse est traitée.</span><span class="sxs-lookup"><span data-stu-id="a42fc-174">Otherwise, a *304 - Not Modified* response is served.</span></span> |
| `Date` | <span data-ttu-id="a42fc-175">Lors du service de cache, le `Date` en-tête est défini par l’intergiciel (middleware) si elle n’a pas été fourni sur la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="a42fc-175">When serving from cache, the `Date` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Content-Length` | <span data-ttu-id="a42fc-176">Lors du service de cache, le `Content-Length` en-tête est défini par l’intergiciel (middleware) si elle n’a pas été fourni sur la réponse d’origine.</span><span class="sxs-lookup"><span data-stu-id="a42fc-176">When serving from cache, the `Content-Length` header is set by the middleware if it wasn't provided on the original response.</span></span> |
| `Age` | <span data-ttu-id="a42fc-177">Le `Age` en-tête envoyé dans la réponse d’origine est ignorée.</span><span class="sxs-lookup"><span data-stu-id="a42fc-177">The `Age` header sent in the original response is ignored.</span></span> <span data-ttu-id="a42fc-178">L’intergiciel (middleware) calcule une nouvelle valeur avec une réponse mise en cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-178">The middleware computes a new value when serving a cached response.</span></span> |

## <a name="caching-respects-request-cache-control-directives"></a><span data-ttu-id="a42fc-179">La mise en cache respecte les directives de contrôle de Cache de demande</span><span class="sxs-lookup"><span data-stu-id="a42fc-179">Caching respects request Cache-Control directives</span></span>

<span data-ttu-id="a42fc-180">L’intergiciel (middleware) respecte les règles de la [spécification HTTP 1.1 Caching](https://tools.ietf.org/html/rfc7234#section-5.2).</span><span class="sxs-lookup"><span data-stu-id="a42fc-180">The middleware respects the rules of the [HTTP 1.1 Caching specification](https://tools.ietf.org/html/rfc7234#section-5.2).</span></span> <span data-ttu-id="a42fc-181">Les règles requièrent un cache d’honorer valide `Cache-Control` en-tête envoyé par le client.</span><span class="sxs-lookup"><span data-stu-id="a42fc-181">The rules require a cache to honor a valid `Cache-Control` header sent by the client.</span></span> <span data-ttu-id="a42fc-182">Sous la spécification, un client peut envoyer des requêtes avec un `no-cache` valeur d’en-tête et force le serveur génère une nouvelle réponse pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="a42fc-182">Under the specification, a client can make requests with a `no-cache` header value and force the server to generate a new response for every request.</span></span> <span data-ttu-id="a42fc-183">Actuellement, il n’existe aucun contrôle du développeur sur ce comportement de mise en cache lors de l’utilisation de l’intergiciel (middleware), car l’intergiciel (middleware) conforme à la spécification de mise en cache officielle.</span><span class="sxs-lookup"><span data-stu-id="a42fc-183">Currently, there's no developer control over this caching behavior when using the middleware because the middleware adheres to the official caching specification.</span></span>

<span data-ttu-id="a42fc-184">Pour contrôler le comportement de mise en cache plus, explorez les autres fonctionnalités de mise en cache d’ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="a42fc-184">For more control over caching behavior, explore other caching features of ASP.NET Core.</span></span> <span data-ttu-id="a42fc-185">Consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="a42fc-185">See the following topics:</span></span>

* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

## <a name="troubleshooting"></a><span data-ttu-id="a42fc-186">Résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="a42fc-186">Troubleshooting</span></span>

<span data-ttu-id="a42fc-187">Si le comportement de mise en cache n’est pas comme prévu, vérifiez que les réponses sont mis en cache et capable de servies à partir du cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-187">If caching behavior isn't as expected, confirm that responses are cacheable and capable of being served from the cache.</span></span> <span data-ttu-id="a42fc-188">Examinez les en-têtes entrants de la demande et la réponse sortante.</span><span class="sxs-lookup"><span data-stu-id="a42fc-188">Examine the request's incoming headers and the response's outgoing headers.</span></span> <span data-ttu-id="a42fc-189">Activer [journalisation](xref:fundamentals/logging/index) pour faciliter le débogage.</span><span class="sxs-lookup"><span data-stu-id="a42fc-189">Enable [logging](xref:fundamentals/logging/index) to help with debugging.</span></span>

<span data-ttu-id="a42fc-190">Lorsque le test et résolution des problèmes de comportement de mise en cache, un navigateur peut définir des en-têtes de demande qui affectent la mise en cache de façon non souhaitée.</span><span class="sxs-lookup"><span data-stu-id="a42fc-190">When testing and troubleshooting caching behavior, a browser may set request headers that affect caching in undesirable ways.</span></span> <span data-ttu-id="a42fc-191">Par exemple, un navigateur peut-être définir le `Cache-Control` en-tête à `no-cache` ou `max-age=0` lors de l’actualisation d’une page.</span><span class="sxs-lookup"><span data-stu-id="a42fc-191">For example, a browser may set the `Cache-Control` header to `no-cache` or `max-age=0` when refreshing a page.</span></span> <span data-ttu-id="a42fc-192">Les outils suivants peuvent définir explicitement les en-têtes de demande et sont préférables pour tester la mise en cache :</span><span class="sxs-lookup"><span data-stu-id="a42fc-192">The following tools can explicitly set request headers and are preferred for testing caching:</span></span>

* [<span data-ttu-id="a42fc-193">Fiddler</span><span class="sxs-lookup"><span data-stu-id="a42fc-193">Fiddler</span></span>](https://www.telerik.com/fiddler)
* [<span data-ttu-id="a42fc-194">Postman</span><span class="sxs-lookup"><span data-stu-id="a42fc-194">Postman</span></span>](https://www.getpostman.com/)

### <a name="conditions-for-caching"></a><span data-ttu-id="a42fc-195">Conditions pour la mise en cache</span><span class="sxs-lookup"><span data-stu-id="a42fc-195">Conditions for caching</span></span>

* <span data-ttu-id="a42fc-196">La demande doit avoir pour résultat dans une réponse du serveur avec un code d’état 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="a42fc-196">The request must result in a server response with a 200 (OK) status code.</span></span>
* <span data-ttu-id="a42fc-197">La méthode de demande doit être GET ou HEAD.</span><span class="sxs-lookup"><span data-stu-id="a42fc-197">The request method must be GET or HEAD.</span></span>
* <span data-ttu-id="a42fc-198">Dans `Startup.Configure`, intergiciel (middleware) de réponse mise en cache doit être placé avant un intergiciel (middleware) qui nécessitent la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-198">In `Startup.Configure`, Response Caching Middleware must be placed before middleware that require caching.</span></span> <span data-ttu-id="a42fc-199">Pour plus d'informations, consultez <xref:fundamentals/middleware/index>.</span><span class="sxs-lookup"><span data-stu-id="a42fc-199">For more information, see <xref:fundamentals/middleware/index>.</span></span>
* <span data-ttu-id="a42fc-200">Le `Authorization` en-tête ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="a42fc-200">The `Authorization` header must not be present.</span></span>
* <span data-ttu-id="a42fc-201">`Cache-Control` paramètres de l’en-tête doivent être valides, et la réponse doit être marquée `public` et pas marquée `private`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-201">`Cache-Control` header parameters must be valid, and the response must be marked `public` and not marked `private`.</span></span>
* <span data-ttu-id="a42fc-202">Le `Pragma: no-cache` en-tête ne doit pas être présent si la `Cache-Control` en-tête n’est pas présent, comme le `Cache-Control` en-tête remplace le `Pragma` en-tête lorsqu’il est présent.</span><span class="sxs-lookup"><span data-stu-id="a42fc-202">The `Pragma: no-cache` header must not be present if the `Cache-Control` header isn't present, as the `Cache-Control` header overrides the `Pragma` header when present.</span></span>
* <span data-ttu-id="a42fc-203">Le `Set-Cookie` en-tête ne doit pas être présent.</span><span class="sxs-lookup"><span data-stu-id="a42fc-203">The `Set-Cookie` header must not be present.</span></span>
* <span data-ttu-id="a42fc-204">`Vary` paramètres de l’en-tête doivent être valide et non égal à `*`.</span><span class="sxs-lookup"><span data-stu-id="a42fc-204">`Vary` header parameters must be valid and not equal to `*`.</span></span>
* <span data-ttu-id="a42fc-205">Le `Content-Length` valeur d’en-tête (si défini) doit correspondre à la taille du corps de réponse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-205">The `Content-Length` header value (if set) must match the size of the response body.</span></span>
* <span data-ttu-id="a42fc-206">Le <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> n’est pas utilisé.</span><span class="sxs-lookup"><span data-stu-id="a42fc-206">The <xref:Microsoft.AspNetCore.Http.Features.IHttpSendFileFeature> isn't used.</span></span>
* <span data-ttu-id="a42fc-207">La réponse ne doit pas être obsolète comme spécifié par le `Expires` en-tête et le `max-age` et `s-maxage` directives de mettre en cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-207">The response must not be stale as specified by the `Expires` header and the `max-age` and `s-maxage` cache directives.</span></span>
* <span data-ttu-id="a42fc-208">Mise en mémoire tampon de réponse doit être réussie.</span><span class="sxs-lookup"><span data-stu-id="a42fc-208">Response buffering must be successful.</span></span> <span data-ttu-id="a42fc-209">La taille de la réponse doit être inférieure à la configuration ou par défaut <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>.</span><span class="sxs-lookup"><span data-stu-id="a42fc-209">The size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.SizeLimit>.</span></span> <span data-ttu-id="a42fc-210">La taille du corps de la réponse doit être inférieure à la configuration ou par défaut <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>.</span><span class="sxs-lookup"><span data-stu-id="a42fc-210">The body size of the response must be smaller than the configured or default <xref:Microsoft.AspNetCore.ResponseCaching.ResponseCachingOptions.MaximumBodySize>.</span></span>
* <span data-ttu-id="a42fc-211">La réponse doit être mis en cache en fonction de la [RFC 7234](https://tools.ietf.org/html/rfc7234) spécifications.</span><span class="sxs-lookup"><span data-stu-id="a42fc-211">The response must be cacheable according to the [RFC 7234](https://tools.ietf.org/html/rfc7234) specifications.</span></span> <span data-ttu-id="a42fc-212">Par exemple, le `no-store` directive ne doit pas exister dans les champs d’en-tête de demande ou réponse.</span><span class="sxs-lookup"><span data-stu-id="a42fc-212">For example, the `no-store` directive must not exist in request or response header fields.</span></span> <span data-ttu-id="a42fc-213">Consultez *Section 3 : Stockage des réponses dans les Caches* de [RFC 7234](https://tools.ietf.org/html/rfc7234) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="a42fc-213">See *Section 3: Storing Responses in Caches* of [RFC 7234](https://tools.ietf.org/html/rfc7234) for details.</span></span>

> [!NOTE]
> <span data-ttu-id="a42fc-214">Jeux d’attaques par le système anti-contrefaçon pour générer des jetons sécurisés pour empêcher Cross-Site demande falsification de la `Cache-Control` et `Pragma` en-têtes à `no-cache` afin que les réponses ne sont pas mises en cache.</span><span class="sxs-lookup"><span data-stu-id="a42fc-214">The Antiforgery system for generating secure tokens to prevent Cross-Site Request Forgery (CSRF) attacks sets the `Cache-Control` and `Pragma` headers to `no-cache` so that responses aren't cached.</span></span> <span data-ttu-id="a42fc-215">Pour plus d’informations sur la désactivation des jetons anti-contrefaçon pour les éléments de formulaire HTML, consultez <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span><span class="sxs-lookup"><span data-stu-id="a42fc-215">For information on how to disable antiforgery tokens for HTML form elements, see <xref:security/anti-request-forgery#aspnet-core-antiforgery-configuration>.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="a42fc-216">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="a42fc-216">Additional resources</span></span>

* <xref:fundamentals/startup>
* <xref:fundamentals/middleware/index>
* <xref:performance/caching/memory>
* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>
