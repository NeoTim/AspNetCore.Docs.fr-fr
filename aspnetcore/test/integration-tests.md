---
title: Tests d’intégration dans ASP.NET Core
author: guardrex
description: Découvrez comment les tests d’intégration garantissent le bon fonctionnement des composants d’une application au niveau de l’infrastructure, notamment la base de données, le système de fichiers et le réseau.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 06/05/2019
uid: test/integration-tests
ms.openlocfilehash: a4e22e53b4658a7c6da3c9e15671a355b212f559
ms.sourcegitcommit: 8516b586541e6ba402e57228e356639b85dfb2b9
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 07/11/2019
ms.locfileid: "67815369"
---
# <a name="integration-tests-in-aspnet-core"></a><span data-ttu-id="41313-103">Tests d’intégration dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="41313-103">Integration tests in ASP.NET Core</span></span>

<span data-ttu-id="41313-104">Par [Luke Latham](https://github.com/guardrex) et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="41313-104">By [Luke Latham](https://github.com/guardrex) and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="41313-105">Tests d’intégration vous assurer que les composants d’une application fonctionnent correctement à un niveau qui comprend l’infrastructure de prise en charge de l’application, telles que la base de données, le système de fichiers et le réseau.</span><span class="sxs-lookup"><span data-stu-id="41313-105">Integration tests ensure that an app's components function correctly at a level that includes the app's supporting infrastructure, such as the database, file system, and network.</span></span> <span data-ttu-id="41313-106">ASP.NET Core prend en charge les tests d’intégration à l’aide d’une infrastructure de tests unitaires avec un hôte web de test et un serveur de test en mémoire.</span><span class="sxs-lookup"><span data-stu-id="41313-106">ASP.NET Core supports integration tests using a unit test framework with a test web host and an in-memory test server.</span></span>

<span data-ttu-id="41313-107">Cette rubrique suppose une compréhension élémentaire des tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="41313-107">This topic assumes a basic understanding of unit tests.</span></span> <span data-ttu-id="41313-108">Si êtes pas familiarisé avec les concepts des tests, consultez le [Unit Testing in .NET Core et .NET Standard](/dotnet/core/testing/) rubrique et son contenu lié.</span><span class="sxs-lookup"><span data-stu-id="41313-108">If unfamiliar with test concepts, see the [Unit Testing in .NET Core and .NET Standard](/dotnet/core/testing/) topic and its linked content.</span></span>

<span data-ttu-id="41313-109">[Affichez ou téléchargez l’exemple de code](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="41313-109">[View or download sample code](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

<span data-ttu-id="41313-110">L’exemple d’application est une application Pages Razor et suppose une compréhension élémentaire des Pages Razor.</span><span class="sxs-lookup"><span data-stu-id="41313-110">The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages.</span></span> <span data-ttu-id="41313-111">Si êtes pas familiarisé avec les Pages Razor, consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-111">If unfamiliar with Razor Pages, see the following topics:</span></span>

* [<span data-ttu-id="41313-112">Présentation des pages Razor</span><span class="sxs-lookup"><span data-stu-id="41313-112">Introduction to Razor Pages</span></span>](xref:razor-pages/index)
* [<span data-ttu-id="41313-113">Bien démarrer avec les pages Razor</span><span class="sxs-lookup"><span data-stu-id="41313-113">Get started with Razor Pages</span></span>](xref:tutorials/razor-pages/razor-pages-start)
* [<span data-ttu-id="41313-114">Tests unitaires Pages Razor</span><span class="sxs-lookup"><span data-stu-id="41313-114">Razor Pages unit tests</span></span>](xref:test/razor-pages-tests)

> [!NOTE]
> <span data-ttu-id="41313-115">Pour tester les applications SPA, nous recommandons un outil tel que [Selenium](https://www.seleniumhq.org/), ce qui permet d’automatiser un navigateur.</span><span class="sxs-lookup"><span data-stu-id="41313-115">For testing SPAs, we recommended a tool such as [Selenium](https://www.seleniumhq.org/), which can automate a browser.</span></span>

## <a name="introduction-to-integration-tests"></a><span data-ttu-id="41313-116">Introduction aux tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="41313-116">Introduction to integration tests</span></span>

<span data-ttu-id="41313-117">Composants d’une application sur un niveau supérieur à évaluent les tests d’intégration [tests unitaires](/dotnet/core/testing/).</span><span class="sxs-lookup"><span data-stu-id="41313-117">Integration tests evaluate an app's components on a broader level than [unit tests](/dotnet/core/testing/).</span></span> <span data-ttu-id="41313-118">Tests unitaires sont utilisés pour tester les composants logiciels isolé, telles que les méthodes de classe individuels.</span><span class="sxs-lookup"><span data-stu-id="41313-118">Unit tests are used to test isolated software components, such as individual class methods.</span></span> <span data-ttu-id="41313-119">Tests d’intégration confirmer que deux ou plusieurs composants d’application fonctionnent ensemble pour produire un résultat attendu, éventuellement, y compris tous les composants requis pour traiter complètement une demande.</span><span class="sxs-lookup"><span data-stu-id="41313-119">Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</span></span>

<span data-ttu-id="41313-120">Ces tests plus larges sont utilisés pour tester l’application infrastructure et framework entier, parmi lesquels figurent souvent les composants suivants :</span><span class="sxs-lookup"><span data-stu-id="41313-120">These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</span></span>

* <span data-ttu-id="41313-121">Base de données</span><span class="sxs-lookup"><span data-stu-id="41313-121">Database</span></span>
* <span data-ttu-id="41313-122">Système de fichiers</span><span class="sxs-lookup"><span data-stu-id="41313-122">File system</span></span>
* <span data-ttu-id="41313-123">Appliances réseau</span><span class="sxs-lookup"><span data-stu-id="41313-123">Network appliances</span></span>
* <span data-ttu-id="41313-124">Pipeline de requête-réponse</span><span class="sxs-lookup"><span data-stu-id="41313-124">Request-response pipeline</span></span>

<span data-ttu-id="41313-125">Utilisez fabriqué composants, appelés des tests unitaires *fakes* ou *objets fictifs*, à la place des composants d’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="41313-125">Unit tests use fabricated components, known as *fakes* or *mock objects*, in place of infrastructure components.</span></span>

<span data-ttu-id="41313-126">Contrairement aux tests unitaires, tests d’intégration :</span><span class="sxs-lookup"><span data-stu-id="41313-126">In contrast to unit tests, integration tests:</span></span>

* <span data-ttu-id="41313-127">Utiliser les composants réelles utilisée par l’application en production.</span><span class="sxs-lookup"><span data-stu-id="41313-127">Use the actual components that the app uses in production.</span></span>
* <span data-ttu-id="41313-128">Nécessitent plus de code et de traitement des données.</span><span class="sxs-lookup"><span data-stu-id="41313-128">Require more code and data processing.</span></span>
* <span data-ttu-id="41313-129">Prendre plus de temps.</span><span class="sxs-lookup"><span data-stu-id="41313-129">Take longer to run.</span></span>

<span data-ttu-id="41313-130">Par conséquent, limitez l’utilisation de tests d’intégration pour les scénarios d’infrastructure plus importantes.</span><span class="sxs-lookup"><span data-stu-id="41313-130">Therefore, limit the use of integration tests to the most important infrastructure scenarios.</span></span> <span data-ttu-id="41313-131">Si un comportement peut être testé à l’aide d’un test unitaire ou un test d’intégration, sélectionnez le test unitaire.</span><span class="sxs-lookup"><span data-stu-id="41313-131">If a behavior can be tested using either a unit test or an integration test, choose the unit test.</span></span>

> [!TIP]
> <span data-ttu-id="41313-132">N’écrivez pas les tests d’intégration pour chaque permutation possibles d’accès de fichiers et de données avec les bases de données et les systèmes de fichiers.</span><span class="sxs-lookup"><span data-stu-id="41313-132">Don't write integration tests for every possible permutation of data and file access with databases and file systems.</span></span> <span data-ttu-id="41313-133">Quel que soit le nombre de positions entre une application interagir avec les bases de données et les systèmes de fichiers, un ensemble concentré de lecture, écriture, update et delete intégration tests sont généralement capables de base de données de test de manière adéquate et composants du système de fichiers.</span><span class="sxs-lookup"><span data-stu-id="41313-133">Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components.</span></span> <span data-ttu-id="41313-134">Utilisez les tests unitaires pour les tests de logique de la méthode de routine qui interagissent avec ces composants.</span><span class="sxs-lookup"><span data-stu-id="41313-134">Use unit tests for routine tests of method logic that interact with these components.</span></span> <span data-ttu-id="41313-135">Dans les tests unitaires, l’utilisation de l’infrastructure substituts/simulacres résultat accélère l’exécution de test.</span><span class="sxs-lookup"><span data-stu-id="41313-135">In unit tests, the use of infrastructure fakes/mocks result in faster test execution.</span></span>

> [!NOTE]
> <span data-ttu-id="41313-136">Dans les discussions des tests d’intégration, le projet testé est fréquemment appelé le *système testé*, ou « ST » pour faire plus court.</span><span class="sxs-lookup"><span data-stu-id="41313-136">In discussions of integration tests, the tested project is frequently called the *system under test*, or "SUT" for short.</span></span>

## <a name="aspnet-core-integration-tests"></a><span data-ttu-id="41313-137">Tests d’intégration ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="41313-137">ASP.NET Core integration tests</span></span>

<span data-ttu-id="41313-138">Tests d’intégration dans ASP.NET Core requièrent les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="41313-138">Integration tests in ASP.NET Core require the following:</span></span>

* <span data-ttu-id="41313-139">Un projet de test est utilisé pour contenir et exécuter les tests.</span><span class="sxs-lookup"><span data-stu-id="41313-139">A test project is used to contain and execute the tests.</span></span> <span data-ttu-id="41313-140">Le projet de test a une référence au projet ASP.NET Core testé, appelé le *système testé* (ST).</span><span class="sxs-lookup"><span data-stu-id="41313-140">The test project has a reference to the tested ASP.NET Core project, called the *system under test* (SUT).</span></span> <span data-ttu-id="41313-141">_« ST » est utilisé tout au long de cette rubrique pour faire référence à l’application testée._</span><span class="sxs-lookup"><span data-stu-id="41313-141">_"SUT" is used throughout this topic to refer to the tested app._</span></span>
* <span data-ttu-id="41313-142">Le projet de test crée un hôte web de test pour le st et utilise un client de serveur de test pour gérer les demandes et réponses sur le st.</span><span class="sxs-lookup"><span data-stu-id="41313-142">The test project creates a test web host for the SUT and uses a test server client to handle requests and responses to the SUT.</span></span>
* <span data-ttu-id="41313-143">Un test runner est utilisé pour exécuter les tests et les rapports les résultats des tests.</span><span class="sxs-lookup"><span data-stu-id="41313-143">A test runner is used to execute the tests and report the test results.</span></span>

<span data-ttu-id="41313-144">Tests d’intégration suivent une séquence d’événements qui incluent habituelles *organiser*, *Act*, et *Assert* étapes de test :</span><span class="sxs-lookup"><span data-stu-id="41313-144">Integration tests follow a sequence of events that include the usual *Arrange*, *Act*, and *Assert* test steps:</span></span>

1. <span data-ttu-id="41313-145">Hôte de web du St est configuré.</span><span class="sxs-lookup"><span data-stu-id="41313-145">The SUT's web host is configured.</span></span>
1. <span data-ttu-id="41313-146">Un client de serveur de test est créé pour envoyer des demandes à l’application.</span><span class="sxs-lookup"><span data-stu-id="41313-146">A test server client is created to submit requests to the app.</span></span>
1. <span data-ttu-id="41313-147">Le *organiser* étape de test est exécuté : L’application de test prépare une demande.</span><span class="sxs-lookup"><span data-stu-id="41313-147">The *Arrange* test step is executed: The test app prepares a request.</span></span>
1. <span data-ttu-id="41313-148">Le *Act* étape de test est exécuté : Le client envoie la demande et reçoit la réponse.</span><span class="sxs-lookup"><span data-stu-id="41313-148">The *Act* test step is executed: The client submits the request and receives the response.</span></span>
1. <span data-ttu-id="41313-149">Le *Assert* étape de test est exécuté : Le *réel* réponse est validée comme un *passer* ou *échouer* selon un *attendu* réponse.</span><span class="sxs-lookup"><span data-stu-id="41313-149">The *Assert* test step is executed: The *actual* response is validated as a *pass* or *fail* based on an *expected* response.</span></span>
1. <span data-ttu-id="41313-150">Le processus se poursuit jusqu'à ce que tous les tests sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="41313-150">The process continues until all of the tests are executed.</span></span>
1. <span data-ttu-id="41313-151">Les résultats des tests sont signalés.</span><span class="sxs-lookup"><span data-stu-id="41313-151">The test results are reported.</span></span>

<span data-ttu-id="41313-152">En règle générale, l’hôte du test web est configuré différemment que l’hôte web normaux de l’application pour le test s’exécute.</span><span class="sxs-lookup"><span data-stu-id="41313-152">Usually, the test web host is configured differently than the app's normal web host for the test runs.</span></span> <span data-ttu-id="41313-153">Par exemple, une autre base de données ou des paramètres d’application différents peuvent être utilisés pour les tests.</span><span class="sxs-lookup"><span data-stu-id="41313-153">For example, a different database or different app settings might be used for the tests.</span></span>

<span data-ttu-id="41313-154">Composants d’infrastructure, tels que l’hôte web de test et le serveur de test en mémoire ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), sont fournies ou gérés par le [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package.</span><span class="sxs-lookup"><span data-stu-id="41313-154">Infrastructure components, such as the test web host and in-memory test server ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), are provided or managed by the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package.</span></span> <span data-ttu-id="41313-155">Utilisation de ce package simplifie la création de test et l’exécution.</span><span class="sxs-lookup"><span data-stu-id="41313-155">Use of this package streamlines test creation and execution.</span></span>

<span data-ttu-id="41313-156">Le `Microsoft.AspNetCore.Mvc.Testing` package gère les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-156">The `Microsoft.AspNetCore.Mvc.Testing` package handles the following tasks:</span></span>

* <span data-ttu-id="41313-157">Copie le fichier de dépendances ( *\*.deps*) du St dans le projet de test *bin* directory.</span><span class="sxs-lookup"><span data-stu-id="41313-157">Copies the dependencies file (*\*.deps*) from the SUT into the test project's *bin* directory.</span></span>
* <span data-ttu-id="41313-158">Définit la racine de contenu à la racine du projet du St afin que les fichiers statiques et les pages/affichages sont disponibles lorsque les tests sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="41313-158">Sets the content root to the SUT's project root so that static files and pages/views are found when the tests are executed.</span></span>
* <span data-ttu-id="41313-159">Fournit le [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) classe pour rationaliser l’amorçage le ST avec `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="41313-159">Provides the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) class to streamline bootstrapping the SUT with `TestServer`.</span></span>

<span data-ttu-id="41313-160">Le [tests unitaires](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) documentation explique comment configurer un projet et test testeur, ainsi que des instructions détaillées sur l’exécution des tests et des recommandations sur la manière de tests de nom et classes de test.</span><span class="sxs-lookup"><span data-stu-id="41313-160">The [unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</span></span>

> [!NOTE]
> <span data-ttu-id="41313-161">Lorsque vous créez un projet de test pour une application, séparez les tests unitaires dans les tests d’intégration dans des projets différents.</span><span class="sxs-lookup"><span data-stu-id="41313-161">When creating a test project for an app, separate the unit tests from the integration tests into different projects.</span></span> <span data-ttu-id="41313-162">Ce permet de s’assurer que les composants d’infrastructure test ne sont pas inclus par inadvertance dans les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="41313-162">This helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</span></span> <span data-ttu-id="41313-163">Séparation des tests unitaires et d’intégration permet également à contrôler sur quel jeu de tests sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="41313-163">Separation of unit and integration tests also allows control over which set of tests are run.</span></span>

<span data-ttu-id="41313-164">Il n’existe pratiquement aucune différence entre la configuration pour les tests d’applications de Pages Razor et les applications MVC.</span><span class="sxs-lookup"><span data-stu-id="41313-164">There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps.</span></span> <span data-ttu-id="41313-165">La seule différence est dans la manière dont les tests sont appelés.</span><span class="sxs-lookup"><span data-stu-id="41313-165">The only difference is in how the tests are named.</span></span> <span data-ttu-id="41313-166">Dans une application Pages Razor, les tests de points de terminaison de page sont généralement nommés après la classe de modèle de page (par exemple, `IndexPageTests` pour tester l’intégration du composant pour la page d’Index).</span><span class="sxs-lookup"><span data-stu-id="41313-166">In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, `IndexPageTests` to test component integration for the Index page).</span></span> <span data-ttu-id="41313-167">Dans une application MVC, les tests sont généralement organisées par les classes de contrôleur et nommées d’après les contrôleurs ils testent (par exemple, `HomeControllerTests` pour tester l’intégration du composant pour le contrôleur Home).</span><span class="sxs-lookup"><span data-stu-id="41313-167">In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, `HomeControllerTests` to test component integration for the Home controller).</span></span>

## <a name="test-app-prerequisites"></a><span data-ttu-id="41313-168">Tester les conditions préalables requises de l’application</span><span class="sxs-lookup"><span data-stu-id="41313-168">Test app prerequisites</span></span>

<span data-ttu-id="41313-169">Le projet de test doit :</span><span class="sxs-lookup"><span data-stu-id="41313-169">The test project must:</span></span>

* <span data-ttu-id="41313-170">Référencer les packages suivants :</span><span class="sxs-lookup"><span data-stu-id="41313-170">Reference the following packages:</span></span>
  * [<span data-ttu-id="41313-171">Microsoft.AspNetCore.App</span><span class="sxs-lookup"><span data-stu-id="41313-171">Microsoft.AspNetCore.App</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.App/)
  * [<span data-ttu-id="41313-172">Microsoft.AspNetCore.Mvc.Testing</span><span class="sxs-lookup"><span data-stu-id="41313-172">Microsoft.AspNetCore.Mvc.Testing</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing/)
* <span data-ttu-id="41313-173">Spécifiez le Kit de développement Web dans le fichier projet (`<Project Sdk="Microsoft.NET.Sdk.Web">`).</span><span class="sxs-lookup"><span data-stu-id="41313-173">Specify the Web SDK in the project file (`<Project Sdk="Microsoft.NET.Sdk.Web">`).</span></span> <span data-ttu-id="41313-174">Le Kit de développement Web est requis lorsque vous référencez le [Microsoft.AspNetCore.App métapackage](xref:fundamentals/metapackage-app).</span><span class="sxs-lookup"><span data-stu-id="41313-174">The Web SDK is required when referencing the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app).</span></span>

<span data-ttu-id="41313-175">Ces conditions préalables sont consultables dans la [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span><span class="sxs-lookup"><span data-stu-id="41313-175">These prerequisites can be seen in the [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span></span> <span data-ttu-id="41313-176">Inspecter le *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj* fichier.</span><span class="sxs-lookup"><span data-stu-id="41313-176">Inspect the *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj* file.</span></span> <span data-ttu-id="41313-177">L’exemple d’application utilise le [xUnit](https://xunit.github.io/) infrastructure de test et le [AngleSharp](https://anglesharp.github.io/) bibliothèque de l’analyseur, donc fait également référence à l’exemple d’application :</span><span class="sxs-lookup"><span data-stu-id="41313-177">The sample app uses the [xUnit](https://xunit.github.io/) test framework and the [AngleSharp](https://anglesharp.github.io/) parser library, so the sample app also references:</span></span>

* [<span data-ttu-id="41313-178">xunit</span><span class="sxs-lookup"><span data-stu-id="41313-178">xunit</span></span>](https://www.nuget.org/packages/xunit/)
* [<span data-ttu-id="41313-179">xunit.runner.visualstudio</span><span class="sxs-lookup"><span data-stu-id="41313-179">xunit.runner.visualstudio</span></span>](https://www.nuget.org/packages/xunit.runner.visualstudio/)
* [<span data-ttu-id="41313-180">AngleSharp</span><span class="sxs-lookup"><span data-stu-id="41313-180">AngleSharp</span></span>](https://www.nuget.org/packages/AngleSharp/)

## <a name="sut-environment"></a><span data-ttu-id="41313-181">Environnement de St</span><span class="sxs-lookup"><span data-stu-id="41313-181">SUT environment</span></span>

<span data-ttu-id="41313-182">Si le st [environnement](xref:fundamentals/environments) n’est pas définie, les valeurs par défaut de l’environnement de développement.</span><span class="sxs-lookup"><span data-stu-id="41313-182">If the SUT's [environment](xref:fundamentals/environments) isn't set, the environment defaults to Development.</span></span>

## <a name="basic-tests-with-the-default-webapplicationfactory"></a><span data-ttu-id="41313-183">Tests de base avec la valeur par défaut WebApplicationFactory</span><span class="sxs-lookup"><span data-stu-id="41313-183">Basic tests with the default WebApplicationFactory</span></span>

<span data-ttu-id="41313-184">[WebApplicationFactory&lt;TEntryPoint&gt; ](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) est utilisé pour créer un [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) pour les tests d’intégration.</span><span class="sxs-lookup"><span data-stu-id="41313-184">[WebApplicationFactory&lt;TEntryPoint&gt;](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) is used to create a [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) for the integration tests.</span></span> <span data-ttu-id="41313-185">`TEntryPoint` est la classe de point d’entrée du St, généralement la `Startup` classe.</span><span class="sxs-lookup"><span data-stu-id="41313-185">`TEntryPoint` is the entry point class of the SUT, usually the `Startup` class.</span></span>

<span data-ttu-id="41313-186">Classes de test implémentent un *fixture de classe* interface ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) pour indiquer la classe contient des tests et fournir des instances d’objet partagé entre les tests dans la classe.</span><span class="sxs-lookup"><span data-stu-id="41313-186">Test classes implement a *class fixture* interface ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) to indicate the class contains tests and provide shared object instances across the tests in the class.</span></span>

### <a name="basic-test-of-app-endpoints"></a><span data-ttu-id="41313-187">Test de base des points de terminaison d’application</span><span class="sxs-lookup"><span data-stu-id="41313-187">Basic test of app endpoints</span></span>

<span data-ttu-id="41313-188">Classe, de test de ce qui suit `BasicTests`, utilise le `WebApplicationFactory` pour amorcer le st et fournir un [HttpClient](/dotnet/api/system.net.http.httpclient) à une méthode de test, `Get_EndpointsReturnSuccessAndCorrectContentType`.</span><span class="sxs-lookup"><span data-stu-id="41313-188">The following test class, `BasicTests`, uses the `WebApplicationFactory` to bootstrap the SUT and provide an [HttpClient](/dotnet/api/system.net.http.httpclient) to a test method, `Get_EndpointsReturnSuccessAndCorrectContentType`.</span></span> <span data-ttu-id="41313-189">La méthode vérifie si le code d’état de réponse a réussi (codes d’état dans la plage 200-299) et le `Content-Type` en-tête est `text/html; charset=utf-8` pour plusieurs pages d’application.</span><span class="sxs-lookup"><span data-stu-id="41313-189">The method checks if the response status code is successful (status codes in the range 200-299) and the `Content-Type` header is `text/html; charset=utf-8` for several app pages.</span></span>

<span data-ttu-id="41313-190">[Createclient utile](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) crée une instance de `HttpClient` qui suit les redirections et gère les cookies automatiquement.</span><span class="sxs-lookup"><span data-stu-id="41313-190">[CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) creates an instance of `HttpClient` that automatically follows redirects and handles cookies.</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/BasicTests.cs?name=snippet1)]

<span data-ttu-id="41313-191">Par défaut, les cookies non essentielles ne sont pas conservés dans les demandes quand le [stratégie de consentement RGPD](xref:security/gdpr) est activé.</span><span class="sxs-lookup"><span data-stu-id="41313-191">By default, non-essential cookies aren't preserved across requests when the [GDPR consent policy](xref:security/gdpr) is enabled.</span></span> <span data-ttu-id="41313-192">Pour conserver les cookies non essentiels, tels que ceux utilisés par le fournisseur TempData, marquez-les comme essentielle dans vos tests.</span><span class="sxs-lookup"><span data-stu-id="41313-192">To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests.</span></span> <span data-ttu-id="41313-193">Pour obtenir des instructions sur le marquage d’un cookie en tant qu’essentielles, consultez [cookies essentielles](xref:security/gdpr#essential-cookies).</span><span class="sxs-lookup"><span data-stu-id="41313-193">For instructions on marking a cookie as essential, see [Essential cookies](xref:security/gdpr#essential-cookies).</span></span>

### <a name="test-a-secure-endpoint"></a><span data-ttu-id="41313-194">Tester un point de terminaison sécurisé</span><span class="sxs-lookup"><span data-stu-id="41313-194">Test a secure endpoint</span></span>

<span data-ttu-id="41313-195">Un autre test dans le `BasicTests` classe vérifie qu’un point de terminaison sécurisé redirige un utilisateur non authentifié à la page de connexion de l’application.</span><span class="sxs-lookup"><span data-stu-id="41313-195">Another test in the `BasicTests` class checks that a secure endpoint redirects an unauthenticated user to the app's Login page.</span></span>

<span data-ttu-id="41313-196">Dans le st, la `/SecurePage` page utilise un [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) convention qui permet d’appliquer un [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) à la page.</span><span class="sxs-lookup"><span data-stu-id="41313-196">In the SUT, the `/SecurePage` page uses an [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) convention to apply an [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) to the page.</span></span> <span data-ttu-id="41313-197">Pour plus d’informations, consultez [conventions d’autorisation des Pages Razor](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span><span class="sxs-lookup"><span data-stu-id="41313-197">For more information, see [Razor Pages authorization conventions](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet1)]

<span data-ttu-id="41313-198">Dans le `Get_SecurePageRequiresAnAuthenticatedUser` tester, un [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) est configuré pour interdire les redirections en définissant [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) à `false`:</span><span class="sxs-lookup"><span data-stu-id="41313-198">In the `Get_SecurePageRequiresAnAuthenticatedUser` test, a [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) is set to disallow redirects by setting [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) to `false`:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/BasicTests.cs?name=snippet2)]

<span data-ttu-id="41313-199">En interdisant le client pour suivre la redirection, vous peuvent effectuer les vérifications suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-199">By disallowing the client to follow the redirect, the following checks can be made:</span></span>

* <span data-ttu-id="41313-200">Le code d’état retourné par le st peut être vérifié par rapport à attendu [HttpStatusCode.Redirect](/dotnet/api/system.net.httpstatuscode) résultat, pas le code d’état final après la redirection vers la page de connexion, ce qui serait [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span><span class="sxs-lookup"><span data-stu-id="41313-200">The status code returned by the SUT can be checked against the expected [HttpStatusCode.Redirect](/dotnet/api/system.net.httpstatuscode) result, not the final status code after the redirect to the Login page, which would be [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span></span>
* <span data-ttu-id="41313-201">Le `Location` valeur d’en-tête dans les en-têtes de réponse est activée pour confirmer qu’il démarre avec `http://localhost/Identity/Account/Login`, pas la dernière page réponse de connexion, où le `Location` en-tête n’aurait pas être présent.</span><span class="sxs-lookup"><span data-stu-id="41313-201">The `Location` header value in the response headers is checked to confirm that it starts with `http://localhost/Identity/Account/Login`, not the final Login page response, where the `Location` header wouldn't be present.</span></span>

<span data-ttu-id="41313-202">Pour plus d’informations sur `WebApplicationFactoryClientOptions`, consultez le [options du Client](#client-options) section.</span><span class="sxs-lookup"><span data-stu-id="41313-202">For more information on `WebApplicationFactoryClientOptions`, see the [Client options](#client-options) section.</span></span>

## <a name="customize-webapplicationfactory"></a><span data-ttu-id="41313-203">Personnaliser WebApplicationFactory</span><span class="sxs-lookup"><span data-stu-id="41313-203">Customize WebApplicationFactory</span></span>

<span data-ttu-id="41313-204">Configuration de l’hôte Web peut être créée indépendamment les classes de test en héritant de `WebApplicationFactory` pour créer un ou plusieurs des fabrications personnalisées :</span><span class="sxs-lookup"><span data-stu-id="41313-204">Web host configuration can be created independently of the test classes by inheriting from `WebApplicationFactory` to create one or more custom factories:</span></span>

1. <span data-ttu-id="41313-205">Hériter `WebApplicationFactory` et remplacer [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost).</span><span class="sxs-lookup"><span data-stu-id="41313-205">Inherit from `WebApplicationFactory` and override [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost).</span></span> <span data-ttu-id="41313-206">Le [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) permet la configuration de la collection de service avec [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span><span class="sxs-lookup"><span data-stu-id="41313-206">The [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) allows the configuration of the service collection with [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/CustomWebApplicationFactory.cs?name=snippet1)]

   <span data-ttu-id="41313-207">Base de données d’amorçage dans le [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) est effectuée par le `InitializeDbForTests` (méthode).</span><span class="sxs-lookup"><span data-stu-id="41313-207">Database seeding in the [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is performed by the `InitializeDbForTests` method.</span></span> <span data-ttu-id="41313-208">La méthode est décrite dans la [exemple de tests d’intégration : Organisation de l’application test](#test-app-organization) section.</span><span class="sxs-lookup"><span data-stu-id="41313-208">The method is described in the [Integration tests sample: Test app organization](#test-app-organization) section.</span></span>

2. <span data-ttu-id="41313-209">Utilisez personnalisé `CustomWebApplicationFactory` dans les classes de test.</span><span class="sxs-lookup"><span data-stu-id="41313-209">Use the custom `CustomWebApplicationFactory` in test classes.</span></span> <span data-ttu-id="41313-210">L’exemple suivant utilise la fabrique dans la `IndexPageTests` classe :</span><span class="sxs-lookup"><span data-stu-id="41313-210">The following example uses the factory in the `IndexPageTests` class:</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet1)]

   <span data-ttu-id="41313-211">Client de l’application exemple est configuré pour empêcher le `HttpClient` à partir de redirections suivantes.</span><span class="sxs-lookup"><span data-stu-id="41313-211">The sample app's client is configured to prevent the `HttpClient` from following redirects.</span></span> <span data-ttu-id="41313-212">Comme expliqué dans la [tester un point de terminaison sécurisé](#test-a-secure-endpoint) section, cela permet des tests pour vérifier le résultat de la première réponse de l’application.</span><span class="sxs-lookup"><span data-stu-id="41313-212">As explained in the [Test a secure endpoint](#test-a-secure-endpoint) section, this permits tests to check the result of the app's first response.</span></span> <span data-ttu-id="41313-213">La première réponse est une redirection dans la plupart de ces tests avec un `Location` en-tête.</span><span class="sxs-lookup"><span data-stu-id="41313-213">The first response is a redirect in many of these tests with a `Location` header.</span></span>

3. <span data-ttu-id="41313-214">Un test classique utilise la `HttpClient` et méthodes d’assistance pour traiter la demande et la réponse :</span><span class="sxs-lookup"><span data-stu-id="41313-214">A typical test uses the `HttpClient` and helper methods to process the request and the response:</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet2)]

<span data-ttu-id="41313-215">Toute demande POST sur le st doit satisfaire la vérification anti-contrefaçon est effectuée automatiquement par l’application [système anti-contrefaçon de protection de données](xref:security/data-protection/introduction).</span><span class="sxs-lookup"><span data-stu-id="41313-215">Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's [data protection antiforgery system](xref:security/data-protection/introduction).</span></span> <span data-ttu-id="41313-216">Afin de disposer de demande POST d’un test, l’application de test doit :</span><span class="sxs-lookup"><span data-stu-id="41313-216">In order to arrange for a test's POST request, the test app must:</span></span>

1. <span data-ttu-id="41313-217">Effectuer une demande pour la page.</span><span class="sxs-lookup"><span data-stu-id="41313-217">Make a request for the page.</span></span>
1. <span data-ttu-id="41313-218">Analyser le cookie anti-contrefaçon et le jeton de validation de demande à partir de la réponse.</span><span class="sxs-lookup"><span data-stu-id="41313-218">Parse the antiforgery cookie and request validation token from the response.</span></span>
1. <span data-ttu-id="41313-219">Effectuer la demande POST avec la validation de demande et le cookie anti-contrefaçon jeton en place.</span><span class="sxs-lookup"><span data-stu-id="41313-219">Make the POST request with the antiforgery cookie and request validation token in place.</span></span>

<span data-ttu-id="41313-220">Le `SendAsync` méthodes d’extension d’assistance (*Helpers/HttpClientExtensions.cs*) et le `GetDocumentAsync` méthode d’assistance (*Helpers/HtmlHelpers.cs*) dans le [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) utiliser le [AngleSharp](https://anglesharp.github.io/) analyseur pour gérer le contrôle anti-contrefaçon avec les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-220">The `SendAsync` helper extension methods (*Helpers/HttpClientExtensions.cs*) and the `GetDocumentAsync` helper method (*Helpers/HtmlHelpers.cs*) in the [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) use the [AngleSharp](https://anglesharp.github.io/) parser to handle the antiforgery check with the following methods:</span></span>

* <span data-ttu-id="41313-221">`GetDocumentAsync` &ndash; Reçoit le [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) et retourne un `IHtmlDocument`.</span><span class="sxs-lookup"><span data-stu-id="41313-221">`GetDocumentAsync` &ndash; Receives the [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) and returns an `IHtmlDocument`.</span></span> <span data-ttu-id="41313-222">`GetDocumentAsync` utilise une fabrique qui prépare une *réponse virtuel* selon la version d’origine `HttpResponseMessage`.</span><span class="sxs-lookup"><span data-stu-id="41313-222">`GetDocumentAsync` uses a factory that prepares a *virtual response* based on the original `HttpResponseMessage`.</span></span> <span data-ttu-id="41313-223">Pour plus d’informations, consultez le [AngleSharp documentation](https://github.com/AngleSharp/AngleSharp#documentation).</span><span class="sxs-lookup"><span data-stu-id="41313-223">For more information, see the [AngleSharp documentation](https://github.com/AngleSharp/AngleSharp#documentation).</span></span>
* <span data-ttu-id="41313-224">`SendAsync` méthodes d’extension pour le `HttpClient` composer un [HttpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) et appelez [SendAsync(HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) pour soumettre des demandes sur le st.</span><span class="sxs-lookup"><span data-stu-id="41313-224">`SendAsync` extension methods for the `HttpClient` compose an [HttpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) and call [SendAsync(HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) to submit requests to the SUT.</span></span> <span data-ttu-id="41313-225">Surcharges pour `SendAsync` acceptez le formulaire HTML (`IHtmlFormElement`) et les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="41313-225">Overloads for `SendAsync` accept the HTML form (`IHtmlFormElement`) and the following:</span></span>
  * <span data-ttu-id="41313-226">Bouton du formulaire d’envoi (`IHtmlElement`)</span><span class="sxs-lookup"><span data-stu-id="41313-226">Submit button of the form (`IHtmlElement`)</span></span>
  * <span data-ttu-id="41313-227">Collection des valeurs de formulaire (`IEnumerable<KeyValuePair<string, string>>`)</span><span class="sxs-lookup"><span data-stu-id="41313-227">Form values collection (`IEnumerable<KeyValuePair<string, string>>`)</span></span>
  * <span data-ttu-id="41313-228">Bouton d’envoi (`IHtmlElement`) et les valeurs de formulaire (`IEnumerable<KeyValuePair<string, string>>`)</span><span class="sxs-lookup"><span data-stu-id="41313-228">Submit button (`IHtmlElement`) and form values (`IEnumerable<KeyValuePair<string, string>>`)</span></span>

> [!NOTE]
> <span data-ttu-id="41313-229">[AngleSharp](https://anglesharp.github.io/) est un tiers, l’analyse bibliothèque utilisé à des fins de démonstration dans cette rubrique et l’exemple d’application.</span><span class="sxs-lookup"><span data-stu-id="41313-229">[AngleSharp](https://anglesharp.github.io/) is a third-party parsing library used for demonstration purposes in this topic and the sample app.</span></span> <span data-ttu-id="41313-230">AngleSharp n’est pas pris en charge ou requises pour les tests d’intégration des applications ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="41313-230">AngleSharp isn't supported or required for integration testing of ASP.NET Core apps.</span></span> <span data-ttu-id="41313-231">Autres analyseurs peuvent être utilisées, telle que la [Html agilité Pack (HAP)](https://html-agility-pack.net/).</span><span class="sxs-lookup"><span data-stu-id="41313-231">Other parsers can be used, such as the [Html Agility Pack (HAP)](https://html-agility-pack.net/).</span></span> <span data-ttu-id="41313-232">Une autre approche consiste à écrire du code pour gérer la demande de jeton de vérification et le cookie anti-contrefaçon le système anti-contrefaçon directement.</span><span class="sxs-lookup"><span data-stu-id="41313-232">Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly.</span></span>

## <a name="customize-the-client-with-withwebhostbuilder"></a><span data-ttu-id="41313-233">Personnalisation du client avec WithWebHostBuilder</span><span class="sxs-lookup"><span data-stu-id="41313-233">Customize the client with WithWebHostBuilder</span></span>

<span data-ttu-id="41313-234">Lors de la configuration supplémentaire est nécessaire au sein d’une méthode de test, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) crée un `WebApplicationFactory` avec un [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) qui est personnalisé en configuration.</span><span class="sxs-lookup"><span data-stu-id="41313-234">When additional configuration is required within a test method, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) creates a new `WebApplicationFactory` with an [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) that is further customized by configuration.</span></span>

<span data-ttu-id="41313-235">Le `Post_DeleteMessageHandler_ReturnsRedirectToRoot` tester la méthode de la [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) illustre l’utilisation de `WithWebHostBuilder`.</span><span class="sxs-lookup"><span data-stu-id="41313-235">The `Post_DeleteMessageHandler_ReturnsRedirectToRoot` test method of the [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) demonstrates the use of `WithWebHostBuilder`.</span></span> <span data-ttu-id="41313-236">Ce test exécute une suppression de l’enregistrement dans la base de données en déclenchant l’envoi d’un formulaire dans le st.</span><span class="sxs-lookup"><span data-stu-id="41313-236">This test performs a record delete in the database by triggering a form submission in the SUT.</span></span>

<span data-ttu-id="41313-237">Car un autre test dans le `IndexPageTests` classe effectue une opération qui supprime tous les enregistrements dans la base de données et peut-être s’exécuter avant le `Post_DeleteMessageHandler_ReturnsRedirectToRoot` (méthode), la base de données est amorcée dans cette méthode de test pour vous assurer qu’un enregistrement est présent pour le st à supprimer.</span><span class="sxs-lookup"><span data-stu-id="41313-237">Because another test in the `IndexPageTests` class performs an operation that deletes all of the records in the database and may run before the `Post_DeleteMessageHandler_ReturnsRedirectToRoot` method, the database is seeded in this test method to ensure that a record is present for the SUT to delete.</span></span> <span data-ttu-id="41313-238">En sélectionnant le `deleteBtn1` bouton de la `messages` formulaire dans le st est simulée à la demande pour le st :</span><span class="sxs-lookup"><span data-stu-id="41313-238">Selecting the `deleteBtn1` button of the `messages` form in the SUT is simulated in the request to the SUT:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet3)]

## <a name="client-options"></a><span data-ttu-id="41313-239">Options du client</span><span class="sxs-lookup"><span data-stu-id="41313-239">Client options</span></span>

<span data-ttu-id="41313-240">Le tableau suivant présente la valeur par défaut [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) disponibles lors de la création `HttpClient` instances.</span><span class="sxs-lookup"><span data-stu-id="41313-240">The following table shows the default [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) available when creating `HttpClient` instances.</span></span>

| <span data-ttu-id="41313-241">Option</span><span class="sxs-lookup"><span data-stu-id="41313-241">Option</span></span> | <span data-ttu-id="41313-242">Description</span><span class="sxs-lookup"><span data-stu-id="41313-242">Description</span></span> | <span data-ttu-id="41313-243">Default</span><span class="sxs-lookup"><span data-stu-id="41313-243">Default</span></span> |
| ------ | ----------- | ------- |
| [<span data-ttu-id="41313-244">AllowAutoRedirect</span><span class="sxs-lookup"><span data-stu-id="41313-244">AllowAutoRedirect</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) | <span data-ttu-id="41313-245">Obtient ou définit si `HttpClient` instances doivent suivre automatiquement les réponses de redirection.</span><span class="sxs-lookup"><span data-stu-id="41313-245">Gets or sets whether or not `HttpClient` instances should automatically follow redirect responses.</span></span> | `true` |
| [<span data-ttu-id="41313-246">BaseAddress</span><span class="sxs-lookup"><span data-stu-id="41313-246">BaseAddress</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.baseaddress) | <span data-ttu-id="41313-247">Obtient ou définit l’adresse de base de `HttpClient` instances.</span><span class="sxs-lookup"><span data-stu-id="41313-247">Gets or sets the base address of `HttpClient` instances.</span></span> | `http://localhost` |
| [<span data-ttu-id="41313-248">HandleCookies</span><span class="sxs-lookup"><span data-stu-id="41313-248">HandleCookies</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.handlecookies) | <span data-ttu-id="41313-249">Obtient ou définit si `HttpClient` instances doivent gérer les cookies.</span><span class="sxs-lookup"><span data-stu-id="41313-249">Gets or sets whether `HttpClient` instances should handle cookies.</span></span> | `true` |
| [<span data-ttu-id="41313-250">MaxAutomaticRedirections</span><span class="sxs-lookup"><span data-stu-id="41313-250">MaxAutomaticRedirections</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.maxautomaticredirections) | <span data-ttu-id="41313-251">Obtient ou définit le nombre maximal de réponses de redirection qui `HttpClient` instances doivent suivre.</span><span class="sxs-lookup"><span data-stu-id="41313-251">Gets or sets the maximum number of redirect responses that `HttpClient` instances should follow.</span></span> | <span data-ttu-id="41313-252">7</span><span class="sxs-lookup"><span data-stu-id="41313-252">7</span></span> |

<span data-ttu-id="41313-253">Créer le `WebApplicationFactoryClientOptions` classe et transmettez-le à la [createclient utile](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) (méthode) (par défaut de valeurs sont affichées dans l’exemple de code) :</span><span class="sxs-lookup"><span data-stu-id="41313-253">Create the `WebApplicationFactoryClientOptions` class and pass it to the [CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) method (default values are shown in the code example):</span></span>

```csharp
// Default client option values are shown
var clientOptions = new WebApplicationFactoryClientOptions();
clientOptions.AllowAutoRedirect = true;
clientOptions.BaseAddress = new Uri("http://localhost");
clientOptions.HandleCookies = true;
clientOptions.MaxAutomaticRedirections = 7;

_client = _factory.CreateClient(clientOptions);
```

## <a name="inject-mock-services"></a><span data-ttu-id="41313-254">Injecter des services fictifs</span><span class="sxs-lookup"><span data-stu-id="41313-254">Inject mock services</span></span>

<span data-ttu-id="41313-255">Services peuvent être substituées dans un test avec un appel à [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) sur le Générateur de l’hôte.</span><span class="sxs-lookup"><span data-stu-id="41313-255">Services can be overridden in a test with a call to [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) on the host builder.</span></span> <span data-ttu-id="41313-256">**Pour injecter des services fictifs, le st doit avoir un `Startup` classe avec un `Startup.ConfigureServices` (méthode).**</span><span class="sxs-lookup"><span data-stu-id="41313-256">**To inject mock services, the SUT must have a `Startup` class with a `Startup.ConfigureServices` method.**</span></span>

<span data-ttu-id="41313-257">L’exemple st inclut un service délimité qui renvoie un devis.</span><span class="sxs-lookup"><span data-stu-id="41313-257">The sample SUT includes a scoped service that returns a quote.</span></span> <span data-ttu-id="41313-258">Le devis est incorporé dans un champ masqué sur la page d’Index lors de la page d’Index est demandée.</span><span class="sxs-lookup"><span data-stu-id="41313-258">The quote is embedded in a hidden field on the Index page when the Index page is requested.</span></span>

<span data-ttu-id="41313-259">*Services/IQuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="41313-259">*Services/IQuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Services/IQuoteService.cs?name=snippet1)]

<span data-ttu-id="41313-260">*Services/QuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="41313-260">*Services/QuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Services/QuoteService.cs?name=snippet1)]

<span data-ttu-id="41313-261">*Startup.cs* :</span><span class="sxs-lookup"><span data-stu-id="41313-261">*Startup.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet2)]

<span data-ttu-id="41313-262">*Pages/Index.cshtml.cs* :</span><span class="sxs-lookup"><span data-stu-id="41313-262">*Pages/Index.cshtml.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml.cs?name=snippet1&highlight=4,9,20,26)]

<span data-ttu-id="41313-263">*Pages/Index.cs*:</span><span class="sxs-lookup"><span data-stu-id="41313-263">*Pages/Index.cs*:</span></span>

[!code-cshtml[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml?name=snippet_Quote)]

<span data-ttu-id="41313-264">Le balisage suivant est généré lors de l’exécution de l’application st :</span><span class="sxs-lookup"><span data-stu-id="41313-264">The following markup is generated when the SUT app is run:</span></span>

```html
<input id="quote" type="hidden" value="Come on, Sarah. We&#x27;ve an appointment in 
    London, and we&#x27;re already 30,000 years late.">
```

<span data-ttu-id="41313-265">Pour tester l’injection de service et le guillemet dans un test d’intégration, un service factice est injecté dans le st par le test.</span><span class="sxs-lookup"><span data-stu-id="41313-265">To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test.</span></span> <span data-ttu-id="41313-266">Le service factice remplace l’application `QuoteService` avec un service fourni par l’application de test, appelé `TestQuoteService`:</span><span class="sxs-lookup"><span data-stu-id="41313-266">The mock service replaces the app's `QuoteService` with a service provided by the test app, called `TestQuoteService`:</span></span>

<span data-ttu-id="41313-267">*IntegrationTests.IndexPageTests.cs*:</span><span class="sxs-lookup"><span data-stu-id="41313-267">*IntegrationTests.IndexPageTests.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet4)]

<span data-ttu-id="41313-268">`ConfigureTestServices` est appelée, et le service délimité est enregistré :</span><span class="sxs-lookup"><span data-stu-id="41313-268">`ConfigureTestServices` is called, and the scoped service is registered:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet5&highlight=7-10,17,20-21)]

<span data-ttu-id="41313-269">Le balisage généré pendant l’exécution du test reflète le texte de devis fourni par `TestQuoteService`, par conséquent, l’assertion réussit :</span><span class="sxs-lookup"><span data-stu-id="41313-269">The markup produced during the test's execution reflects the quote text supplied by `TestQuoteService`, thus the assertion passes:</span></span>

```html
<input id="quote" type="hidden" value="Something&#x27;s interfering with time, 
    Mr. Scarman, and time is my business.">
```

## <a name="how-the-test-infrastructure-infers-the-app-content-root-path"></a><span data-ttu-id="41313-270">Comment l’infrastructure de test déduit le chemin d’accès de la racine de contenu application</span><span class="sxs-lookup"><span data-stu-id="41313-270">How the test infrastructure infers the app content root path</span></span>

<span data-ttu-id="41313-271">Le `WebApplicationFactory` constructeur déduit le chemin d’accès de la racine de contenu application en recherchant un [WebApplicationFactoryContentRootAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) sur l’assembly contenant les tests d’intégration avec une clé égale à la `TEntryPoint` assembly `System.Reflection.Assembly.FullName`.</span><span class="sxs-lookup"><span data-stu-id="41313-271">The `WebApplicationFactory` constructor infers the app content root path by searching for a [WebApplicationFactoryContentRootAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) on the assembly containing the integration tests with a key equal to the `TEntryPoint` assembly `System.Reflection.Assembly.FullName`.</span></span> <span data-ttu-id="41313-272">Dans le cas où un attribut avec la clé correcte n’est pas trouvé, `WebApplicationFactory` revient à la recherche d’un fichier solution ( *\*.sln*) et ajoute le `TEntryPoint` nom de l’assembly dans le répertoire de solution.</span><span class="sxs-lookup"><span data-stu-id="41313-272">In case an attribute with the correct key isn't found, `WebApplicationFactory` falls back to searching for a solution file (*\*.sln*) and appends the `TEntryPoint` assembly name to the solution directory.</span></span> <span data-ttu-id="41313-273">Le répertoire racine d’application (le chemin d’accès racine de contenu) permet de détecter des vues et des fichiers de contenu.</span><span class="sxs-lookup"><span data-stu-id="41313-273">The app root directory (the content root path) is used to discover views and content files.</span></span>

<span data-ttu-id="41313-274">Dans la plupart des cas, il n’est pas nécessaire de définir explicitement la racine de contenu de l’application, car la logique de recherche recherche généralement la racine de contenu appropriée lors de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="41313-274">In most cases, it isn't necessary to explicitly set the app content root, as the search logic usually finds the correct content root at runtime.</span></span> <span data-ttu-id="41313-275">Dans des scénarios particuliers où la racine de contenu n’est pas trouvée à l’aide de l’algorithme de recherche intégrées, l’application de contenu racine peut être spécifiée explicitement, ou à l’aide d’une logique personnalisée.</span><span class="sxs-lookup"><span data-stu-id="41313-275">In special scenarios where the content root isn't found using the built-in search algorithm, the app content root can be specified explicitly or by using custom logic.</span></span> <span data-ttu-id="41313-276">Pour définir la racine de contenu d’application dans ces scénarios, appelez le `UseSolutionRelativeContentRoot` méthode d’extension à partir de la [Microsoft.AspNetCore.TestHost](https://www.nuget.org/packages/Microsoft.AspNetCore.TestHost) package.</span><span class="sxs-lookup"><span data-stu-id="41313-276">To set the app content root in those scenarios, call the `UseSolutionRelativeContentRoot` extension method from the [Microsoft.AspNetCore.TestHost](https://www.nuget.org/packages/Microsoft.AspNetCore.TestHost) package.</span></span> <span data-ttu-id="41313-277">Fournissez le chemin d’accès relatif de la solution et le modèle de nom ou glob du fichier solution facultatif (par défaut = `*.sln`).</span><span class="sxs-lookup"><span data-stu-id="41313-277">Supply the solution's relative path and optional solution file name or glob pattern (default = `*.sln`).</span></span>

<span data-ttu-id="41313-278">Appelez le [UseSolutionRelativeContentRoot](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.usesolutionrelativecontentroot) extension à l’aide de méthode *un* des approches suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-278">Call the [UseSolutionRelativeContentRoot](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.usesolutionrelativecontentroot) extension method using *ONE* of the following approaches:</span></span>

* <span data-ttu-id="41313-279">Lors de la configuration des classes de test avec `WebApplicationFactory`, fournir une configuration personnalisée avec le [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder):</span><span class="sxs-lookup"><span data-stu-id="41313-279">When configuring test classes with `WebApplicationFactory`, provide a custom configuration with the [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder):</span></span>

   ```csharp
   public IndexPageTests(
       WebApplicationFactory<RazorPagesProject.Startup> factory)
   {
       var _factory = factory.WithWebHostBuilder(builder =>
       {
           builder.UseSolutionRelativeContentRoot("<SOLUTION-RELATIVE-PATH>");

           ...
       });
   }
   ```

* <span data-ttu-id="41313-280">Lors de la configuration des classes de test avec un personnalisé `WebApplicationFactory`, héritent `WebApplicationFactory` et remplacer [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost):</span><span class="sxs-lookup"><span data-stu-id="41313-280">When configuring test classes with a custom `WebApplicationFactory`, inherit from `WebApplicationFactory` and override [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost):</span></span>

   ```csharp
   public class CustomWebApplicationFactory<TStartup>
       : WebApplicationFactory<RazorPagesProject.Startup>
   {
       protected override void ConfigureWebHost(IWebHostBuilder builder)
       {
           builder.ConfigureServices(services =>
           {
               builder.UseSolutionRelativeContentRoot("<SOLUTION-RELATIVE-PATH>");

               ...
           });
       }
   }
   ```

## <a name="disable-shadow-copying"></a><span data-ttu-id="41313-281">Désactiver les clichés instantanés</span><span class="sxs-lookup"><span data-stu-id="41313-281">Disable shadow copying</span></span>

<span data-ttu-id="41313-282">Clichés instantanés entraîne les tests à exécuter dans un autre répertoire que le répertoire de sortie.</span><span class="sxs-lookup"><span data-stu-id="41313-282">Shadow copying causes the tests to execute in a different directory than the output directory.</span></span> <span data-ttu-id="41313-283">Pour les tests fonctionne correctement, les copies fantômes doivent être désactivée.</span><span class="sxs-lookup"><span data-stu-id="41313-283">For tests to work properly, shadow copying must be disabled.</span></span> <span data-ttu-id="41313-284">Le [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) utilise xUnit et désactive les clichés instantanés pour xUnit en incluant un *xunit.runner.json* fichier avec le paramètre de configuration est correcte.</span><span class="sxs-lookup"><span data-stu-id="41313-284">The [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) uses xUnit and disables shadow copying for xUnit by including an *xunit.runner.json* file with the correct configuration setting.</span></span> <span data-ttu-id="41313-285">Pour plus d’informations, consultez [configuration xUnit avec JSON](https://xunit.github.io/docs/configuring-with-json.html).</span><span class="sxs-lookup"><span data-stu-id="41313-285">For more information, see [Configuring xUnit with JSON](https://xunit.github.io/docs/configuring-with-json.html).</span></span>

<span data-ttu-id="41313-286">Ajouter le *xunit.runner.json* fichier à la racine du projet de test avec le contenu suivant :</span><span class="sxs-lookup"><span data-stu-id="41313-286">Add the *xunit.runner.json* file to root of the test project with the following content:</span></span>

```json
{
  "shadowCopy": false
}
```

## <a name="disposal-of-objects"></a><span data-ttu-id="41313-287">Suppression d’objets</span><span class="sxs-lookup"><span data-stu-id="41313-287">Disposal of objects</span></span>

<span data-ttu-id="41313-288">Après les tests de la `IClassFixture` implémentation sont exécutées, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) et [HttpClient](/dotnet/api/system.net.http.httpclient) sont supprimés lorsque xUnit supprime le [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) .</span><span class="sxs-lookup"><span data-stu-id="41313-288">After the tests of the `IClassFixture` implementation are executed, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) and [HttpClient](/dotnet/api/system.net.http.httpclient) are disposed when xUnit disposes of the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1).</span></span> <span data-ttu-id="41313-289">Si les objets instanciés par le développeur besoin de disposition, les supprimer dans le `IClassFixture` implémentation.</span><span class="sxs-lookup"><span data-stu-id="41313-289">If objects instantiated by the developer require disposal, dispose of them in the `IClassFixture` implementation.</span></span> <span data-ttu-id="41313-290">Pour plus d’informations, consultez [implémentation d’une méthode Dispose](/dotnet/standard/garbage-collection/implementing-dispose).</span><span class="sxs-lookup"><span data-stu-id="41313-290">For more information, see [Implementing a Dispose method](/dotnet/standard/garbage-collection/implementing-dispose).</span></span>

## <a name="integration-tests-sample"></a><span data-ttu-id="41313-291">Exemple de tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="41313-291">Integration tests sample</span></span>

<span data-ttu-id="41313-292">Le [exemple d’application](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) se compose de deux applications :</span><span class="sxs-lookup"><span data-stu-id="41313-292">The [sample app](https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is composed of two apps:</span></span>

| <span data-ttu-id="41313-293">Application</span><span class="sxs-lookup"><span data-stu-id="41313-293">App</span></span> | <span data-ttu-id="41313-294">Répertoire du projet</span><span class="sxs-lookup"><span data-stu-id="41313-294">Project directory</span></span> | <span data-ttu-id="41313-295">Description</span><span class="sxs-lookup"><span data-stu-id="41313-295">Description</span></span> |
| --- | ----------------- | ----------- |
| <span data-ttu-id="41313-296">Application de message (le st)</span><span class="sxs-lookup"><span data-stu-id="41313-296">Message app (the SUT)</span></span> | <span data-ttu-id="41313-297">*src/RazorPagesProject*</span><span class="sxs-lookup"><span data-stu-id="41313-297">*src/RazorPagesProject*</span></span> | <span data-ttu-id="41313-298">Autorise un utilisateur à ajouter, supprimer une, supprimer toutes et analyser les messages.</span><span class="sxs-lookup"><span data-stu-id="41313-298">Allows a user to add, delete one, delete all, and analyze messages.</span></span> |
| <span data-ttu-id="41313-299">Application de test</span><span class="sxs-lookup"><span data-stu-id="41313-299">Test app</span></span> | <span data-ttu-id="41313-300">*tests/RazorPagesProject.Tests*</span><span class="sxs-lookup"><span data-stu-id="41313-300">*tests/RazorPagesProject.Tests*</span></span> | <span data-ttu-id="41313-301">Utilisé pour le test d’intégration le st.</span><span class="sxs-lookup"><span data-stu-id="41313-301">Used to integration test the SUT.</span></span> |

<span data-ttu-id="41313-302">Les tests peuvent être exécutés en utilisant les fonctionnalités de test intégré d’un IDE, comme [Visual Studio](https://visualstudio.microsoft.com).</span><span class="sxs-lookup"><span data-stu-id="41313-302">The tests can be run using the built-in test features of an IDE, such as [Visual Studio](https://visualstudio.microsoft.com).</span></span> <span data-ttu-id="41313-303">Si vous utilisez [Visual Studio Code](https://code.visualstudio.com/) ou la ligne de commande, exécutez la commande suivante à une invite de commandes dans le *tests/RazorPagesProject.Tests* directory :</span><span class="sxs-lookup"><span data-stu-id="41313-303">If using [Visual Studio Code](https://code.visualstudio.com/) or the command line, execute the following command at a command prompt in the *tests/RazorPagesProject.Tests* directory:</span></span>

```console
dotnet test
```

### <a name="message-app-sut-organization"></a><span data-ttu-id="41313-304">Organisation de l’application (ST) de message</span><span class="sxs-lookup"><span data-stu-id="41313-304">Message app (SUT) organization</span></span>

<span data-ttu-id="41313-305">Le st est un système de message de Pages Razor avec les caractéristiques suivantes :</span><span class="sxs-lookup"><span data-stu-id="41313-305">The SUT is a Razor Pages message system with the following characteristics:</span></span>

* <span data-ttu-id="41313-306">La page d’Index de l’application (*pages/index.cshtml* et *Pages/Index.cshtml.cs*) fournit une interface utilisateur et la page des méthodes de modèle de contrôle de l’ajout, suppression et analyse des messages (mots moyenne par message) .</span><span class="sxs-lookup"><span data-stu-id="41313-306">The Index page of the app (*Pages/Index.cshtml* and *Pages/Index.cshtml.cs*) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</span></span>
* <span data-ttu-id="41313-307">Un message est décrite par le `Message` classe (*Data/Message.cs*) avec deux propriétés : `Id` (clé) et `Text` (message).</span><span class="sxs-lookup"><span data-stu-id="41313-307">A message is described by the `Message` class (*Data/Message.cs*) with two properties: `Id` (key) and `Text` (message).</span></span> <span data-ttu-id="41313-308">Le `Text` propriété est requise et limitée à 200 caractères.</span><span class="sxs-lookup"><span data-stu-id="41313-308">The `Text` property is required and limited to 200 characters.</span></span>
* <span data-ttu-id="41313-309">Les messages sont stockés à l’aide de [base de données en mémoire d’Entity Framework](/ef/core/providers/in-memory/)&#8224;.</span><span class="sxs-lookup"><span data-stu-id="41313-309">Messages are stored using [Entity Framework's in-memory database](/ef/core/providers/in-memory/)&#8224;.</span></span>
* <span data-ttu-id="41313-310">L’application contient une couche d’accès aux données (DAL) dans sa classe de contexte de base de données, `AppDbContext` (*Data/AppDbContext.cs*).</span><span class="sxs-lookup"><span data-stu-id="41313-310">The app contains a data access layer (DAL) in its database context class, `AppDbContext` (*Data/AppDbContext.cs*).</span></span>
* <span data-ttu-id="41313-311">Si la base de données est vide sur le démarrage de l’application, la banque de messages est initialisée avec trois messages.</span><span class="sxs-lookup"><span data-stu-id="41313-311">If the database is empty on app startup, the message store is initialized with three messages.</span></span>
* <span data-ttu-id="41313-312">L’application comprend un `/SecurePage` qui est accessible uniquement par un utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="41313-312">The app includes a `/SecurePage` that can only be accessed by an authenticated user.</span></span>

<span data-ttu-id="41313-313">&#8224;La rubrique EF, [Test avec InMemory](/ef/core/miscellaneous/testing/in-memory), explique comment utiliser une base de données en mémoire pour les tests avec MSTest.</span><span class="sxs-lookup"><span data-stu-id="41313-313">&#8224;The EF topic, [Test with InMemory](/ef/core/miscellaneous/testing/in-memory), explains how to use an in-memory database for tests with MSTest.</span></span> <span data-ttu-id="41313-314">Cette rubrique utilise le [xUnit](https://xunit.github.io/) infrastructure de test.</span><span class="sxs-lookup"><span data-stu-id="41313-314">This topic uses the [xUnit](https://xunit.github.io/) test framework.</span></span> <span data-ttu-id="41313-315">Concepts des tests et des implémentations de test entre les frameworks de test différentes sont similaires mais pas identiques.</span><span class="sxs-lookup"><span data-stu-id="41313-315">Test concepts and test implementations across different test frameworks are similar but not identical.</span></span>

<span data-ttu-id="41313-316">Bien que l’application n’utilise pas le modèle de référentiel et n’est pas un exemple effectif de la [modèle unité de travail (UoW)](https://martinfowler.com/eaaCatalog/unitOfWork.html), Pages Razor prend en charge ces modèles de développement.</span><span class="sxs-lookup"><span data-stu-id="41313-316">Although the app doesn't use the repository pattern and isn't an effective example of the [Unit of Work (UoW) pattern](https://martinfowler.com/eaaCatalog/unitOfWork.html), Razor Pages supports these patterns of development.</span></span> <span data-ttu-id="41313-317">Pour plus d’informations, consultez [conception de la couche de persistance d’infrastructure](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) et [logique du contrôleur de Test](/aspnet/core/mvc/controllers/testing) (l’exemple implémente le modèle de référentiel).</span><span class="sxs-lookup"><span data-stu-id="41313-317">For more information, see [Designing the infrastructure persistence layer](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) and [Test controller logic](/aspnet/core/mvc/controllers/testing) (the sample implements the repository pattern).</span></span>

### <a name="test-app-organization"></a><span data-ttu-id="41313-318">Organisation de l’application de test</span><span class="sxs-lookup"><span data-stu-id="41313-318">Test app organization</span></span>

<span data-ttu-id="41313-319">L’application de test est une application console à l’intérieur de la *tests/RazorPagesProject.Tests* directory.</span><span class="sxs-lookup"><span data-stu-id="41313-319">The test app is a console app inside the *tests/RazorPagesProject.Tests* directory.</span></span>

| <span data-ttu-id="41313-320">Répertoire d’application de test</span><span class="sxs-lookup"><span data-stu-id="41313-320">Test app directory</span></span> | <span data-ttu-id="41313-321">Description</span><span class="sxs-lookup"><span data-stu-id="41313-321">Description</span></span> |
| ------------------ | ----------- |
| <span data-ttu-id="41313-322">*BasicTests*</span><span class="sxs-lookup"><span data-stu-id="41313-322">*BasicTests*</span></span> | <span data-ttu-id="41313-323">*BasicTests.cs* contient des méthodes de test pour le routage, l’accès à une page sécurisée par un utilisateur non authentifié et obtenir un profil d’utilisateur GitHub et vérification de la connexion de l’utilisateur du profil.</span><span class="sxs-lookup"><span data-stu-id="41313-323">*BasicTests.cs* contains test methods for routing, accessing a secure page by an unauthenticated user, and obtaining a GitHub user profile and checking the profile's user login.</span></span> |
| <span data-ttu-id="41313-324">*IntegrationTests*</span><span class="sxs-lookup"><span data-stu-id="41313-324">*IntegrationTests*</span></span> | <span data-ttu-id="41313-325">*IndexPageTests.cs* contient les tests d’intégration pour la page d’Index à l’aide personnalisée `WebApplicationFactory` classe.</span><span class="sxs-lookup"><span data-stu-id="41313-325">*IndexPageTests.cs* contains the integration tests for the Index page using custom `WebApplicationFactory` class.</span></span> |
| <span data-ttu-id="41313-326">*Programmes d’assistance/utilitaires*</span><span class="sxs-lookup"><span data-stu-id="41313-326">*Helpers/Utilities*</span></span> | <ul><li><span data-ttu-id="41313-327">*Utilities.cs* contient le `InitializeDbForTests` méthode utilisée pour amorcer la base de données de test.</span><span class="sxs-lookup"><span data-stu-id="41313-327">*Utilities.cs* contains the `InitializeDbForTests` method used to seed the database with test data.</span></span></li><li><span data-ttu-id="41313-328">*HtmlHelpers.cs* fournit une méthode pour retourner un AngleSharp `IHtmlDocument` pour une utilisation par les méthodes de test.</span><span class="sxs-lookup"><span data-stu-id="41313-328">*HtmlHelpers.cs* provides a method to return an AngleSharp `IHtmlDocument` for use by the test methods.</span></span></li><li><span data-ttu-id="41313-329">*HttpClientExtensions.cs* fournissent des surcharges pour `SendAsync` pour soumettre des demandes sur le st.</span><span class="sxs-lookup"><span data-stu-id="41313-329">*HttpClientExtensions.cs* provide overloads for `SendAsync` to submit requests to the SUT.</span></span></li></ul> |

<span data-ttu-id="41313-330">L’infrastructure de test est [xUnit](https://xunit.github.io/).</span><span class="sxs-lookup"><span data-stu-id="41313-330">The test framework is [xUnit](https://xunit.github.io/).</span></span> <span data-ttu-id="41313-331">Tests d’intégration sont effectués à l’aide de la [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), qui inclut le [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span><span class="sxs-lookup"><span data-stu-id="41313-331">Integration tests are conducted using the [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), which includes the [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span></span> <span data-ttu-id="41313-332">Étant donné que le [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package est utilisé pour configurer le serveur hôte et de test de test, le `TestHost` et `TestServer` packages ne nécessitent pas de références de package directement dans le fichier projet de l’application de test ou configuration de développeur dans l’application de test.</span><span class="sxs-lookup"><span data-stu-id="41313-332">Because the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package is used to configure the test host and test server, the `TestHost` and `TestServer` packages don't require direct package references in the test app's project file or developer configuration in the test app.</span></span>

<span data-ttu-id="41313-333">**L’amorçage de la base de données de test**</span><span class="sxs-lookup"><span data-stu-id="41313-333">**Seeding the database for testing**</span></span>

<span data-ttu-id="41313-334">Tests d’intégration nécessitent généralement un petit jeu de données dans la base de données avant l’exécution du test.</span><span class="sxs-lookup"><span data-stu-id="41313-334">Integration tests usually require a small dataset in the database prior to the test execution.</span></span> <span data-ttu-id="41313-335">Par exemple, une suppression tester des appels pour une suppression de l’enregistrement de base de données, la base de données doit avoir au moins un enregistrement pour la demande de suppression réussisse.</span><span class="sxs-lookup"><span data-stu-id="41313-335">For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</span></span>

<span data-ttu-id="41313-336">L’exemple d’application amorce la base de données avec trois messages dans *Utilities.cs* que les tests peuvent utiliser lorsqu’ils s’exécutent :</span><span class="sxs-lookup"><span data-stu-id="41313-336">The sample app seeds the database with three messages in *Utilities.cs* that tests can use when they execute:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/Helpers/Utilities.cs?name=snippet1)]

## <a name="additional-resources"></a><span data-ttu-id="41313-337">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="41313-337">Additional resources</span></span>

* [<span data-ttu-id="41313-338">Tests unitaires</span><span class="sxs-lookup"><span data-stu-id="41313-338">Unit tests</span></span>](/dotnet/articles/core/testing/unit-testing-with-dotnet-test)
* [<span data-ttu-id="41313-339">Tests unitaires Pages Razor</span><span class="sxs-lookup"><span data-stu-id="41313-339">Razor Pages unit tests</span></span>](xref:test/razor-pages-tests)
* [<span data-ttu-id="41313-340">Intergiciel (middleware)</span><span class="sxs-lookup"><span data-stu-id="41313-340">Middleware</span></span>](xref:fundamentals/middleware/index)
* [<span data-ttu-id="41313-341">Contrôleurs de test</span><span class="sxs-lookup"><span data-stu-id="41313-341">Test controllers</span></span>](xref:mvc/controllers/testing)
