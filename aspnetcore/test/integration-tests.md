---
title: Tests d’intégration dans ASP.NET Core
author: rick-anderson
description: Découvrez comment les tests d’intégration garantissent le bon fonctionnement des composants d’une application au niveau de l’infrastructure, notamment la base de données, le système de fichiers et le réseau.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 01/06/2019
uid: test/integration-tests
ms.openlocfilehash: 414e47b9c5a1c843755bd79d313f503b554945db
ms.sourcegitcommit: f7886fd2e219db9d7ce27b16c0dc5901e658d64e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/06/2020
ms.locfileid: "78664695"
---
# <a name="integration-tests-in-aspnet-core"></a><span data-ttu-id="d5776-103">Tests d’intégration dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="d5776-103">Integration tests in ASP.NET Core</span></span>

<span data-ttu-id="d5776-104">Par [Javier Calvarro Nelson](https://github.com/javiercn), Steve [Smith](https://ardalis.com/), et Jos van [der Til](https://jvandertil.nl)</span><span class="sxs-lookup"><span data-stu-id="d5776-104">By [Javier Calvarro Nelson](https://github.com/javiercn), [Steve Smith](https://ardalis.com/), and [Jos van der Til](https://jvandertil.nl)</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="d5776-105">Les tests d’intégration garantissent que les composants d’une application fonctionnent correctement à un niveau qui inclut l’infrastructure de support de l’application, comme la base de données, le système de fichiers et le réseau.</span><span class="sxs-lookup"><span data-stu-id="d5776-105">Integration tests ensure that an app's components function correctly at a level that includes the app's supporting infrastructure, such as the database, file system, and network.</span></span> <span data-ttu-id="d5776-106">ASP.NET Core prend en charge les tests d’intégration à l’aide d’un cadre de test unitaire avec un hébergeur de test et un serveur de test en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d5776-106">ASP.NET Core supports integration tests using a unit test framework with a test web host and an in-memory test server.</span></span>

<span data-ttu-id="d5776-107">Ce sujet suppose une compréhension de base des tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="d5776-107">This topic assumes a basic understanding of unit tests.</span></span> <span data-ttu-id="d5776-108">S’il n’est pas familier avec les concepts de test, voir le [test unitaire dans .NET Core et .NET Standard](/dotnet/core/testing/) sujet et son contenu lié.</span><span class="sxs-lookup"><span data-stu-id="d5776-108">If unfamiliar with test concepts, see the [Unit Testing in .NET Core and .NET Standard](/dotnet/core/testing/) topic and its linked content.</span></span>

<span data-ttu-id="d5776-109">[Afficher ou télécharger le code de l’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([comment télécharger](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="d5776-109">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

<span data-ttu-id="d5776-110">L’application échantillon est une application Razor Pages et suppose une compréhension de base de Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d5776-110">The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages.</span></span> <span data-ttu-id="d5776-111">Si vous n’êtes pas familier avec Razor Pages, voir les sujets suivants:</span><span class="sxs-lookup"><span data-stu-id="d5776-111">If unfamiliar with Razor Pages, see the following topics:</span></span>

* [<span data-ttu-id="d5776-112">Présentation des pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-112">Introduction to Razor Pages</span></span>](xref:razor-pages/index)
* [<span data-ttu-id="d5776-113">Bien démarrer avec les pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-113">Get started with Razor Pages</span></span>](xref:tutorials/razor-pages/razor-pages-start)
* [<span data-ttu-id="d5776-114">Tests unitaires Pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-114">Razor Pages unit tests</span></span>](xref:test/razor-pages-tests)

> [!NOTE]
> <span data-ttu-id="d5776-115">Pour tester les SPA, nous avons recommandé un outil tel que [le sélénium](https://www.seleniumhq.org/), qui peut automatiser un navigateur.</span><span class="sxs-lookup"><span data-stu-id="d5776-115">For testing SPAs, we recommended a tool such as [Selenium](https://www.seleniumhq.org/), which can automate a browser.</span></span>

## <a name="introduction-to-integration-tests"></a><span data-ttu-id="d5776-116">Introduction aux tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="d5776-116">Introduction to integration tests</span></span>

<span data-ttu-id="d5776-117">Les tests d’intégration évaluent les composants d’une application à un niveau plus large que [les tests unitaires.](/dotnet/core/testing/)</span><span class="sxs-lookup"><span data-stu-id="d5776-117">Integration tests evaluate an app's components on a broader level than [unit tests](/dotnet/core/testing/).</span></span> <span data-ttu-id="d5776-118">Les tests unitaires sont utilisés pour tester des composants logiciels isolés, tels que des méthodes de classe individuelles.</span><span class="sxs-lookup"><span data-stu-id="d5776-118">Unit tests are used to test isolated software components, such as individual class methods.</span></span> <span data-ttu-id="d5776-119">Les tests d’intégration confirment que deux composants d’applications ou plus travaillent ensemble pour produire un résultat attendu, y compris éventuellement chaque composant nécessaire pour traiter pleinement une demande.</span><span class="sxs-lookup"><span data-stu-id="d5776-119">Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</span></span>

<span data-ttu-id="d5776-120">Ces tests plus larges sont utilisés pour tester l’infrastructure de l’application et l’ensemble du cadre, y compris souvent les composants suivants :</span><span class="sxs-lookup"><span data-stu-id="d5776-120">These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</span></span>

* <span data-ttu-id="d5776-121">Base de données</span><span class="sxs-lookup"><span data-stu-id="d5776-121">Database</span></span>
* <span data-ttu-id="d5776-122">Système de fichiers</span><span class="sxs-lookup"><span data-stu-id="d5776-122">File system</span></span>
* <span data-ttu-id="d5776-123">Appliances réseau</span><span class="sxs-lookup"><span data-stu-id="d5776-123">Network appliances</span></span>
* <span data-ttu-id="d5776-124">Pipeline de demande-réponse</span><span class="sxs-lookup"><span data-stu-id="d5776-124">Request-response pipeline</span></span>

<span data-ttu-id="d5776-125">Les tests unitaires utilisent des composants fabriqués, connus sous le nom de faux ou *d’objets* *simulés,* à la place de composants d’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="d5776-125">Unit tests use fabricated components, known as *fakes* or *mock objects*, in place of infrastructure components.</span></span>

<span data-ttu-id="d5776-126">Contrairement aux tests unitaires, les tests d’intégration :</span><span class="sxs-lookup"><span data-stu-id="d5776-126">In contrast to unit tests, integration tests:</span></span>

* <span data-ttu-id="d5776-127">Utilisez les composants réels que l’application utilise dans la production.</span><span class="sxs-lookup"><span data-stu-id="d5776-127">Use the actual components that the app uses in production.</span></span>
* <span data-ttu-id="d5776-128">Exiger plus de code et de traitement des données.</span><span class="sxs-lookup"><span data-stu-id="d5776-128">Require more code and data processing.</span></span>
* <span data-ttu-id="d5776-129">Il faut plus de temps pour courir.</span><span class="sxs-lookup"><span data-stu-id="d5776-129">Take longer to run.</span></span>

<span data-ttu-id="d5776-130">Par conséquent, limitez l’utilisation des tests d’intégration aux scénarios d’infrastructure les plus importants.</span><span class="sxs-lookup"><span data-stu-id="d5776-130">Therefore, limit the use of integration tests to the most important infrastructure scenarios.</span></span> <span data-ttu-id="d5776-131">Si un comportement peut être testé à l’aide d’un test unitaire ou d’un test d’intégration, choisissez le test unitaire.</span><span class="sxs-lookup"><span data-stu-id="d5776-131">If a behavior can be tested using either a unit test or an integration test, choose the unit test.</span></span>

> [!TIP]
> <span data-ttu-id="d5776-132">N’écrivez pas de tests d’intégration pour chaque permutation possible des données et n’ez pas l’accès aux fichiers avec des bases de données et des systèmes de fichiers.</span><span class="sxs-lookup"><span data-stu-id="d5776-132">Don't write integration tests for every possible permutation of data and file access with databases and file systems.</span></span> <span data-ttu-id="d5776-133">Indépendamment du nombre d’endroits dans une application interagissent avec les bases de données et les systèmes de fichiers, un ensemble ciblé de tests de lecture, d’écriture, de mise à jour et de suppression des tests d’intégration sont généralement capables de tester adéquatement les composants des bases de données et des fichiers.</span><span class="sxs-lookup"><span data-stu-id="d5776-133">Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components.</span></span> <span data-ttu-id="d5776-134">Utilisez des tests unitaires pour des tests de routine de la logique de la méthode qui interagissent avec ces composants.</span><span class="sxs-lookup"><span data-stu-id="d5776-134">Use unit tests for routine tests of method logic that interact with these components.</span></span> <span data-ttu-id="d5776-135">Dans les tests unitaires, l’utilisation de faux/mocks d’infrastructure entraîne une exécution plus rapide des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-135">In unit tests, the use of infrastructure fakes/mocks result in faster test execution.</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-136">Dans les discussions sur les tests d’intégration, le projet testé est souvent appelé le *système en cours d’essai*, ou "SUT" pour faire court.</span><span class="sxs-lookup"><span data-stu-id="d5776-136">In discussions of integration tests, the tested project is frequently called the *System Under Test*, or "SUT" for short.</span></span>
>
> <span data-ttu-id="d5776-137">*"SUT" est utilisé tout au long de ce sujet pour se référer à l’application ASP.NET Core testée.*</span><span class="sxs-lookup"><span data-stu-id="d5776-137">*"SUT" is used throughout this topic to refer to the tested ASP.NET Core app.*</span></span>

## <a name="aspnet-core-integration-tests"></a><span data-ttu-id="d5776-138">tests d’intégration de base ASP.NET</span><span class="sxs-lookup"><span data-stu-id="d5776-138">ASP.NET Core integration tests</span></span>

<span data-ttu-id="d5776-139">Les tests d’intégration dans ASP.NET Core exigent ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="d5776-139">Integration tests in ASP.NET Core require the following:</span></span>

* <span data-ttu-id="d5776-140">Un projet de test est utilisé pour contenir et exécuter les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-140">A test project is used to contain and execute the tests.</span></span> <span data-ttu-id="d5776-141">Le projet d’essai a une référence au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-141">The test project has a reference to the SUT.</span></span>
* <span data-ttu-id="d5776-142">Le projet de test crée un hébergeur de test pour le SUT et utilise un client serveur de test pour traiter les demandes et les réponses avec le SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-142">The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</span></span>
* <span data-ttu-id="d5776-143">Un coureur de test est utilisé pour exécuter les tests et signaler les résultats des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-143">A test runner is used to execute the tests and report the test results.</span></span>

<span data-ttu-id="d5776-144">Les tests d’intégration suivent une séquence d’événements qui comprennent les étapes *habituelles d’arrangement,* *d’acte*et *d’essai d’Assert* :</span><span class="sxs-lookup"><span data-stu-id="d5776-144">Integration tests follow a sequence of events that include the usual *Arrange*, *Act*, and *Assert* test steps:</span></span>

1. <span data-ttu-id="d5776-145">L’hébergeur du SUT est configuré.</span><span class="sxs-lookup"><span data-stu-id="d5776-145">The SUT's web host is configured.</span></span>
1. <span data-ttu-id="d5776-146">Un client serveur de test est créé pour soumettre des demandes à l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-146">A test server client is created to submit requests to the app.</span></span>
1. <span data-ttu-id="d5776-147">*L’étape de* test Arrange est exécutée : l’application de test prépare une demande.</span><span class="sxs-lookup"><span data-stu-id="d5776-147">The *Arrange* test step is executed: The test app prepares a request.</span></span>
1. <span data-ttu-id="d5776-148">L’étape de test *de la Loi* est exécutée : le client soumet la demande et reçoit la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5776-148">The *Act* test step is executed: The client submits the request and receives the response.</span></span>
1. <span data-ttu-id="d5776-149">*L’étape* de test Assert est exécutée : la réponse *réelle* est validée en tant que *passage* ou *échec* en fonction d’une réponse *attendue.*</span><span class="sxs-lookup"><span data-stu-id="d5776-149">The *Assert* test step is executed: The *actual* response is validated as a *pass* or *fail* based on an *expected* response.</span></span>
1. <span data-ttu-id="d5776-150">Le processus se poursuit jusqu’à ce que tous les tests soient exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-150">The process continues until all of the tests are executed.</span></span>
1. <span data-ttu-id="d5776-151">Les résultats des tests sont communiqués.</span><span class="sxs-lookup"><span data-stu-id="d5776-151">The test results are reported.</span></span>

<span data-ttu-id="d5776-152">Habituellement, l’hébergeur de test est configuré différemment de l’hébergeur Web normal de l’application pour les essais.</span><span class="sxs-lookup"><span data-stu-id="d5776-152">Usually, the test web host is configured differently than the app's normal web host for the test runs.</span></span> <span data-ttu-id="d5776-153">Par exemple, une base de données différente ou différents paramètres d’application peuvent être utilisés pour les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-153">For example, a different database or different app settings might be used for the tests.</span></span>

<span data-ttu-id="d5776-154">Les composants d’infrastructure, tels que l’hébergeur de test et le serveur de test en mémoire ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), sont fournis ou gérés par le package [Microsoft.AspNetCore.Mvc.Testing.](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing)</span><span class="sxs-lookup"><span data-stu-id="d5776-154">Infrastructure components, such as the test web host and in-memory test server ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), are provided or managed by the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package.</span></span> <span data-ttu-id="d5776-155">L’utilisation de ce paquet simplifie la création et l’exécution des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-155">Use of this package streamlines test creation and execution.</span></span>

<span data-ttu-id="d5776-156">Le `Microsoft.AspNetCore.Mvc.Testing` paquet s’occupe des tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-156">The `Microsoft.AspNetCore.Mvc.Testing` package handles the following tasks:</span></span>

* <span data-ttu-id="d5776-157">Copies du fichier des dépendances (*.deps*) de la SUT dans l’annuaire *des bacs* du projet d’essai.</span><span class="sxs-lookup"><span data-stu-id="d5776-157">Copies the dependencies file (*.deps*) from the SUT into the test project's *bin* directory.</span></span>
* <span data-ttu-id="d5776-158">Définit la racine de [contenu](xref:fundamentals/index#content-root) à la racine du projet du SUT de sorte que des fichiers statiques et des pages/vues sont trouvés lorsque les tests sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-158">Sets the [content root](xref:fundamentals/index#content-root) to the SUT's project root so that static files and pages/views are found when the tests are executed.</span></span>
* <span data-ttu-id="d5776-159">Fournit la classe [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) pour rationaliser bootstrapping le SUT avec `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="d5776-159">Provides the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) class to streamline bootstrapping the SUT with `TestServer`.</span></span>

<span data-ttu-id="d5776-160">La documentation [des tests unitaire](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) décrit comment mettre en place un projet d’essai et un coureur d’essai, ainsi que des instructions détaillées sur la façon d’exécuter des tests et des recommandations sur la façon de nommer les tests et les classes de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-160">The [unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-161">Lors de la création d’un projet de test pour une application, séparez les tests unitaires des tests d’intégration dans différents projets.</span><span class="sxs-lookup"><span data-stu-id="d5776-161">When creating a test project for an app, separate the unit tests from the integration tests into different projects.</span></span> <span data-ttu-id="d5776-162">Cela permet de s’assurer que les composants d’analyse d’infrastructure ne sont pas accidentellement inclus dans les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="d5776-162">This helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</span></span> <span data-ttu-id="d5776-163">La séparation des tests d’unité et d’intégration permet également de contrôler l’ensemble des tests qui sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-163">Separation of unit and integration tests also allows control over which set of tests are run.</span></span>

<span data-ttu-id="d5776-164">Il n’y a pratiquement aucune différence entre la configuration pour les tests des applications Razor Pages et les applications MVC.</span><span class="sxs-lookup"><span data-stu-id="d5776-164">There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps.</span></span> <span data-ttu-id="d5776-165">La seule différence réside dans la façon dont les tests sont nommés.</span><span class="sxs-lookup"><span data-stu-id="d5776-165">The only difference is in how the tests are named.</span></span> <span data-ttu-id="d5776-166">Dans une application Razor Pages, les tests des paramètres de page sont `IndexPageTests` généralement nommés d’après la classe de modèle de page (par exemple, pour tester l’intégration des composants pour la page Index).</span><span class="sxs-lookup"><span data-stu-id="d5776-166">In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, `IndexPageTests` to test component integration for the Index page).</span></span> <span data-ttu-id="d5776-167">Dans une application MVC, les tests sont généralement organisés par des classes `HomeControllerTests` de contrôleur et nommés d’après les contrôleurs qu’ils testent (par exemple, pour tester l’intégration des composants pour le contrôleur à domicile).</span><span class="sxs-lookup"><span data-stu-id="d5776-167">In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, `HomeControllerTests` to test component integration for the Home controller).</span></span>

## <a name="test-app-prerequisites"></a><span data-ttu-id="d5776-168">Conditions préalables de l’application de test</span><span class="sxs-lookup"><span data-stu-id="d5776-168">Test app prerequisites</span></span>

<span data-ttu-id="d5776-169">Le projet d’essai doit :</span><span class="sxs-lookup"><span data-stu-id="d5776-169">The test project must:</span></span>

* <span data-ttu-id="d5776-170">Référence du package [Microsoft.AspNetCore.Mvc.Testing.](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing)</span><span class="sxs-lookup"><span data-stu-id="d5776-170">Reference the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package.</span></span>
* <span data-ttu-id="d5776-171">Spécifiez le SDK`<Project Sdk="Microsoft.NET.Sdk.Web">`Web dans le fichier du projet ( ).</span><span class="sxs-lookup"><span data-stu-id="d5776-171">Specify the Web SDK in the project file (`<Project Sdk="Microsoft.NET.Sdk.Web">`).</span></span>

<span data-ttu-id="d5776-172">Ces conditions préalables peuvent être vues dans [l’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span><span class="sxs-lookup"><span data-stu-id="d5776-172">These prerequisites can be seen in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span></span> <span data-ttu-id="d5776-173">Inspectez les *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj.*</span><span class="sxs-lookup"><span data-stu-id="d5776-173">Inspect the *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj* file.</span></span> <span data-ttu-id="d5776-174">L’application d’échantillon utilise le cadre de test [xUnit](https://xunit.github.io/) et la bibliothèque de parser [AngleSharp,](https://anglesharp.github.io/) de sorte que l’application d’échantillon fait également référence :</span><span class="sxs-lookup"><span data-stu-id="d5776-174">The sample app uses the [xUnit](https://xunit.github.io/) test framework and the [AngleSharp](https://anglesharp.github.io/) parser library, so the sample app also references:</span></span>

* [<span data-ttu-id="d5776-175">xunit</span><span class="sxs-lookup"><span data-stu-id="d5776-175">xunit</span></span>](https://www.nuget.org/packages/xunit)
* [<span data-ttu-id="d5776-176">xunit.runner.visualstudio</span><span class="sxs-lookup"><span data-stu-id="d5776-176">xunit.runner.visualstudio</span></span>](https://www.nuget.org/packages/xunit.runner.visualstudio)
* [<span data-ttu-id="d5776-177">AngleSharp (angleSharp)</span><span class="sxs-lookup"><span data-stu-id="d5776-177">AngleSharp</span></span>](https://www.nuget.org/packages/AngleSharp)

<span data-ttu-id="d5776-178">Entity Framework Core est également utilisé dans les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-178">Entity Framework Core is also used in the tests.</span></span> <span data-ttu-id="d5776-179">Les références de l’application:</span><span class="sxs-lookup"><span data-stu-id="d5776-179">The app references:</span></span>

* [<span data-ttu-id="d5776-180">Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore</span><span class="sxs-lookup"><span data-stu-id="d5776-180">Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore)
* [<span data-ttu-id="d5776-181">Microsoft.AspNetCore.Identity.EntityFrameworkCore</span><span class="sxs-lookup"><span data-stu-id="d5776-181">Microsoft.AspNetCore.Identity.EntityFrameworkCore</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.Identity.EntityFrameworkCore)
* [<span data-ttu-id="d5776-182">Microsoft.EntityFrameworkCore</span><span class="sxs-lookup"><span data-stu-id="d5776-182">Microsoft.EntityFrameworkCore</span></span>](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore)
* [<span data-ttu-id="d5776-183">Microsoft.EntityFrameworkCore.InMemory</span><span class="sxs-lookup"><span data-stu-id="d5776-183">Microsoft.EntityFrameworkCore.InMemory</span></span>](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.InMemory)
* [<span data-ttu-id="d5776-184">Microsoft.EntityFrameworkCore.Tools (en anglais seulement)</span><span class="sxs-lookup"><span data-stu-id="d5776-184">Microsoft.EntityFrameworkCore.Tools</span></span>](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Tools)

## <a name="sut-environment"></a><span data-ttu-id="d5776-185">Environnement SUT</span><span class="sxs-lookup"><span data-stu-id="d5776-185">SUT environment</span></span>

<span data-ttu-id="d5776-186">Si [l’environnement](xref:fundamentals/environments) du SUT n’est pas défini, l’environnement est par défaut pour le développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-186">If the SUT's [environment](xref:fundamentals/environments) isn't set, the environment defaults to Development.</span></span>

## <a name="basic-tests-with-the-default-webapplicationfactory"></a><span data-ttu-id="d5776-187">Tests de base avec la webApplicationFactory par défaut</span><span class="sxs-lookup"><span data-stu-id="d5776-187">Basic tests with the default WebApplicationFactory</span></span>

<span data-ttu-id="d5776-188">[WebApplicationFactory\<TEntryPoint>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) est utilisé pour créer un [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) pour les tests d’intégration.</span><span class="sxs-lookup"><span data-stu-id="d5776-188">[WebApplicationFactory\<TEntryPoint>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) is used to create a [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) for the integration tests.</span></span> <span data-ttu-id="d5776-189">`TEntryPoint`est la classe de point d’entrée du SUT, généralement la `Startup` classe.</span><span class="sxs-lookup"><span data-stu-id="d5776-189">`TEntryPoint` is the entry point class of the SUT, usually the `Startup` class.</span></span>

<span data-ttu-id="d5776-190">Les classes de test implémentent une interface *de montage* de classe ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) pour indiquer que la classe contient des tests et fournissent des instances d’objets partagés à travers les tests de la classe.</span><span class="sxs-lookup"><span data-stu-id="d5776-190">Test classes implement a *class fixture* interface ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) to indicate the class contains tests and provide shared object instances across the tests in the class.</span></span>

<span data-ttu-id="d5776-191">La classe `BasicTests`d’essai `WebApplicationFactory` suivante, , utilise le bootstrap le SUT `Get_EndpointsReturnSuccessAndCorrectContentType`et de fournir un [HttpClient](/dotnet/api/system.net.http.httpclient) à une méthode d’essai, .</span><span class="sxs-lookup"><span data-stu-id="d5776-191">The following test class, `BasicTests`, uses the `WebApplicationFactory` to bootstrap the SUT and provide an [HttpClient](/dotnet/api/system.net.http.httpclient) to a test method, `Get_EndpointsReturnSuccessAndCorrectContentType`.</span></span> <span data-ttu-id="d5776-192">La méthode vérifie si le code d’état de réponse est réussi (codes d’état dans la plage 200-299) et l’en-tête `Content-Type` est `text/html; charset=utf-8` pour plusieurs pages d’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-192">The method checks if the response status code is successful (status codes in the range 200-299) and the `Content-Type` header is `text/html; charset=utf-8` for several app pages.</span></span>

<span data-ttu-id="d5776-193">[CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) crée un `HttpClient` exemple qui suit automatiquement les redirections et gère les cookies.</span><span class="sxs-lookup"><span data-stu-id="d5776-193">[CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) creates an instance of `HttpClient` that automatically follows redirects and handles cookies.</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/BasicTests.cs?name=snippet1)]

<span data-ttu-id="d5776-194">Par défaut, les cookies non essentiels ne sont pas conservés entre les demandes lorsque la [politique de consentement GDPR](xref:security/gdpr) est activée.</span><span class="sxs-lookup"><span data-stu-id="d5776-194">By default, non-essential cookies aren't preserved across requests when the [GDPR consent policy](xref:security/gdpr) is enabled.</span></span> <span data-ttu-id="d5776-195">Pour préserver les cookies non essentiels, tels que ceux utilisés par le fournisseur TempData, marquez-les comme essentiels dans vos tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-195">To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests.</span></span> <span data-ttu-id="d5776-196">Pour obtenir des instructions sur le marquage d’un cookie comme essentiel, voir [les cookies Essentiels](xref:security/gdpr#essential-cookies).</span><span class="sxs-lookup"><span data-stu-id="d5776-196">For instructions on marking a cookie as essential, see [Essential cookies](xref:security/gdpr#essential-cookies).</span></span>

## <a name="customize-webapplicationfactory"></a><span data-ttu-id="d5776-197">Personnaliser WebApplicationFactory</span><span class="sxs-lookup"><span data-stu-id="d5776-197">Customize WebApplicationFactory</span></span>

<span data-ttu-id="d5776-198">La configuration de l’hôte Web peut être `WebApplicationFactory` créée indépendamment des classes de test en héritant de créer une ou plusieurs usines personnalisées :</span><span class="sxs-lookup"><span data-stu-id="d5776-198">Web host configuration can be created independently of the test classes by inheriting from `WebApplicationFactory` to create one or more custom factories:</span></span>

1. <span data-ttu-id="d5776-199">Héritez de `WebApplicationFactory` [configureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost)et remplacez.</span><span class="sxs-lookup"><span data-stu-id="d5776-199">Inherit from `WebApplicationFactory` and override [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost).</span></span> <span data-ttu-id="d5776-200">[L’IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) permet la configuration de la collection de services avec [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span><span class="sxs-lookup"><span data-stu-id="d5776-200">The [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) allows the configuration of the service collection with [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span></span>

   [!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/CustomWebApplicationFactory.cs?name=snippet1)]

   <span data-ttu-id="d5776-201">L’ensemencement de base `InitializeDbForTests` de données dans l’application [d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) est effectué par la méthode.</span><span class="sxs-lookup"><span data-stu-id="d5776-201">Database seeding in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is performed by the `InitializeDbForTests` method.</span></span> <span data-ttu-id="d5776-202">La méthode est décrite dans [l’échantillon de tests d’intégration : Section de l’organisation des applications de test.](#test-app-organization)</span><span class="sxs-lookup"><span data-stu-id="d5776-202">The method is described in the [Integration tests sample: Test app organization](#test-app-organization) section.</span></span>

   <span data-ttu-id="d5776-203">Le contexte de la base de `Startup.ConfigureServices` données du SUT est enregistré dans sa méthode.</span><span class="sxs-lookup"><span data-stu-id="d5776-203">The SUT's database context is registered in its `Startup.ConfigureServices` method.</span></span> <span data-ttu-id="d5776-204">Le rappel de `builder.ConfigureServices` l’application de test est `Startup.ConfigureServices` exécuté *après* l’exécution du code de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-204">The test app's `builder.ConfigureServices` callback is executed *after* the app's `Startup.ConfigureServices` code is executed.</span></span> <span data-ttu-id="d5776-205">L’ordre d’exécution est un changement de rupture pour [l’hôte générique](xref:fundamentals/host/generic-host) avec la sortie de ASP.NET Core 3.0.</span><span class="sxs-lookup"><span data-stu-id="d5776-205">The execution order is a breaking change for the [Generic Host](xref:fundamentals/host/generic-host) with the release of ASP.NET Core 3.0.</span></span> <span data-ttu-id="d5776-206">Pour utiliser une base de données différente pour les tests que la base `builder.ConfigureServices`de données de l’application, le contexte de base de données de l’application doit être remplacé .</span><span class="sxs-lookup"><span data-stu-id="d5776-206">To use a different database for the tests than the app's database, the app's database context must be replaced in `builder.ConfigureServices`.</span></span>

   <span data-ttu-id="d5776-207">L’application d’échantillon trouve le descripteur de service pour le contexte de base de données et utilise le descripteur pour supprimer l’enregistrement de service.</span><span class="sxs-lookup"><span data-stu-id="d5776-207">The sample app finds the service descriptor for the database context and uses the descriptor to remove the service registration.</span></span> <span data-ttu-id="d5776-208">Ensuite, l’usine `ApplicationDbContext` ajoute un nouveau qui utilise une base de données en mémoire pour les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-208">Next, the factory adds a new `ApplicationDbContext` that uses an in-memory database for the tests.</span></span>

   <span data-ttu-id="d5776-209">Pour vous connecter à une base de données `UseInMemoryDatabase` différente de celle de la base de données en mémoire, modifiez l’appel pour connecter le contexte à une base de données différente.</span><span class="sxs-lookup"><span data-stu-id="d5776-209">To connect to a different database than the in-memory database, change the `UseInMemoryDatabase` call to connect the context to a different database.</span></span> <span data-ttu-id="d5776-210">Pour utiliser une base de données de test SQL Server :</span><span class="sxs-lookup"><span data-stu-id="d5776-210">To use a SQL Server test database:</span></span>

   * <span data-ttu-id="d5776-211">Référence du package [Microsoft.EntityFrameworkCore.SqlServer](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/) NuGet dans le fichier du projet.</span><span class="sxs-lookup"><span data-stu-id="d5776-211">Reference the [Microsoft.EntityFrameworkCore.SqlServer](https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/) NuGet package in the project file.</span></span>
   * <span data-ttu-id="d5776-212">Appelez `UseSqlServer` avec une chaîne de connexion à la base de données.</span><span class="sxs-lookup"><span data-stu-id="d5776-212">Call `UseSqlServer` with a connection string to the database.</span></span>

   ```csharp
   services.AddDbContext<ApplicationDbContext>((options, context) => 
   {
       context.UseSqlServer(
           Configuration.GetConnectionString("TestingDbConnectionString"));
   });
   ```

2. <span data-ttu-id="d5776-213">Utilisez la `CustomWebApplicationFactory` coutume dans les classes de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-213">Use the custom `CustomWebApplicationFactory` in test classes.</span></span> <span data-ttu-id="d5776-214">L’exemple suivant utilise `IndexPageTests` l’usine de la classe :</span><span class="sxs-lookup"><span data-stu-id="d5776-214">The following example uses the factory in the `IndexPageTests` class:</span></span>

   [!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet1)]

   <span data-ttu-id="d5776-215">Le client de l’application de `HttpClient` l’échantillon est configuré pour empêcher les redirections suivantes.</span><span class="sxs-lookup"><span data-stu-id="d5776-215">The sample app's client is configured to prevent the `HttpClient` from following redirects.</span></span> <span data-ttu-id="d5776-216">Comme expliqué plus tard dans la section [d’authentification Mock,](#mock-authentication) cela permet aux tests de vérifier le résultat de la première réponse de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-216">As explained later in the [Mock authentication](#mock-authentication) section, this permits tests to check the result of the app's first response.</span></span> <span data-ttu-id="d5776-217">La première réponse est une redirection `Location` dans beaucoup de ces tests avec un en-tête.</span><span class="sxs-lookup"><span data-stu-id="d5776-217">The first response is a redirect in many of these tests with a `Location` header.</span></span>

3. <span data-ttu-id="d5776-218">Un test typique `HttpClient` utilise les méthodes et les méthodes d’aide pour traiter la demande et la réponse :</span><span class="sxs-lookup"><span data-stu-id="d5776-218">A typical test uses the `HttpClient` and helper methods to process the request and the response:</span></span>

   [!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet2)]

<span data-ttu-id="d5776-219">Toute demande POST au SUT doit satisfaire le contrôle antiforgery qui est automatiquement faite par le [système antiforgery](xref:security/data-protection/introduction)de protection des données de l’application .</span><span class="sxs-lookup"><span data-stu-id="d5776-219">Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's [data protection antiforgery system](xref:security/data-protection/introduction).</span></span> <span data-ttu-id="d5776-220">Afin d’organiser la demande POST d’un test, l’application de test doit :</span><span class="sxs-lookup"><span data-stu-id="d5776-220">In order to arrange for a test's POST request, the test app must:</span></span>

1. <span data-ttu-id="d5776-221">Faites une demande pour la page.</span><span class="sxs-lookup"><span data-stu-id="d5776-221">Make a request for the page.</span></span>
1. <span data-ttu-id="d5776-222">Parse le cookie antiforgery et demander le jeton de validation de la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5776-222">Parse the antiforgery cookie and request validation token from the response.</span></span>
1. <span data-ttu-id="d5776-223">Faites la demande POST avec le cookie antiforgery et demandez le jeton de validation en place.</span><span class="sxs-lookup"><span data-stu-id="d5776-223">Make the POST request with the antiforgery cookie and request validation token in place.</span></span>

<span data-ttu-id="d5776-224">Les `SendAsync` méthodes d’extension de l’aide (*Helpers/HttpClientExtensions.cs*) et `GetDocumentAsync` la méthode d’aide *(Helpers/HtmlHelpers.cs*) dans [l’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) utilisent le parser [AngleSharp](https://anglesharp.github.io/) pour manipuler le contrôle antiforgery avec les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-224">The `SendAsync` helper extension methods (*Helpers/HttpClientExtensions.cs*) and the `GetDocumentAsync` helper method (*Helpers/HtmlHelpers.cs*) in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) use the [AngleSharp](https://anglesharp.github.io/) parser to handle the antiforgery check with the following methods:</span></span>

* <span data-ttu-id="d5776-225">`GetDocumentAsync`&ndash; Reçoit le [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) `IHtmlDocument`et retourne un .</span><span class="sxs-lookup"><span data-stu-id="d5776-225">`GetDocumentAsync` &ndash; Receives the [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) and returns an `IHtmlDocument`.</span></span> <span data-ttu-id="d5776-226">`GetDocumentAsync`utilise une usine qui prépare une réponse `HttpResponseMessage` *virtuelle* basée sur l’original .</span><span class="sxs-lookup"><span data-stu-id="d5776-226">`GetDocumentAsync` uses a factory that prepares a *virtual response* based on the original `HttpResponseMessage`.</span></span> <span data-ttu-id="d5776-227">Pour plus d’informations, voir la [documentation AngleSharp](https://github.com/AngleSharp/AngleSharp#documentation).</span><span class="sxs-lookup"><span data-stu-id="d5776-227">For more information, see the [AngleSharp documentation](https://github.com/AngleSharp/AngleSharp#documentation).</span></span>
* <span data-ttu-id="d5776-228">`SendAsync`méthodes d’extension pour la `HttpClient` composition d’un [httpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) et appeler [SendAsync (HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) pour soumettre des demandes au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-228">`SendAsync` extension methods for the `HttpClient` compose an [HttpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) and call [SendAsync(HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) to submit requests to the SUT.</span></span> <span data-ttu-id="d5776-229">Surcharges pour `SendAsync` accepter le`IHtmlFormElement`formulaire HTML ( ) et ce qui suit:</span><span class="sxs-lookup"><span data-stu-id="d5776-229">Overloads for `SendAsync` accept the HTML form (`IHtmlFormElement`) and the following:</span></span>
  * <span data-ttu-id="d5776-230">Soumettre le bouton`IHtmlElement`du formulaire ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-230">Submit button of the form (`IHtmlElement`)</span></span>
  * <span data-ttu-id="d5776-231">Collection de`IEnumerable<KeyValuePair<string, string>>`valeurs de formulaire ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-231">Form values collection (`IEnumerable<KeyValuePair<string, string>>`)</span></span>
  * <span data-ttu-id="d5776-232">Soumettre des`IHtmlElement`valeurs de`IEnumerable<KeyValuePair<string, string>>`bouton ( ) et de forme ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-232">Submit button (`IHtmlElement`) and form values (`IEnumerable<KeyValuePair<string, string>>`)</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-233">[AngleSharp](https://anglesharp.github.io/) est une bibliothèque d’analyse tierce utilisée à des fins de démonstration dans ce sujet et l’application d’échantillon.</span><span class="sxs-lookup"><span data-stu-id="d5776-233">[AngleSharp](https://anglesharp.github.io/) is a third-party parsing library used for demonstration purposes in this topic and the sample app.</span></span> <span data-ttu-id="d5776-234">AngleSharp n’est pas pris en charge ou requis pour les tests d’intégration des applications ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="d5776-234">AngleSharp isn't supported or required for integration testing of ASP.NET Core apps.</span></span> <span data-ttu-id="d5776-235">D’autres analyseurs peuvent être utilisés, tels que le [Pack d’agilité Html (HAP)](https://html-agility-pack.net/).</span><span class="sxs-lookup"><span data-stu-id="d5776-235">Other parsers can be used, such as the [Html Agility Pack (HAP)](https://html-agility-pack.net/).</span></span> <span data-ttu-id="d5776-236">Une autre approche consiste à écrire du code pour gérer directement le jeton de vérification des demandes et le cookie antiforgery du système antiforgery.</span><span class="sxs-lookup"><span data-stu-id="d5776-236">Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly.</span></span>

## <a name="customize-the-client-with-withwebhostbuilder"></a><span data-ttu-id="d5776-237">Personnalisez le client avec WithWebHostBuilder</span><span class="sxs-lookup"><span data-stu-id="d5776-237">Customize the client with WithWebHostBuilder</span></span>

<span data-ttu-id="d5776-238">Lorsque une configuration supplémentaire est nécessaire dans une méthode `WebApplicationFactory` de test, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) crée un nouveau avec un [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) qui est encore personnalisé par configuration.</span><span class="sxs-lookup"><span data-stu-id="d5776-238">When additional configuration is required within a test method, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) creates a new `WebApplicationFactory` with an [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) that is further customized by configuration.</span></span>

<span data-ttu-id="d5776-239">La `Post_DeleteMessageHandler_ReturnsRedirectToRoot` méthode de test de l’application [d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) démontre l’utilisation de `WithWebHostBuilder`.</span><span class="sxs-lookup"><span data-stu-id="d5776-239">The `Post_DeleteMessageHandler_ReturnsRedirectToRoot` test method of the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) demonstrates the use of `WithWebHostBuilder`.</span></span> <span data-ttu-id="d5776-240">Ce test effectue une suppression d’enregistrements dans la base de données en déclenchant une soumission de formulaire dans le SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-240">This test performs a record delete in the database by triggering a form submission in the SUT.</span></span>

<span data-ttu-id="d5776-241">Étant donné qu’un autre test de la `IndexPageTests` classe effectue une opération qui `Post_DeleteMessageHandler_ReturnsRedirectToRoot` supprime tous les enregistrements de la base de données et peut s’exécuter avant la méthode, la base de données est réédée dans cette méthode de test pour s’assurer qu’un enregistrement est présent pour que le SUT puisse le supprimer.</span><span class="sxs-lookup"><span data-stu-id="d5776-241">Because another test in the `IndexPageTests` class performs an operation that deletes all of the records in the database and may run before the `Post_DeleteMessageHandler_ReturnsRedirectToRoot` method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete.</span></span> <span data-ttu-id="d5776-242">La sélection du premier `messages` bouton de suppression du formulaire dans le SUT est simulée dans la demande au SUT :</span><span class="sxs-lookup"><span data-stu-id="d5776-242">Selecting the first delete button of the `messages` form in the SUT is simulated in the request to the SUT:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet3)]

## <a name="client-options"></a><span data-ttu-id="d5776-243">Options clients</span><span class="sxs-lookup"><span data-stu-id="d5776-243">Client options</span></span>

<span data-ttu-id="d5776-244">Le tableau suivant affiche la valeur Par défaut [de WebApplicationFactoryClientOptions disponibles](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) lors de la création d’instances. `HttpClient`</span><span class="sxs-lookup"><span data-stu-id="d5776-244">The following table shows the default [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) available when creating `HttpClient` instances.</span></span>

| <span data-ttu-id="d5776-245">Option</span><span class="sxs-lookup"><span data-stu-id="d5776-245">Option</span></span> | <span data-ttu-id="d5776-246">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-246">Description</span></span> | <span data-ttu-id="d5776-247">Default</span><span class="sxs-lookup"><span data-stu-id="d5776-247">Default</span></span> |
| ------ | ----------- | ------- |
| [<span data-ttu-id="d5776-248">AutoriserAutoRedirect</span><span class="sxs-lookup"><span data-stu-id="d5776-248">AllowAutoRedirect</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) | <span data-ttu-id="d5776-249">Obtient ou définit `HttpClient` si les instances doivent suivre automatiquement les réponses de redirection.</span><span class="sxs-lookup"><span data-stu-id="d5776-249">Gets or sets whether or not `HttpClient` instances should automatically follow redirect responses.</span></span> | `true` |
| [<span data-ttu-id="d5776-250">BaseAddress (baseAddress)</span><span class="sxs-lookup"><span data-stu-id="d5776-250">BaseAddress</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.baseaddress) | <span data-ttu-id="d5776-251">Obtient ou définit l’adresse de base des `HttpClient` instances.</span><span class="sxs-lookup"><span data-stu-id="d5776-251">Gets or sets the base address of `HttpClient` instances.</span></span> | `http://localhost` |
| [<span data-ttu-id="d5776-252">HandleCookies (en)</span><span class="sxs-lookup"><span data-stu-id="d5776-252">HandleCookies</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.handlecookies) | <span data-ttu-id="d5776-253">Obtient ou `HttpClient` définit si les instances doivent gérer les cookies.</span><span class="sxs-lookup"><span data-stu-id="d5776-253">Gets or sets whether `HttpClient` instances should handle cookies.</span></span> | `true` |
| [<span data-ttu-id="d5776-254">MaxAutomaticRedirections</span><span class="sxs-lookup"><span data-stu-id="d5776-254">MaxAutomaticRedirections</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.maxautomaticredirections) | <span data-ttu-id="d5776-255">Obtient ou définit le nombre maximum `HttpClient` de réponses de redirection que les instances doivent suivre.</span><span class="sxs-lookup"><span data-stu-id="d5776-255">Gets or sets the maximum number of redirect responses that `HttpClient` instances should follow.</span></span> | <span data-ttu-id="d5776-256">7</span><span class="sxs-lookup"><span data-stu-id="d5776-256">7</span></span> |

<span data-ttu-id="d5776-257">Créez `WebApplicationFactoryClientOptions` la classe et transmettez-la à la méthode [CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) (les valeurs par défaut sont affichées dans l’exemple du code) :</span><span class="sxs-lookup"><span data-stu-id="d5776-257">Create the `WebApplicationFactoryClientOptions` class and pass it to the [CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) method (default values are shown in the code example):</span></span>

```csharp
// Default client option values are shown
var clientOptions = new WebApplicationFactoryClientOptions();
clientOptions.AllowAutoRedirect = true;
clientOptions.BaseAddress = new Uri("http://localhost");
clientOptions.HandleCookies = true;
clientOptions.MaxAutomaticRedirections = 7;

_client = _factory.CreateClient(clientOptions);
```

## <a name="inject-mock-services"></a><span data-ttu-id="d5776-258">Injecter des services fictifs</span><span class="sxs-lookup"><span data-stu-id="d5776-258">Inject mock services</span></span>

<span data-ttu-id="d5776-259">Les services peuvent être remplacés lors d’un test avec un appel à [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) sur le constructeur hôte.</span><span class="sxs-lookup"><span data-stu-id="d5776-259">Services can be overridden in a test with a call to [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) on the host builder.</span></span> <span data-ttu-id="d5776-260">**Pour injecter des services fictifs, `Startup` le `Startup.ConfigureServices` SUT doit avoir une classe avec une méthode.**</span><span class="sxs-lookup"><span data-stu-id="d5776-260">**To inject mock services, the SUT must have a `Startup` class with a `Startup.ConfigureServices` method.**</span></span>

<span data-ttu-id="d5776-261">L’échantillon SUT comprend un service à portée qui renvoie un devis.</span><span class="sxs-lookup"><span data-stu-id="d5776-261">The sample SUT includes a scoped service that returns a quote.</span></span> <span data-ttu-id="d5776-262">La citation est intégrée dans un champ caché sur la page Index lorsque la page Index est demandée.</span><span class="sxs-lookup"><span data-stu-id="d5776-262">The quote is embedded in a hidden field on the Index page when the Index page is requested.</span></span>

<span data-ttu-id="d5776-263">*Services/IQuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-263">*Services/IQuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Services/IQuoteService.cs?name=snippet1)]

<span data-ttu-id="d5776-264">*Services/QuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-264">*Services/QuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Services/QuoteService.cs?name=snippet1)]

<span data-ttu-id="d5776-265">*Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-265">*Startup.cs*:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet2)]

<span data-ttu-id="d5776-266">*Pages/Index.cshtml.cs* :</span><span class="sxs-lookup"><span data-stu-id="d5776-266">*Pages/Index.cshtml.cs*:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml.cs?name=snippet1&highlight=4,9,20,26)]

<span data-ttu-id="d5776-267">*Pages/Index.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-267">*Pages/Index.cs*:</span></span>

[!code-cshtml[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml?name=snippet_Quote)]

<span data-ttu-id="d5776-268">La balisage suivante est générée lorsque l’application SUT est exécutée :</span><span class="sxs-lookup"><span data-stu-id="d5776-268">The following markup is generated when the SUT app is run:</span></span>

```html
<input id="quote" type="hidden" value="Come on, Sarah. We&#x27;ve an appointment in 
    London, and we&#x27;re already 30,000 years late.">
```

<span data-ttu-id="d5776-269">Pour tester le service et citer l’injection dans un test d’intégration, un service de simulation est injecté dans le SUT par le test.</span><span class="sxs-lookup"><span data-stu-id="d5776-269">To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test.</span></span> <span data-ttu-id="d5776-270">Le service de simulation remplace `QuoteService` l’application par un service `TestQuoteService`fourni par l’application de test, appelé :</span><span class="sxs-lookup"><span data-stu-id="d5776-270">The mock service replaces the app's `QuoteService` with a service provided by the test app, called `TestQuoteService`:</span></span>

<span data-ttu-id="d5776-271">*IntegrationTests.IndexPageTests.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-271">*IntegrationTests.IndexPageTests.cs*:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet4)]

<span data-ttu-id="d5776-272">`ConfigureTestServices`est appelé, et le service de portée est enregistré:</span><span class="sxs-lookup"><span data-stu-id="d5776-272">`ConfigureTestServices` is called, and the scoped service is registered:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet5&highlight=7-10,17,20-21)]

<span data-ttu-id="d5776-273">La majoration produite lors de l’exécution du `TestQuoteService`test reflète le texte de citation fourni par , donc l’affirmation passe:</span><span class="sxs-lookup"><span data-stu-id="d5776-273">The markup produced during the test's execution reflects the quote text supplied by `TestQuoteService`, thus the assertion passes:</span></span>

```html
<input id="quote" type="hidden" value="Something&#x27;s interfering with time, 
    Mr. Scarman, and time is my business.">
```

## <a name="mock-authentication"></a><span data-ttu-id="d5776-274">Authentification simulée</span><span class="sxs-lookup"><span data-stu-id="d5776-274">Mock authentication</span></span>

<span data-ttu-id="d5776-275">Les tests `AuthTests` dans la classe vérifient qu’un point de terminaison sécurisé :</span><span class="sxs-lookup"><span data-stu-id="d5776-275">Tests in the `AuthTests` class check that a secure endpoint:</span></span>

* <span data-ttu-id="d5776-276">Redirige un utilisateur non authentique vers la page Login de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-276">Redirects an unauthenticated user to the app's Login page.</span></span>
* <span data-ttu-id="d5776-277">Retourne le contenu d’un utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="d5776-277">Returns content for an authenticated user.</span></span>

<span data-ttu-id="d5776-278">Dans le SUT, la `/SecurePage` page utilise une convention [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) pour appliquer un [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) à la page.</span><span class="sxs-lookup"><span data-stu-id="d5776-278">In the SUT, the `/SecurePage` page uses an [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) convention to apply an [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) to the page.</span></span> <span data-ttu-id="d5776-279">Pour plus d’informations, voir [les conventions d’autorisation de Razor Pages](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span><span class="sxs-lookup"><span data-stu-id="d5776-279">For more information, see [Razor Pages authorization conventions](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet1)]

<span data-ttu-id="d5776-280">Dans `Get_SecurePageRedirectsAnUnauthenticatedUser` le test, un [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) est configuré pour refuser `false`les redirections en définissant [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) à :</span><span class="sxs-lookup"><span data-stu-id="d5776-280">In the `Get_SecurePageRedirectsAnUnauthenticatedUser` test, a [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) is set to disallow redirects by setting [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) to `false`:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet2)]

<span data-ttu-id="d5776-281">En interdisant au client de suivre la redirection, les vérifications suivantes peuvent être effectuées :</span><span class="sxs-lookup"><span data-stu-id="d5776-281">By disallowing the client to follow the redirect, the following checks can be made:</span></span>

* <span data-ttu-id="d5776-282">Le code d’état retourné par le SUT peut être vérifié par rapport au résultat [attendu httpStatusCode.Redirect,](/dotnet/api/system.net.httpstatuscode) et non au code d’état final après la redirection vers la page Login, qui serait [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span><span class="sxs-lookup"><span data-stu-id="d5776-282">The status code returned by the SUT can be checked against the expected [HttpStatusCode.Redirect](/dotnet/api/system.net.httpstatuscode) result, not the final status code after the redirect to the Login page, which would be [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span></span>
* <span data-ttu-id="d5776-283">La `Location` valeur d’en-tête dans les en-têtes de réponse est vérifiée pour confirmer qu’il commence par `http://localhost/Identity/Account/Login`, pas la réponse finale de la page Login, où l’en-tête `Location` ne serait pas présent.</span><span class="sxs-lookup"><span data-stu-id="d5776-283">The `Location` header value in the response headers is checked to confirm that it starts with `http://localhost/Identity/Account/Login`, not the final Login page response, where the `Location` header wouldn't be present.</span></span>

<span data-ttu-id="d5776-284">L’application de <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1> test peut se moquer d’un in [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) afin de tester les aspects de l’authentification et de l’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d5776-284">The test app can mock an <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1> in [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) in order to test aspects of authentication and authorization.</span></span> <span data-ttu-id="d5776-285">Un scénario minimal renvoie un [AuthenticateResult.Success](xref:Microsoft.AspNetCore.Authentication.AuthenticateResult.Success*):</span><span class="sxs-lookup"><span data-stu-id="d5776-285">A minimal scenario returns an [AuthenticateResult.Success](xref:Microsoft.AspNetCore.Authentication.AuthenticateResult.Success*):</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet4&highlight=11-18)]

<span data-ttu-id="d5776-286">Le `TestAuthHandler` est appelé à authentifier un utilisateur `Test` `AddAuthentication` lorsque le `ConfigureTestServices`système d’authentification est réglé à l’endroit où est enregistré pour :</span><span class="sxs-lookup"><span data-stu-id="d5776-286">The `TestAuthHandler` is called to authenticate a user when the authentication scheme is set to `Test` where `AddAuthentication` is registered for `ConfigureTestServices`:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet3&highlight=7-12)]

<span data-ttu-id="d5776-287">Pour plus `WebApplicationFactoryClientOptions`d’informations sur , voir la section [options Client.](#client-options)</span><span class="sxs-lookup"><span data-stu-id="d5776-287">For more information on `WebApplicationFactoryClientOptions`, see the [Client options](#client-options) section.</span></span>

## <a name="set-the-environment"></a><span data-ttu-id="d5776-288">Définir l’environnement</span><span class="sxs-lookup"><span data-stu-id="d5776-288">Set the environment</span></span>

<span data-ttu-id="d5776-289">Par défaut, l’environnement d’hôte et d’application du SUT est configuré pour utiliser l’environnement de développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-289">By default, the SUT's host and app environment is configured to use the Development environment.</span></span> <span data-ttu-id="d5776-290">Pour remplacer l’environnement du SUT :</span><span class="sxs-lookup"><span data-stu-id="d5776-290">To override the SUT's environment:</span></span>

* <span data-ttu-id="d5776-291">Définissez `ASPNETCORE_ENVIRONMENT` la variable de `Staging` `Production`l’environnement (par exemple, , , ou toute autre valeur personnalisée, telle que `Testing`).</span><span class="sxs-lookup"><span data-stu-id="d5776-291">Set the `ASPNETCORE_ENVIRONMENT` environment variable (for example, `Staging`, `Production`, or other custom value, such as `Testing`).</span></span>
* <span data-ttu-id="d5776-292">Remplacer `CreateHostBuilder` dans l’application de test pour `ASPNETCORE`lire les variables de l’environnement préfixées avec .</span><span class="sxs-lookup"><span data-stu-id="d5776-292">Override `CreateHostBuilder` in the test app to read environment variables prefixed with `ASPNETCORE`.</span></span>

```csharp
protected override IHostBuilder CreateHostBuilder() => 
    base.CreateHostBuilder()
        .ConfigureHostConfiguration(
            config => config.AddEnvironmentVariables("ASPNETCORE"));
```

## <a name="how-the-test-infrastructure-infers-the-app-content-root-path"></a><span data-ttu-id="d5776-293">Comment l’infrastructure de test déduit le chemin de racine du contenu de l’application</span><span class="sxs-lookup"><span data-stu-id="d5776-293">How the test infrastructure infers the app content root path</span></span>

<span data-ttu-id="d5776-294">Le `WebApplicationFactory` constructeur déduit le chemin [de racine de contenu](xref:fundamentals/index#content-root) de l’application en recherchant un [WebApplicationFactoryContentRotentAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) sur l’assemblage contenant les tests d’intégration avec une clé égale à l’assemblage `TEntryPoint` `System.Reflection.Assembly.FullName`.</span><span class="sxs-lookup"><span data-stu-id="d5776-294">The `WebApplicationFactory` constructor infers the app [content root](xref:fundamentals/index#content-root) path by searching for a [WebApplicationFactoryContentRootAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) on the assembly containing the integration tests with a key equal to the `TEntryPoint` assembly `System.Reflection.Assembly.FullName`.</span></span> <span data-ttu-id="d5776-295">Dans le cas où un attribut `WebApplicationFactory` avec la clé correcte n’est pas trouvé, retombe à la recherche d’un fichier de solution (*.sln*) et joint le nom de l’assemblage `TEntryPoint` à l’annuaire de la solution.</span><span class="sxs-lookup"><span data-stu-id="d5776-295">In case an attribute with the correct key isn't found, `WebApplicationFactory` falls back to searching for a solution file (*.sln*) and appends the `TEntryPoint` assembly name to the solution directory.</span></span> <span data-ttu-id="d5776-296">Le répertoire racine de l’application (le chemin de racine de contenu) est utilisé pour découvrir les vues et les fichiers de contenu.</span><span class="sxs-lookup"><span data-stu-id="d5776-296">The app root directory (the content root path) is used to discover views and content files.</span></span>

## <a name="disable-shadow-copying"></a><span data-ttu-id="d5776-297">Copie d’ombre de désactiver</span><span class="sxs-lookup"><span data-stu-id="d5776-297">Disable shadow copying</span></span>

<span data-ttu-id="d5776-298">La copie d’ombre provoque l’exécution des tests dans un répertoire différent de celui du répertoire de sortie.</span><span class="sxs-lookup"><span data-stu-id="d5776-298">Shadow copying causes the tests to execute in a different directory than the output directory.</span></span> <span data-ttu-id="d5776-299">Pour que les tests fonctionnent correctement, la copie d’ombre doit être désactivée.</span><span class="sxs-lookup"><span data-stu-id="d5776-299">For tests to work properly, shadow copying must be disabled.</span></span> <span data-ttu-id="d5776-300">[L’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) utilise xUnit et désactive la copie d’ombre pour xUnit en incluant un fichier *xunit.runner.json* avec le réglage de configuration correct.</span><span class="sxs-lookup"><span data-stu-id="d5776-300">The [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) uses xUnit and disables shadow copying for xUnit by including an *xunit.runner.json* file with the correct configuration setting.</span></span> <span data-ttu-id="d5776-301">Pour plus d’informations, voir [Configuring xUnit avec JSON](https://xunit.github.io/docs/configuring-with-json.html).</span><span class="sxs-lookup"><span data-stu-id="d5776-301">For more information, see [Configuring xUnit with JSON](https://xunit.github.io/docs/configuring-with-json.html).</span></span>

<span data-ttu-id="d5776-302">Ajouter le fichier *xunit.runner.json* à la racine du projet de test avec le contenu suivant :</span><span class="sxs-lookup"><span data-stu-id="d5776-302">Add the *xunit.runner.json* file to root of the test project with the following content:</span></span>

```json
{
  "shadowCopy": false
}
```

## <a name="disposal-of-objects"></a><span data-ttu-id="d5776-303">Élimination des objets</span><span class="sxs-lookup"><span data-stu-id="d5776-303">Disposal of objects</span></span>

<span data-ttu-id="d5776-304">Après l’exécution `IClassFixture` des tests de la mise en œuvre, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) et [HttpClient](/dotnet/api/system.net.http.httpclient) sont éliminés lorsque xUnit dispose de la [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1).</span><span class="sxs-lookup"><span data-stu-id="d5776-304">After the tests of the `IClassFixture` implementation are executed, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) and [HttpClient](/dotnet/api/system.net.http.httpclient) are disposed when xUnit disposes of the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1).</span></span> <span data-ttu-id="d5776-305">Si les objets instantanés par le développeur nécessitent `IClassFixture` leur élimination, les disposer dans la mise en œuvre.</span><span class="sxs-lookup"><span data-stu-id="d5776-305">If objects instantiated by the developer require disposal, dispose of them in the `IClassFixture` implementation.</span></span> <span data-ttu-id="d5776-306">Pour plus d’informations, voir [Implementing a Dispose method](/dotnet/standard/garbage-collection/implementing-dispose).</span><span class="sxs-lookup"><span data-stu-id="d5776-306">For more information, see [Implementing a Dispose method](/dotnet/standard/garbage-collection/implementing-dispose).</span></span>

## <a name="integration-tests-sample"></a><span data-ttu-id="d5776-307">Échantillon de tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="d5776-307">Integration tests sample</span></span>

<span data-ttu-id="d5776-308">[L’application échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) est composée de deux applications:</span><span class="sxs-lookup"><span data-stu-id="d5776-308">The [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is composed of two apps:</span></span>

| <span data-ttu-id="d5776-309">Application</span><span class="sxs-lookup"><span data-stu-id="d5776-309">App</span></span> | <span data-ttu-id="d5776-310">Répertoire du projet</span><span class="sxs-lookup"><span data-stu-id="d5776-310">Project directory</span></span> | <span data-ttu-id="d5776-311">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-311">Description</span></span> |
| --- | ----------------- | ----------- |
| <span data-ttu-id="d5776-312">Application de message (le SUT)</span><span class="sxs-lookup"><span data-stu-id="d5776-312">Message app (the SUT)</span></span> | <span data-ttu-id="d5776-313">*src/RazorPagesProjet*</span><span class="sxs-lookup"><span data-stu-id="d5776-313">*src/RazorPagesProject*</span></span> | <span data-ttu-id="d5776-314">Permet à un utilisateur d’en ajouter, de supprimer un, de supprimer tous et d’analyser des messages.</span><span class="sxs-lookup"><span data-stu-id="d5776-314">Allows a user to add, delete one, delete all, and analyze messages.</span></span> |
| <span data-ttu-id="d5776-315">Tester une application</span><span class="sxs-lookup"><span data-stu-id="d5776-315">Test app</span></span> | <span data-ttu-id="d5776-316">*tests/RazorPagesProject.Tests*</span><span class="sxs-lookup"><span data-stu-id="d5776-316">*tests/RazorPagesProject.Tests*</span></span> | <span data-ttu-id="d5776-317">Utilisé pour tester l’intégration du SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-317">Used to integration test the SUT.</span></span> |

<span data-ttu-id="d5776-318">Les tests peuvent être exécutés à l’aide des fonctionnalités de test intégrées d’un IDE, tels que [Visual Studio](https://visualstudio.microsoft.com).</span><span class="sxs-lookup"><span data-stu-id="d5776-318">The tests can be run using the built-in test features of an IDE, such as [Visual Studio](https://visualstudio.microsoft.com).</span></span> <span data-ttu-id="d5776-319">Si vous utilisez [visual Studio Code](https://code.visualstudio.com/) ou la ligne de commande, exécutez la commande suivante à une invite de commande dans le répertoire *tests/RazorPagesProject.Tests* :</span><span class="sxs-lookup"><span data-stu-id="d5776-319">If using [Visual Studio Code](https://code.visualstudio.com/) or the command line, execute the following command at a command prompt in the *tests/RazorPagesProject.Tests* directory:</span></span>

```console
dotnet test
```

### <a name="message-app-sut-organization"></a><span data-ttu-id="d5776-320">Organisation de l’application de message (SUT)</span><span class="sxs-lookup"><span data-stu-id="d5776-320">Message app (SUT) organization</span></span>

<span data-ttu-id="d5776-321">Le SUT est un système de messages Razor Pages avec les caractéristiques suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-321">The SUT is a Razor Pages message system with the following characteristics:</span></span>

* <span data-ttu-id="d5776-322">La page d’index de l’application *(Pages/Index.cshtml* et *Pages/Index.cshtml.cs*) fournit une interface utilisateur et des méthodes de modèle de page pour contrôler l’ajout, la suppression et l’analyse des messages (mots moyens par message).</span><span class="sxs-lookup"><span data-stu-id="d5776-322">The Index page of the app (*Pages/Index.cshtml* and *Pages/Index.cshtml.cs*) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</span></span>
* <span data-ttu-id="d5776-323">Un message est `Message` décrit par la classe (*Data/Message.cs*) avec deux propriétés: `Id` (clé) et `Text` (message).</span><span class="sxs-lookup"><span data-stu-id="d5776-323">A message is described by the `Message` class (*Data/Message.cs*) with two properties: `Id` (key) and `Text` (message).</span></span> <span data-ttu-id="d5776-324">La `Text` propriété est requise et limitée à 200 caractères.</span><span class="sxs-lookup"><span data-stu-id="d5776-324">The `Text` property is required and limited to 200 characters.</span></span>
* <span data-ttu-id="d5776-325">Les messages sont stockés [à l’aide de la base de données en mémoire d’Entity Framework](/ef/core/providers/in-memory/)&#8224;.</span><span class="sxs-lookup"><span data-stu-id="d5776-325">Messages are stored using [Entity Framework's in-memory database](/ef/core/providers/in-memory/)&#8224;.</span></span>
* <span data-ttu-id="d5776-326">L’application contient une couche d’accès aux `AppDbContext` données (DAL) dans sa classe de contexte de base de données, (*Data/AppDbContext.cs*).</span><span class="sxs-lookup"><span data-stu-id="d5776-326">The app contains a data access layer (DAL) in its database context class, `AppDbContext` (*Data/AppDbContext.cs*).</span></span>
* <span data-ttu-id="d5776-327">Si la base de données est vide sur le démarrage de l’application, le magasin de messages est paraséfié avec trois messages.</span><span class="sxs-lookup"><span data-stu-id="d5776-327">If the database is empty on app startup, the message store is initialized with three messages.</span></span>
* <span data-ttu-id="d5776-328">L’application `/SecurePage` comprend un qui ne peut être consulté que par un utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="d5776-328">The app includes a `/SecurePage` that can only be accessed by an authenticated user.</span></span>

<span data-ttu-id="d5776-329">&#8224;Le sujet EF, [Test with InMemory](/ef/core/miscellaneous/testing/in-memory), explique comment utiliser une base de données en mémoire pour les tests avec MSTest.</span><span class="sxs-lookup"><span data-stu-id="d5776-329">&#8224;The EF topic, [Test with InMemory](/ef/core/miscellaneous/testing/in-memory), explains how to use an in-memory database for tests with MSTest.</span></span> <span data-ttu-id="d5776-330">Ce sujet utilise le cadre de test [xUnit.](https://xunit.github.io/)</span><span class="sxs-lookup"><span data-stu-id="d5776-330">This topic uses the [xUnit](https://xunit.github.io/) test framework.</span></span> <span data-ttu-id="d5776-331">Les concepts de test et les implémentations de tests dans différents cadres de test sont similaires mais non identiques.</span><span class="sxs-lookup"><span data-stu-id="d5776-331">Test concepts and test implementations across different test frameworks are similar but not identical.</span></span>

<span data-ttu-id="d5776-332">Bien que l’application n’utilise pas le modèle de référentiel et n’est pas un exemple efficace du [modèle de l’Unité de travail (UoW),](https://martinfowler.com/eaaCatalog/unitOfWork.html)Razor Pages prend en charge ces modèles de développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-332">Although the app doesn't use the repository pattern and isn't an effective example of the [Unit of Work (UoW) pattern](https://martinfowler.com/eaaCatalog/unitOfWork.html), Razor Pages supports these patterns of development.</span></span> <span data-ttu-id="d5776-333">Pour plus d’informations, voir [Concevoir la couche de persistance de l’infrastructure](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) et la logique du contrôleur de [test](/aspnet/core/mvc/controllers/testing) (l’échantillon implémente le modèle de dépôt).</span><span class="sxs-lookup"><span data-stu-id="d5776-333">For more information, see [Designing the infrastructure persistence layer](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) and [Test controller logic](/aspnet/core/mvc/controllers/testing) (the sample implements the repository pattern).</span></span>

### <a name="test-app-organization"></a><span data-ttu-id="d5776-334">Organisation d’applications de test</span><span class="sxs-lookup"><span data-stu-id="d5776-334">Test app organization</span></span>

<span data-ttu-id="d5776-335">L’application de test est une application console à l’intérieur du *répertoire tests/RazorPagesProject.Tests.*</span><span class="sxs-lookup"><span data-stu-id="d5776-335">The test app is a console app inside the *tests/RazorPagesProject.Tests* directory.</span></span>

| <span data-ttu-id="d5776-336">Annuaire d’applications de test</span><span class="sxs-lookup"><span data-stu-id="d5776-336">Test app directory</span></span> | <span data-ttu-id="d5776-337">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-337">Description</span></span> |
| ------------------ | ----------- |
| <span data-ttu-id="d5776-338">*AuthTests*</span><span class="sxs-lookup"><span data-stu-id="d5776-338">*AuthTests*</span></span> | <span data-ttu-id="d5776-339">Contient des méthodes de test pour :</span><span class="sxs-lookup"><span data-stu-id="d5776-339">Contains test methods for:</span></span><ul><li><span data-ttu-id="d5776-340">Accès à une page sécurisée par un utilisateur non athéné.</span><span class="sxs-lookup"><span data-stu-id="d5776-340">Accessing a secure page by an unauthenticated user.</span></span></li><li><span data-ttu-id="d5776-341">Accéder à une page sécurisée par un <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1>utilisateur authentifié avec un simulacre .</span><span class="sxs-lookup"><span data-stu-id="d5776-341">Accessing a secure page by an authenticated user with a mock <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1>.</span></span></li><li><span data-ttu-id="d5776-342">Obtenir un profil d’utilisateur GitHub et vérifier la connexion utilisateur du profil.</span><span class="sxs-lookup"><span data-stu-id="d5776-342">Obtaining a GitHub user profile and checking the profile's user login.</span></span></li></ul> |
| <span data-ttu-id="d5776-343">*Tests de base*</span><span class="sxs-lookup"><span data-stu-id="d5776-343">*BasicTests*</span></span> | <span data-ttu-id="d5776-344">Contient une méthode de test pour le routage et le type de contenu.</span><span class="sxs-lookup"><span data-stu-id="d5776-344">Contains a test method for routing and content type.</span></span> |
| <span data-ttu-id="d5776-345">*IntegrationTests*</span><span class="sxs-lookup"><span data-stu-id="d5776-345">*IntegrationTests*</span></span> | <span data-ttu-id="d5776-346">Contient les tests d’intégration `WebApplicationFactory` pour la page Index à l’aide de la classe personnalisée.</span><span class="sxs-lookup"><span data-stu-id="d5776-346">Contains the integration tests for the Index page using custom `WebApplicationFactory` class.</span></span> |
| <span data-ttu-id="d5776-347">*Aides/Services publics*</span><span class="sxs-lookup"><span data-stu-id="d5776-347">*Helpers/Utilities*</span></span> | <ul><li><span data-ttu-id="d5776-348">*Utilities.cs* contient la `InitializeDbForTests` méthode utilisée pour ensemencer la base de données avec des données de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-348">*Utilities.cs* contains the `InitializeDbForTests` method used to seed the database with test data.</span></span></li><li><span data-ttu-id="d5776-349">*HtmlHelpers.cs* fournit une méthode pour retourner `IHtmlDocument` un AngleSharp pour une utilisation par les méthodes d’essai.</span><span class="sxs-lookup"><span data-stu-id="d5776-349">*HtmlHelpers.cs* provides a method to return an AngleSharp `IHtmlDocument` for use by the test methods.</span></span></li><li><span data-ttu-id="d5776-350">*HttpClientExtensions.cs* fournir des surcharges `SendAsync` pour soumettre des demandes au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-350">*HttpClientExtensions.cs* provide overloads for `SendAsync` to submit requests to the SUT.</span></span></li></ul> |

<span data-ttu-id="d5776-351">Le cadre d’essai est [xUnit](https://xunit.github.io/).</span><span class="sxs-lookup"><span data-stu-id="d5776-351">The test framework is [xUnit](https://xunit.github.io/).</span></span> <span data-ttu-id="d5776-352">Les tests d’intégration sont effectués à l’aide de [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), qui comprend le [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span><span class="sxs-lookup"><span data-stu-id="d5776-352">Integration tests are conducted using the [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), which includes the [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span></span> <span data-ttu-id="d5776-353">Étant donné que le package [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) est utilisé `TestHost` pour `TestServer` configurer l’hôte de test et le serveur de test, le paquet et les paquets ne nécessitent pas de références de paquets directs dans le fichier de projet ou la configuration du développeur de l’application de test dans l’application de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-353">Because the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package is used to configure the test host and test server, the `TestHost` and `TestServer` packages don't require direct package references in the test app's project file or developer configuration in the test app.</span></span>

<span data-ttu-id="d5776-354">**Ensemencement de la base de données pour les tests**</span><span class="sxs-lookup"><span data-stu-id="d5776-354">**Seeding the database for testing**</span></span>

<span data-ttu-id="d5776-355">Les tests d’intégration nécessitent généralement un petit jeu de données dans la base de données avant l’exécution du test.</span><span class="sxs-lookup"><span data-stu-id="d5776-355">Integration tests usually require a small dataset in the database prior to the test execution.</span></span> <span data-ttu-id="d5776-356">Par exemple, un test de suppression nécessite une suppression d’enregistrement de base de données, de sorte que la base de données doit avoir au moins un enregistrement pour que la demande de suppression réussisse.</span><span class="sxs-lookup"><span data-stu-id="d5776-356">For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</span></span>

<span data-ttu-id="d5776-357">L’application échantillon de graines de la base de données avec trois messages dans *Utilities.cs* que les tests peuvent utiliser quand ils exécutent:</span><span class="sxs-lookup"><span data-stu-id="d5776-357">The sample app seeds the database with three messages in *Utilities.cs* that tests can use when they execute:</span></span>

[!code-csharp[](integration-tests/samples/3.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/Helpers/Utilities.cs?name=snippet1)]

<span data-ttu-id="d5776-358">Le contexte de la base de `Startup.ConfigureServices` données du SUT est enregistré dans sa méthode.</span><span class="sxs-lookup"><span data-stu-id="d5776-358">The SUT's database context is registered in its `Startup.ConfigureServices` method.</span></span> <span data-ttu-id="d5776-359">Le rappel de `builder.ConfigureServices` l’application de test est `Startup.ConfigureServices` exécuté *après* l’exécution du code de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-359">The test app's `builder.ConfigureServices` callback is executed *after* the app's `Startup.ConfigureServices` code is executed.</span></span> <span data-ttu-id="d5776-360">Pour utiliser une base de données différente pour les tests, le contexte de base de données de l’application doit être remplacé . `builder.ConfigureServices`</span><span class="sxs-lookup"><span data-stu-id="d5776-360">To use a different database for the tests, the app's database context must be replaced in `builder.ConfigureServices`.</span></span> <span data-ttu-id="d5776-361">Pour plus d’informations, consultez la section [Customize WebApplicationFactory.](#customize-webapplicationfactory)</span><span class="sxs-lookup"><span data-stu-id="d5776-361">For more information, see the [Customize WebApplicationFactory](#customize-webapplicationfactory) section.</span></span>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="d5776-362">Les tests d’intégration garantissent que les composants d’une application fonctionnent correctement à un niveau qui inclut l’infrastructure de support de l’application, comme la base de données, le système de fichiers et le réseau.</span><span class="sxs-lookup"><span data-stu-id="d5776-362">Integration tests ensure that an app's components function correctly at a level that includes the app's supporting infrastructure, such as the database, file system, and network.</span></span> <span data-ttu-id="d5776-363">ASP.NET Core prend en charge les tests d’intégration à l’aide d’un cadre de test unitaire avec un hébergeur de test et un serveur de test en mémoire.</span><span class="sxs-lookup"><span data-stu-id="d5776-363">ASP.NET Core supports integration tests using a unit test framework with a test web host and an in-memory test server.</span></span>

<span data-ttu-id="d5776-364">Ce sujet suppose une compréhension de base des tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="d5776-364">This topic assumes a basic understanding of unit tests.</span></span> <span data-ttu-id="d5776-365">S’il n’est pas familier avec les concepts de test, voir le [test unitaire dans .NET Core et .NET Standard](/dotnet/core/testing/) sujet et son contenu lié.</span><span class="sxs-lookup"><span data-stu-id="d5776-365">If unfamiliar with test concepts, see the [Unit Testing in .NET Core and .NET Standard](/dotnet/core/testing/) topic and its linked content.</span></span>

<span data-ttu-id="d5776-366">[Afficher ou télécharger le code de l’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([comment télécharger](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="d5776-366">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

<span data-ttu-id="d5776-367">L’application échantillon est une application Razor Pages et suppose une compréhension de base de Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d5776-367">The sample app is a Razor Pages app and assumes a basic understanding of Razor Pages.</span></span> <span data-ttu-id="d5776-368">Si vous n’êtes pas familier avec Razor Pages, voir les sujets suivants:</span><span class="sxs-lookup"><span data-stu-id="d5776-368">If unfamiliar with Razor Pages, see the following topics:</span></span>

* [<span data-ttu-id="d5776-369">Présentation des pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-369">Introduction to Razor Pages</span></span>](xref:razor-pages/index)
* [<span data-ttu-id="d5776-370">Bien démarrer avec les pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-370">Get started with Razor Pages</span></span>](xref:tutorials/razor-pages/razor-pages-start)
* [<span data-ttu-id="d5776-371">Tests unitaires Pages Razor</span><span class="sxs-lookup"><span data-stu-id="d5776-371">Razor Pages unit tests</span></span>](xref:test/razor-pages-tests)

> [!NOTE]
> <span data-ttu-id="d5776-372">Pour tester les SPA, nous avons recommandé un outil tel que [le sélénium](https://www.seleniumhq.org/), qui peut automatiser un navigateur.</span><span class="sxs-lookup"><span data-stu-id="d5776-372">For testing SPAs, we recommended a tool such as [Selenium](https://www.seleniumhq.org/), which can automate a browser.</span></span>

## <a name="introduction-to-integration-tests"></a><span data-ttu-id="d5776-373">Introduction aux tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="d5776-373">Introduction to integration tests</span></span>

<span data-ttu-id="d5776-374">Les tests d’intégration évaluent les composants d’une application à un niveau plus large que [les tests unitaires.](/dotnet/core/testing/)</span><span class="sxs-lookup"><span data-stu-id="d5776-374">Integration tests evaluate an app's components on a broader level than [unit tests](/dotnet/core/testing/).</span></span> <span data-ttu-id="d5776-375">Les tests unitaires sont utilisés pour tester des composants logiciels isolés, tels que des méthodes de classe individuelles.</span><span class="sxs-lookup"><span data-stu-id="d5776-375">Unit tests are used to test isolated software components, such as individual class methods.</span></span> <span data-ttu-id="d5776-376">Les tests d’intégration confirment que deux composants d’applications ou plus travaillent ensemble pour produire un résultat attendu, y compris éventuellement chaque composant nécessaire pour traiter pleinement une demande.</span><span class="sxs-lookup"><span data-stu-id="d5776-376">Integration tests confirm that two or more app components work together to produce an expected result, possibly including every component required to fully process a request.</span></span>

<span data-ttu-id="d5776-377">Ces tests plus larges sont utilisés pour tester l’infrastructure de l’application et l’ensemble du cadre, y compris souvent les composants suivants :</span><span class="sxs-lookup"><span data-stu-id="d5776-377">These broader tests are used to test the app's infrastructure and whole framework, often including the following components:</span></span>

* <span data-ttu-id="d5776-378">Base de données</span><span class="sxs-lookup"><span data-stu-id="d5776-378">Database</span></span>
* <span data-ttu-id="d5776-379">Système de fichiers</span><span class="sxs-lookup"><span data-stu-id="d5776-379">File system</span></span>
* <span data-ttu-id="d5776-380">Appliances réseau</span><span class="sxs-lookup"><span data-stu-id="d5776-380">Network appliances</span></span>
* <span data-ttu-id="d5776-381">Pipeline de demande-réponse</span><span class="sxs-lookup"><span data-stu-id="d5776-381">Request-response pipeline</span></span>

<span data-ttu-id="d5776-382">Les tests unitaires utilisent des composants fabriqués, connus sous le nom de faux ou *d’objets* *simulés,* à la place de composants d’infrastructure.</span><span class="sxs-lookup"><span data-stu-id="d5776-382">Unit tests use fabricated components, known as *fakes* or *mock objects*, in place of infrastructure components.</span></span>

<span data-ttu-id="d5776-383">Contrairement aux tests unitaires, les tests d’intégration :</span><span class="sxs-lookup"><span data-stu-id="d5776-383">In contrast to unit tests, integration tests:</span></span>

* <span data-ttu-id="d5776-384">Utilisez les composants réels que l’application utilise dans la production.</span><span class="sxs-lookup"><span data-stu-id="d5776-384">Use the actual components that the app uses in production.</span></span>
* <span data-ttu-id="d5776-385">Exiger plus de code et de traitement des données.</span><span class="sxs-lookup"><span data-stu-id="d5776-385">Require more code and data processing.</span></span>
* <span data-ttu-id="d5776-386">Il faut plus de temps pour courir.</span><span class="sxs-lookup"><span data-stu-id="d5776-386">Take longer to run.</span></span>

<span data-ttu-id="d5776-387">Par conséquent, limitez l’utilisation des tests d’intégration aux scénarios d’infrastructure les plus importants.</span><span class="sxs-lookup"><span data-stu-id="d5776-387">Therefore, limit the use of integration tests to the most important infrastructure scenarios.</span></span> <span data-ttu-id="d5776-388">Si un comportement peut être testé à l’aide d’un test unitaire ou d’un test d’intégration, choisissez le test unitaire.</span><span class="sxs-lookup"><span data-stu-id="d5776-388">If a behavior can be tested using either a unit test or an integration test, choose the unit test.</span></span>

> [!TIP]
> <span data-ttu-id="d5776-389">N’écrivez pas de tests d’intégration pour chaque permutation possible des données et n’ez pas l’accès aux fichiers avec des bases de données et des systèmes de fichiers.</span><span class="sxs-lookup"><span data-stu-id="d5776-389">Don't write integration tests for every possible permutation of data and file access with databases and file systems.</span></span> <span data-ttu-id="d5776-390">Indépendamment du nombre d’endroits dans une application interagissent avec les bases de données et les systèmes de fichiers, un ensemble ciblé de tests de lecture, d’écriture, de mise à jour et de suppression des tests d’intégration sont généralement capables de tester adéquatement les composants des bases de données et des fichiers.</span><span class="sxs-lookup"><span data-stu-id="d5776-390">Regardless of how many places across an app interact with databases and file systems, a focused set of read, write, update, and delete integration tests are usually capable of adequately testing database and file system components.</span></span> <span data-ttu-id="d5776-391">Utilisez des tests unitaires pour des tests de routine de la logique de la méthode qui interagissent avec ces composants.</span><span class="sxs-lookup"><span data-stu-id="d5776-391">Use unit tests for routine tests of method logic that interact with these components.</span></span> <span data-ttu-id="d5776-392">Dans les tests unitaires, l’utilisation de faux/mocks d’infrastructure entraîne une exécution plus rapide des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-392">In unit tests, the use of infrastructure fakes/mocks result in faster test execution.</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-393">Dans les discussions sur les tests d’intégration, le projet testé est souvent appelé le *système en cours d’essai*, ou "SUT" pour faire court.</span><span class="sxs-lookup"><span data-stu-id="d5776-393">In discussions of integration tests, the tested project is frequently called the *System Under Test*, or "SUT" for short.</span></span>
>
> <span data-ttu-id="d5776-394">*"SUT" est utilisé tout au long de ce sujet pour se référer à l’application ASP.NET Core testée.*</span><span class="sxs-lookup"><span data-stu-id="d5776-394">*"SUT" is used throughout this topic to refer to the tested ASP.NET Core app.*</span></span>

## <a name="aspnet-core-integration-tests"></a><span data-ttu-id="d5776-395">tests d’intégration de base ASP.NET</span><span class="sxs-lookup"><span data-stu-id="d5776-395">ASP.NET Core integration tests</span></span>

<span data-ttu-id="d5776-396">Les tests d’intégration dans ASP.NET Core exigent ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="d5776-396">Integration tests in ASP.NET Core require the following:</span></span>

* <span data-ttu-id="d5776-397">Un projet de test est utilisé pour contenir et exécuter les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-397">A test project is used to contain and execute the tests.</span></span> <span data-ttu-id="d5776-398">Le projet d’essai a une référence au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-398">The test project has a reference to the SUT.</span></span>
* <span data-ttu-id="d5776-399">Le projet de test crée un hébergeur de test pour le SUT et utilise un client serveur de test pour traiter les demandes et les réponses avec le SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-399">The test project creates a test web host for the SUT and uses a test server client to handle requests and responses with the SUT.</span></span>
* <span data-ttu-id="d5776-400">Un coureur de test est utilisé pour exécuter les tests et signaler les résultats des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-400">A test runner is used to execute the tests and report the test results.</span></span>

<span data-ttu-id="d5776-401">Les tests d’intégration suivent une séquence d’événements qui comprennent les étapes *habituelles d’arrangement,* *d’acte*et *d’essai d’Assert* :</span><span class="sxs-lookup"><span data-stu-id="d5776-401">Integration tests follow a sequence of events that include the usual *Arrange*, *Act*, and *Assert* test steps:</span></span>

1. <span data-ttu-id="d5776-402">L’hébergeur du SUT est configuré.</span><span class="sxs-lookup"><span data-stu-id="d5776-402">The SUT's web host is configured.</span></span>
1. <span data-ttu-id="d5776-403">Un client serveur de test est créé pour soumettre des demandes à l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-403">A test server client is created to submit requests to the app.</span></span>
1. <span data-ttu-id="d5776-404">*L’étape de* test Arrange est exécutée : l’application de test prépare une demande.</span><span class="sxs-lookup"><span data-stu-id="d5776-404">The *Arrange* test step is executed: The test app prepares a request.</span></span>
1. <span data-ttu-id="d5776-405">L’étape de test *de la Loi* est exécutée : le client soumet la demande et reçoit la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5776-405">The *Act* test step is executed: The client submits the request and receives the response.</span></span>
1. <span data-ttu-id="d5776-406">*L’étape* de test Assert est exécutée : la réponse *réelle* est validée en tant que *passage* ou *échec* en fonction d’une réponse *attendue.*</span><span class="sxs-lookup"><span data-stu-id="d5776-406">The *Assert* test step is executed: The *actual* response is validated as a *pass* or *fail* based on an *expected* response.</span></span>
1. <span data-ttu-id="d5776-407">Le processus se poursuit jusqu’à ce que tous les tests soient exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-407">The process continues until all of the tests are executed.</span></span>
1. <span data-ttu-id="d5776-408">Les résultats des tests sont communiqués.</span><span class="sxs-lookup"><span data-stu-id="d5776-408">The test results are reported.</span></span>

<span data-ttu-id="d5776-409">Habituellement, l’hébergeur de test est configuré différemment de l’hébergeur Web normal de l’application pour les essais.</span><span class="sxs-lookup"><span data-stu-id="d5776-409">Usually, the test web host is configured differently than the app's normal web host for the test runs.</span></span> <span data-ttu-id="d5776-410">Par exemple, une base de données différente ou différents paramètres d’application peuvent être utilisés pour les tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-410">For example, a different database or different app settings might be used for the tests.</span></span>

<span data-ttu-id="d5776-411">Les composants d’infrastructure, tels que l’hébergeur de test et le serveur de test en mémoire ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), sont fournis ou gérés par le package [Microsoft.AspNetCore.Mvc.Testing.](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing)</span><span class="sxs-lookup"><span data-stu-id="d5776-411">Infrastructure components, such as the test web host and in-memory test server ([TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver)), are provided or managed by the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package.</span></span> <span data-ttu-id="d5776-412">L’utilisation de ce paquet simplifie la création et l’exécution des tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-412">Use of this package streamlines test creation and execution.</span></span>

<span data-ttu-id="d5776-413">Le `Microsoft.AspNetCore.Mvc.Testing` paquet s’occupe des tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-413">The `Microsoft.AspNetCore.Mvc.Testing` package handles the following tasks:</span></span>

* <span data-ttu-id="d5776-414">Copies du fichier des dépendances (*.deps*) de la SUT dans l’annuaire *des bacs* du projet d’essai.</span><span class="sxs-lookup"><span data-stu-id="d5776-414">Copies the dependencies file (*.deps*) from the SUT into the test project's *bin* directory.</span></span>
* <span data-ttu-id="d5776-415">Définit la racine de [contenu](xref:fundamentals/index#content-root) à la racine du projet du SUT de sorte que des fichiers statiques et des pages/vues sont trouvés lorsque les tests sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-415">Sets the [content root](xref:fundamentals/index#content-root) to the SUT's project root so that static files and pages/views are found when the tests are executed.</span></span>
* <span data-ttu-id="d5776-416">Fournit la classe [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) pour rationaliser bootstrapping le SUT avec `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="d5776-416">Provides the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) class to streamline bootstrapping the SUT with `TestServer`.</span></span>

<span data-ttu-id="d5776-417">La documentation [des tests unitaire](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) décrit comment mettre en place un projet d’essai et un coureur d’essai, ainsi que des instructions détaillées sur la façon d’exécuter des tests et des recommandations sur la façon de nommer les tests et les classes de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-417">The [unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) documentation describes how to set up a test project and test runner, along with detailed instructions on how to run tests and recommendations for how to name tests and test classes.</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-418">Lors de la création d’un projet de test pour une application, séparez les tests unitaires des tests d’intégration dans différents projets.</span><span class="sxs-lookup"><span data-stu-id="d5776-418">When creating a test project for an app, separate the unit tests from the integration tests into different projects.</span></span> <span data-ttu-id="d5776-419">Cela permet de s’assurer que les composants d’analyse d’infrastructure ne sont pas accidentellement inclus dans les tests unitaires.</span><span class="sxs-lookup"><span data-stu-id="d5776-419">This helps ensure that infrastructure testing components aren't accidentally included in the unit tests.</span></span> <span data-ttu-id="d5776-420">La séparation des tests d’unité et d’intégration permet également de contrôler l’ensemble des tests qui sont exécutés.</span><span class="sxs-lookup"><span data-stu-id="d5776-420">Separation of unit and integration tests also allows control over which set of tests are run.</span></span>

<span data-ttu-id="d5776-421">Il n’y a pratiquement aucune différence entre la configuration pour les tests des applications Razor Pages et les applications MVC.</span><span class="sxs-lookup"><span data-stu-id="d5776-421">There's virtually no difference between the configuration for tests of Razor Pages apps and MVC apps.</span></span> <span data-ttu-id="d5776-422">La seule différence réside dans la façon dont les tests sont nommés.</span><span class="sxs-lookup"><span data-stu-id="d5776-422">The only difference is in how the tests are named.</span></span> <span data-ttu-id="d5776-423">Dans une application Razor Pages, les tests des paramètres de page sont `IndexPageTests` généralement nommés d’après la classe de modèle de page (par exemple, pour tester l’intégration des composants pour la page Index).</span><span class="sxs-lookup"><span data-stu-id="d5776-423">In a Razor Pages app, tests of page endpoints are usually named after the page model class (for example, `IndexPageTests` to test component integration for the Index page).</span></span> <span data-ttu-id="d5776-424">Dans une application MVC, les tests sont généralement organisés par des classes `HomeControllerTests` de contrôleur et nommés d’après les contrôleurs qu’ils testent (par exemple, pour tester l’intégration des composants pour le contrôleur à domicile).</span><span class="sxs-lookup"><span data-stu-id="d5776-424">In an MVC app, tests are usually organized by controller classes and named after the controllers they test (for example, `HomeControllerTests` to test component integration for the Home controller).</span></span>

## <a name="test-app-prerequisites"></a><span data-ttu-id="d5776-425">Conditions préalables de l’application de test</span><span class="sxs-lookup"><span data-stu-id="d5776-425">Test app prerequisites</span></span>

<span data-ttu-id="d5776-426">Le projet d’essai doit :</span><span class="sxs-lookup"><span data-stu-id="d5776-426">The test project must:</span></span>

* <span data-ttu-id="d5776-427">Référence des paquets suivants :</span><span class="sxs-lookup"><span data-stu-id="d5776-427">Reference the following packages:</span></span>
  * [<span data-ttu-id="d5776-428">Microsoft.AspNetCore.App</span><span class="sxs-lookup"><span data-stu-id="d5776-428">Microsoft.AspNetCore.App</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.App/)
  * [<span data-ttu-id="d5776-429">Microsoft.AspNetCore.Mvc.Testing (en anglais seulement)</span><span class="sxs-lookup"><span data-stu-id="d5776-429">Microsoft.AspNetCore.Mvc.Testing</span></span>](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing/)
* <span data-ttu-id="d5776-430">Spécifiez le SDK`<Project Sdk="Microsoft.NET.Sdk.Web">`Web dans le fichier du projet ( ).</span><span class="sxs-lookup"><span data-stu-id="d5776-430">Specify the Web SDK in the project file (`<Project Sdk="Microsoft.NET.Sdk.Web">`).</span></span> <span data-ttu-id="d5776-431">Le Web SDK est nécessaire lors du référencement de la [métapackage Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app).</span><span class="sxs-lookup"><span data-stu-id="d5776-431">The Web SDK is required when referencing the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app).</span></span>

<span data-ttu-id="d5776-432">Ces conditions préalables peuvent être vues dans [l’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span><span class="sxs-lookup"><span data-stu-id="d5776-432">These prerequisites can be seen in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/).</span></span> <span data-ttu-id="d5776-433">Inspectez les *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj.*</span><span class="sxs-lookup"><span data-stu-id="d5776-433">Inspect the *tests/RazorPagesProject.Tests/RazorPagesProject.Tests.csproj* file.</span></span> <span data-ttu-id="d5776-434">L’application d’échantillon utilise le cadre de test [xUnit](https://xunit.github.io/) et la bibliothèque de parser [AngleSharp,](https://anglesharp.github.io/) de sorte que l’application d’échantillon fait également référence :</span><span class="sxs-lookup"><span data-stu-id="d5776-434">The sample app uses the [xUnit](https://xunit.github.io/) test framework and the [AngleSharp](https://anglesharp.github.io/) parser library, so the sample app also references:</span></span>

* [<span data-ttu-id="d5776-435">xunit</span><span class="sxs-lookup"><span data-stu-id="d5776-435">xunit</span></span>](https://www.nuget.org/packages/xunit/)
* [<span data-ttu-id="d5776-436">xunit.runner.visualstudio</span><span class="sxs-lookup"><span data-stu-id="d5776-436">xunit.runner.visualstudio</span></span>](https://www.nuget.org/packages/xunit.runner.visualstudio/)
* [<span data-ttu-id="d5776-437">AngleSharp (angleSharp)</span><span class="sxs-lookup"><span data-stu-id="d5776-437">AngleSharp</span></span>](https://www.nuget.org/packages/AngleSharp/)

## <a name="sut-environment"></a><span data-ttu-id="d5776-438">Environnement SUT</span><span class="sxs-lookup"><span data-stu-id="d5776-438">SUT environment</span></span>

<span data-ttu-id="d5776-439">Si [l’environnement](xref:fundamentals/environments) du SUT n’est pas défini, l’environnement est par défaut pour le développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-439">If the SUT's [environment](xref:fundamentals/environments) isn't set, the environment defaults to Development.</span></span>

## <a name="basic-tests-with-the-default-webapplicationfactory"></a><span data-ttu-id="d5776-440">Tests de base avec la webApplicationFactory par défaut</span><span class="sxs-lookup"><span data-stu-id="d5776-440">Basic tests with the default WebApplicationFactory</span></span>

<span data-ttu-id="d5776-441">[WebApplicationFactory\<TEntryPoint>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) est utilisé pour créer un [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) pour les tests d’intégration.</span><span class="sxs-lookup"><span data-stu-id="d5776-441">[WebApplicationFactory\<TEntryPoint>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1) is used to create a [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) for the integration tests.</span></span> <span data-ttu-id="d5776-442">`TEntryPoint`est la classe de point d’entrée du SUT, généralement la `Startup` classe.</span><span class="sxs-lookup"><span data-stu-id="d5776-442">`TEntryPoint` is the entry point class of the SUT, usually the `Startup` class.</span></span>

<span data-ttu-id="d5776-443">Les classes de test implémentent une interface *de montage* de classe ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) pour indiquer que la classe contient des tests et fournissent des instances d’objets partagés à travers les tests de la classe.</span><span class="sxs-lookup"><span data-stu-id="d5776-443">Test classes implement a *class fixture* interface ([IClassFixture](https://xunit.github.io/docs/shared-context#class-fixture)) to indicate the class contains tests and provide shared object instances across the tests in the class.</span></span>

<span data-ttu-id="d5776-444">La classe `BasicTests`d’essai `WebApplicationFactory` suivante, , utilise le bootstrap le SUT `Get_EndpointsReturnSuccessAndCorrectContentType`et de fournir un [HttpClient](/dotnet/api/system.net.http.httpclient) à une méthode d’essai, .</span><span class="sxs-lookup"><span data-stu-id="d5776-444">The following test class, `BasicTests`, uses the `WebApplicationFactory` to bootstrap the SUT and provide an [HttpClient](/dotnet/api/system.net.http.httpclient) to a test method, `Get_EndpointsReturnSuccessAndCorrectContentType`.</span></span> <span data-ttu-id="d5776-445">La méthode vérifie si le code d’état de réponse est réussi (codes d’état dans la plage 200-299) et l’en-tête `Content-Type` est `text/html; charset=utf-8` pour plusieurs pages d’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-445">The method checks if the response status code is successful (status codes in the range 200-299) and the `Content-Type` header is `text/html; charset=utf-8` for several app pages.</span></span>

<span data-ttu-id="d5776-446">[CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) crée un `HttpClient` exemple qui suit automatiquement les redirections et gère les cookies.</span><span class="sxs-lookup"><span data-stu-id="d5776-446">[CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) creates an instance of `HttpClient` that automatically follows redirects and handles cookies.</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/BasicTests.cs?name=snippet1)]

<span data-ttu-id="d5776-447">Par défaut, les cookies non essentiels ne sont pas conservés entre les demandes lorsque la [politique de consentement GDPR](xref:security/gdpr) est activée.</span><span class="sxs-lookup"><span data-stu-id="d5776-447">By default, non-essential cookies aren't preserved across requests when the [GDPR consent policy](xref:security/gdpr) is enabled.</span></span> <span data-ttu-id="d5776-448">Pour préserver les cookies non essentiels, tels que ceux utilisés par le fournisseur TempData, marquez-les comme essentiels dans vos tests.</span><span class="sxs-lookup"><span data-stu-id="d5776-448">To preserve non-essential cookies, such as those used by the TempData provider, mark them as essential in your tests.</span></span> <span data-ttu-id="d5776-449">Pour obtenir des instructions sur le marquage d’un cookie comme essentiel, voir [les cookies Essentiels](xref:security/gdpr#essential-cookies).</span><span class="sxs-lookup"><span data-stu-id="d5776-449">For instructions on marking a cookie as essential, see [Essential cookies](xref:security/gdpr#essential-cookies).</span></span>

## <a name="customize-webapplicationfactory"></a><span data-ttu-id="d5776-450">Personnaliser WebApplicationFactory</span><span class="sxs-lookup"><span data-stu-id="d5776-450">Customize WebApplicationFactory</span></span>

<span data-ttu-id="d5776-451">La configuration de l’hôte Web peut être `WebApplicationFactory` créée indépendamment des classes de test en héritant de créer une ou plusieurs usines personnalisées :</span><span class="sxs-lookup"><span data-stu-id="d5776-451">Web host configuration can be created independently of the test classes by inheriting from `WebApplicationFactory` to create one or more custom factories:</span></span>

1. <span data-ttu-id="d5776-452">Héritez de `WebApplicationFactory` [configureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost)et remplacez.</span><span class="sxs-lookup"><span data-stu-id="d5776-452">Inherit from `WebApplicationFactory` and override [ConfigureWebHost](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.configurewebhost).</span></span> <span data-ttu-id="d5776-453">[L’IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) permet la configuration de la collection de services avec [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span><span class="sxs-lookup"><span data-stu-id="d5776-453">The [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) allows the configuration of the service collection with [ConfigureServices](/dotnet/api/microsoft.aspnetcore.hosting.istartup.configureservices):</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/CustomWebApplicationFactory.cs?name=snippet1)]

   <span data-ttu-id="d5776-454">L’ensemencement de base `InitializeDbForTests` de données dans l’application [d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) est effectué par la méthode.</span><span class="sxs-lookup"><span data-stu-id="d5776-454">Database seeding in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is performed by the `InitializeDbForTests` method.</span></span> <span data-ttu-id="d5776-455">La méthode est décrite dans [l’échantillon de tests d’intégration : Section de l’organisation des applications de test.](#test-app-organization)</span><span class="sxs-lookup"><span data-stu-id="d5776-455">The method is described in the [Integration tests sample: Test app organization](#test-app-organization) section.</span></span>

2. <span data-ttu-id="d5776-456">Utilisez la `CustomWebApplicationFactory` coutume dans les classes de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-456">Use the custom `CustomWebApplicationFactory` in test classes.</span></span> <span data-ttu-id="d5776-457">L’exemple suivant utilise `IndexPageTests` l’usine de la classe :</span><span class="sxs-lookup"><span data-stu-id="d5776-457">The following example uses the factory in the `IndexPageTests` class:</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet1)]

   <span data-ttu-id="d5776-458">Le client de l’application de `HttpClient` l’échantillon est configuré pour empêcher les redirections suivantes.</span><span class="sxs-lookup"><span data-stu-id="d5776-458">The sample app's client is configured to prevent the `HttpClient` from following redirects.</span></span> <span data-ttu-id="d5776-459">Comme expliqué plus tard dans la section [d’authentification Mock,](#mock-authentication) cela permet aux tests de vérifier le résultat de la première réponse de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-459">As explained later in the [Mock authentication](#mock-authentication) section, this permits tests to check the result of the app's first response.</span></span> <span data-ttu-id="d5776-460">La première réponse est une redirection `Location` dans beaucoup de ces tests avec un en-tête.</span><span class="sxs-lookup"><span data-stu-id="d5776-460">The first response is a redirect in many of these tests with a `Location` header.</span></span>

3. <span data-ttu-id="d5776-461">Un test typique `HttpClient` utilise les méthodes et les méthodes d’aide pour traiter la demande et la réponse :</span><span class="sxs-lookup"><span data-stu-id="d5776-461">A typical test uses the `HttpClient` and helper methods to process the request and the response:</span></span>

   [!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet2)]

<span data-ttu-id="d5776-462">Toute demande POST au SUT doit satisfaire le contrôle antiforgery qui est automatiquement faite par le [système antiforgery](xref:security/data-protection/introduction)de protection des données de l’application .</span><span class="sxs-lookup"><span data-stu-id="d5776-462">Any POST request to the SUT must satisfy the antiforgery check that's automatically made by the app's [data protection antiforgery system](xref:security/data-protection/introduction).</span></span> <span data-ttu-id="d5776-463">Afin d’organiser la demande POST d’un test, l’application de test doit :</span><span class="sxs-lookup"><span data-stu-id="d5776-463">In order to arrange for a test's POST request, the test app must:</span></span>

1. <span data-ttu-id="d5776-464">Faites une demande pour la page.</span><span class="sxs-lookup"><span data-stu-id="d5776-464">Make a request for the page.</span></span>
1. <span data-ttu-id="d5776-465">Parse le cookie antiforgery et demander le jeton de validation de la réponse.</span><span class="sxs-lookup"><span data-stu-id="d5776-465">Parse the antiforgery cookie and request validation token from the response.</span></span>
1. <span data-ttu-id="d5776-466">Faites la demande POST avec le cookie antiforgery et demandez le jeton de validation en place.</span><span class="sxs-lookup"><span data-stu-id="d5776-466">Make the POST request with the antiforgery cookie and request validation token in place.</span></span>

<span data-ttu-id="d5776-467">Les `SendAsync` méthodes d’extension de l’aide (*Helpers/HttpClientExtensions.cs*) et `GetDocumentAsync` la méthode d’aide *(Helpers/HtmlHelpers.cs*) dans [l’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) utilisent le parser [AngleSharp](https://anglesharp.github.io/) pour manipuler le contrôle antiforgery avec les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-467">The `SendAsync` helper extension methods (*Helpers/HttpClientExtensions.cs*) and the `GetDocumentAsync` helper method (*Helpers/HtmlHelpers.cs*) in the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/) use the [AngleSharp](https://anglesharp.github.io/) parser to handle the antiforgery check with the following methods:</span></span>

* <span data-ttu-id="d5776-468">`GetDocumentAsync`&ndash; Reçoit le [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) `IHtmlDocument`et retourne un .</span><span class="sxs-lookup"><span data-stu-id="d5776-468">`GetDocumentAsync` &ndash; Receives the [HttpResponseMessage](/dotnet/api/system.net.http.httpresponsemessage) and returns an `IHtmlDocument`.</span></span> <span data-ttu-id="d5776-469">`GetDocumentAsync`utilise une usine qui prépare une réponse `HttpResponseMessage` *virtuelle* basée sur l’original .</span><span class="sxs-lookup"><span data-stu-id="d5776-469">`GetDocumentAsync` uses a factory that prepares a *virtual response* based on the original `HttpResponseMessage`.</span></span> <span data-ttu-id="d5776-470">Pour plus d’informations, voir la [documentation AngleSharp](https://github.com/AngleSharp/AngleSharp#documentation).</span><span class="sxs-lookup"><span data-stu-id="d5776-470">For more information, see the [AngleSharp documentation](https://github.com/AngleSharp/AngleSharp#documentation).</span></span>
* <span data-ttu-id="d5776-471">`SendAsync`méthodes d’extension pour la `HttpClient` composition d’un [httpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) et appeler [SendAsync (HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) pour soumettre des demandes au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-471">`SendAsync` extension methods for the `HttpClient` compose an [HttpRequestMessage](/dotnet/api/system.net.http.httprequestmessage) and call [SendAsync(HttpRequestMessage)](/dotnet/api/system.net.http.httpclient.sendasync#System_Net_Http_HttpClient_SendAsync_System_Net_Http_HttpRequestMessage_) to submit requests to the SUT.</span></span> <span data-ttu-id="d5776-472">Surcharges pour `SendAsync` accepter le`IHtmlFormElement`formulaire HTML ( ) et ce qui suit:</span><span class="sxs-lookup"><span data-stu-id="d5776-472">Overloads for `SendAsync` accept the HTML form (`IHtmlFormElement`) and the following:</span></span>
  * <span data-ttu-id="d5776-473">Soumettre le bouton`IHtmlElement`du formulaire ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-473">Submit button of the form (`IHtmlElement`)</span></span>
  * <span data-ttu-id="d5776-474">Collection de`IEnumerable<KeyValuePair<string, string>>`valeurs de formulaire ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-474">Form values collection (`IEnumerable<KeyValuePair<string, string>>`)</span></span>
  * <span data-ttu-id="d5776-475">Soumettre des`IHtmlElement`valeurs de`IEnumerable<KeyValuePair<string, string>>`bouton ( ) et de forme ( )</span><span class="sxs-lookup"><span data-stu-id="d5776-475">Submit button (`IHtmlElement`) and form values (`IEnumerable<KeyValuePair<string, string>>`)</span></span>

> [!NOTE]
> <span data-ttu-id="d5776-476">[AngleSharp](https://anglesharp.github.io/) est une bibliothèque d’analyse tierce utilisée à des fins de démonstration dans ce sujet et l’application d’échantillon.</span><span class="sxs-lookup"><span data-stu-id="d5776-476">[AngleSharp](https://anglesharp.github.io/) is a third-party parsing library used for demonstration purposes in this topic and the sample app.</span></span> <span data-ttu-id="d5776-477">AngleSharp n’est pas pris en charge ou requis pour les tests d’intégration des applications ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="d5776-477">AngleSharp isn't supported or required for integration testing of ASP.NET Core apps.</span></span> <span data-ttu-id="d5776-478">D’autres analyseurs peuvent être utilisés, tels que le [Pack d’agilité Html (HAP)](https://html-agility-pack.net/).</span><span class="sxs-lookup"><span data-stu-id="d5776-478">Other parsers can be used, such as the [Html Agility Pack (HAP)](https://html-agility-pack.net/).</span></span> <span data-ttu-id="d5776-479">Une autre approche consiste à écrire du code pour gérer directement le jeton de vérification des demandes et le cookie antiforgery du système antiforgery.</span><span class="sxs-lookup"><span data-stu-id="d5776-479">Another approach is to write code to handle the antiforgery system's request verification token and antiforgery cookie directly.</span></span>

## <a name="customize-the-client-with-withwebhostbuilder"></a><span data-ttu-id="d5776-480">Personnalisez le client avec WithWebHostBuilder</span><span class="sxs-lookup"><span data-stu-id="d5776-480">Customize the client with WithWebHostBuilder</span></span>

<span data-ttu-id="d5776-481">Lorsque une configuration supplémentaire est nécessaire dans une méthode `WebApplicationFactory` de test, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) crée un nouveau avec un [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) qui est encore personnalisé par configuration.</span><span class="sxs-lookup"><span data-stu-id="d5776-481">When additional configuration is required within a test method, [WithWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.withwebhostbuilder) creates a new `WebApplicationFactory` with an [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) that is further customized by configuration.</span></span>

<span data-ttu-id="d5776-482">La `Post_DeleteMessageHandler_ReturnsRedirectToRoot` méthode de test de l’application [d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) démontre l’utilisation de `WithWebHostBuilder`.</span><span class="sxs-lookup"><span data-stu-id="d5776-482">The `Post_DeleteMessageHandler_ReturnsRedirectToRoot` test method of the [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) demonstrates the use of `WithWebHostBuilder`.</span></span> <span data-ttu-id="d5776-483">Ce test effectue une suppression d’enregistrements dans la base de données en déclenchant une soumission de formulaire dans le SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-483">This test performs a record delete in the database by triggering a form submission in the SUT.</span></span>

<span data-ttu-id="d5776-484">Étant donné qu’un autre test de la `IndexPageTests` classe effectue une opération qui `Post_DeleteMessageHandler_ReturnsRedirectToRoot` supprime tous les enregistrements de la base de données et peut s’exécuter avant la méthode, la base de données est réédée dans cette méthode de test pour s’assurer qu’un enregistrement est présent pour que le SUT puisse le supprimer.</span><span class="sxs-lookup"><span data-stu-id="d5776-484">Because another test in the `IndexPageTests` class performs an operation that deletes all of the records in the database and may run before the `Post_DeleteMessageHandler_ReturnsRedirectToRoot` method, the database is reseeded in this test method to ensure that a record is present for the SUT to delete.</span></span> <span data-ttu-id="d5776-485">La sélection du premier `messages` bouton de suppression du formulaire dans le SUT est simulée dans la demande au SUT :</span><span class="sxs-lookup"><span data-stu-id="d5776-485">Selecting the first delete button of the `messages` form in the SUT is simulated in the request to the SUT:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet3)]

## <a name="client-options"></a><span data-ttu-id="d5776-486">Options clients</span><span class="sxs-lookup"><span data-stu-id="d5776-486">Client options</span></span>

<span data-ttu-id="d5776-487">Le tableau suivant affiche la valeur Par défaut [de WebApplicationFactoryClientOptions disponibles](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) lors de la création d’instances. `HttpClient`</span><span class="sxs-lookup"><span data-stu-id="d5776-487">The following table shows the default [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) available when creating `HttpClient` instances.</span></span>

| <span data-ttu-id="d5776-488">Option</span><span class="sxs-lookup"><span data-stu-id="d5776-488">Option</span></span> | <span data-ttu-id="d5776-489">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-489">Description</span></span> | <span data-ttu-id="d5776-490">Default</span><span class="sxs-lookup"><span data-stu-id="d5776-490">Default</span></span> |
| ------ | ----------- | ------- |
| [<span data-ttu-id="d5776-491">AutoriserAutoRedirect</span><span class="sxs-lookup"><span data-stu-id="d5776-491">AllowAutoRedirect</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) | <span data-ttu-id="d5776-492">Obtient ou définit `HttpClient` si les instances doivent suivre automatiquement les réponses de redirection.</span><span class="sxs-lookup"><span data-stu-id="d5776-492">Gets or sets whether or not `HttpClient` instances should automatically follow redirect responses.</span></span> | `true` |
| [<span data-ttu-id="d5776-493">BaseAddress (baseAddress)</span><span class="sxs-lookup"><span data-stu-id="d5776-493">BaseAddress</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.baseaddress) | <span data-ttu-id="d5776-494">Obtient ou définit l’adresse de base des `HttpClient` instances.</span><span class="sxs-lookup"><span data-stu-id="d5776-494">Gets or sets the base address of `HttpClient` instances.</span></span> | `http://localhost` |
| [<span data-ttu-id="d5776-495">HandleCookies (en)</span><span class="sxs-lookup"><span data-stu-id="d5776-495">HandleCookies</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.handlecookies) | <span data-ttu-id="d5776-496">Obtient ou `HttpClient` définit si les instances doivent gérer les cookies.</span><span class="sxs-lookup"><span data-stu-id="d5776-496">Gets or sets whether `HttpClient` instances should handle cookies.</span></span> | `true` |
| [<span data-ttu-id="d5776-497">MaxAutomaticRedirections</span><span class="sxs-lookup"><span data-stu-id="d5776-497">MaxAutomaticRedirections</span></span>](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.maxautomaticredirections) | <span data-ttu-id="d5776-498">Obtient ou définit le nombre maximum `HttpClient` de réponses de redirection que les instances doivent suivre.</span><span class="sxs-lookup"><span data-stu-id="d5776-498">Gets or sets the maximum number of redirect responses that `HttpClient` instances should follow.</span></span> | <span data-ttu-id="d5776-499">7</span><span class="sxs-lookup"><span data-stu-id="d5776-499">7</span></span> |

<span data-ttu-id="d5776-500">Créez `WebApplicationFactoryClientOptions` la classe et transmettez-la à la méthode [CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) (les valeurs par défaut sont affichées dans l’exemple du code) :</span><span class="sxs-lookup"><span data-stu-id="d5776-500">Create the `WebApplicationFactoryClientOptions` class and pass it to the [CreateClient](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createclient) method (default values are shown in the code example):</span></span>

```csharp
// Default client option values are shown
var clientOptions = new WebApplicationFactoryClientOptions();
clientOptions.AllowAutoRedirect = true;
clientOptions.BaseAddress = new Uri("http://localhost");
clientOptions.HandleCookies = true;
clientOptions.MaxAutomaticRedirections = 7;

_client = _factory.CreateClient(clientOptions);
```

## <a name="inject-mock-services"></a><span data-ttu-id="d5776-501">Injecter des services fictifs</span><span class="sxs-lookup"><span data-stu-id="d5776-501">Inject mock services</span></span>

<span data-ttu-id="d5776-502">Les services peuvent être remplacés lors d’un test avec un appel à [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) sur le constructeur hôte.</span><span class="sxs-lookup"><span data-stu-id="d5776-502">Services can be overridden in a test with a call to [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) on the host builder.</span></span> <span data-ttu-id="d5776-503">**Pour injecter des services fictifs, `Startup` le `Startup.ConfigureServices` SUT doit avoir une classe avec une méthode.**</span><span class="sxs-lookup"><span data-stu-id="d5776-503">**To inject mock services, the SUT must have a `Startup` class with a `Startup.ConfigureServices` method.**</span></span>

<span data-ttu-id="d5776-504">L’échantillon SUT comprend un service à portée qui renvoie un devis.</span><span class="sxs-lookup"><span data-stu-id="d5776-504">The sample SUT includes a scoped service that returns a quote.</span></span> <span data-ttu-id="d5776-505">La citation est intégrée dans un champ caché sur la page Index lorsque la page Index est demandée.</span><span class="sxs-lookup"><span data-stu-id="d5776-505">The quote is embedded in a hidden field on the Index page when the Index page is requested.</span></span>

<span data-ttu-id="d5776-506">*Services/IQuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-506">*Services/IQuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Services/IQuoteService.cs?name=snippet1)]

<span data-ttu-id="d5776-507">*Services/QuoteService.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-507">*Services/QuoteService.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Services/QuoteService.cs?name=snippet1)]

<span data-ttu-id="d5776-508">*Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-508">*Startup.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet2)]

<span data-ttu-id="d5776-509">*Pages/Index.cshtml.cs* :</span><span class="sxs-lookup"><span data-stu-id="d5776-509">*Pages/Index.cshtml.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml.cs?name=snippet1&highlight=4,9,20,26)]

<span data-ttu-id="d5776-510">*Pages/Index.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-510">*Pages/Index.cs*:</span></span>

[!code-cshtml[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Pages/Index.cshtml?name=snippet_Quote)]

<span data-ttu-id="d5776-511">La balisage suivante est générée lorsque l’application SUT est exécutée :</span><span class="sxs-lookup"><span data-stu-id="d5776-511">The following markup is generated when the SUT app is run:</span></span>

```html
<input id="quote" type="hidden" value="Come on, Sarah. We&#x27;ve an appointment in 
    London, and we&#x27;re already 30,000 years late.">
```

<span data-ttu-id="d5776-512">Pour tester le service et citer l’injection dans un test d’intégration, un service de simulation est injecté dans le SUT par le test.</span><span class="sxs-lookup"><span data-stu-id="d5776-512">To test the service and quote injection in an integration test, a mock service is injected into the SUT by the test.</span></span> <span data-ttu-id="d5776-513">Le service de simulation remplace `QuoteService` l’application par un service `TestQuoteService`fourni par l’application de test, appelé :</span><span class="sxs-lookup"><span data-stu-id="d5776-513">The mock service replaces the app's `QuoteService` with a service provided by the test app, called `TestQuoteService`:</span></span>

<span data-ttu-id="d5776-514">*IntegrationTests.IndexPageTests.cs*:</span><span class="sxs-lookup"><span data-stu-id="d5776-514">*IntegrationTests.IndexPageTests.cs*:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet4)]

<span data-ttu-id="d5776-515">`ConfigureTestServices`est appelé, et le service de portée est enregistré:</span><span class="sxs-lookup"><span data-stu-id="d5776-515">`ConfigureTestServices` is called, and the scoped service is registered:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/IndexPageTests.cs?name=snippet5&highlight=7-10,17,20-21)]

<span data-ttu-id="d5776-516">La majoration produite lors de l’exécution du `TestQuoteService`test reflète le texte de citation fourni par , donc l’affirmation passe:</span><span class="sxs-lookup"><span data-stu-id="d5776-516">The markup produced during the test's execution reflects the quote text supplied by `TestQuoteService`, thus the assertion passes:</span></span>

```html
<input id="quote" type="hidden" value="Something&#x27;s interfering with time, 
    Mr. Scarman, and time is my business.">
```

## <a name="mock-authentication"></a><span data-ttu-id="d5776-517">Authentification simulée</span><span class="sxs-lookup"><span data-stu-id="d5776-517">Mock authentication</span></span>

<span data-ttu-id="d5776-518">Les tests `AuthTests` dans la classe vérifient qu’un point de terminaison sécurisé :</span><span class="sxs-lookup"><span data-stu-id="d5776-518">Tests in the `AuthTests` class check that a secure endpoint:</span></span>

* <span data-ttu-id="d5776-519">Redirige un utilisateur non authentique vers la page Login de l’application.</span><span class="sxs-lookup"><span data-stu-id="d5776-519">Redirects an unauthenticated user to the app's Login page.</span></span>
* <span data-ttu-id="d5776-520">Retourne le contenu d’un utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="d5776-520">Returns content for an authenticated user.</span></span>

<span data-ttu-id="d5776-521">Dans le SUT, la `/SecurePage` page utilise une convention [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) pour appliquer un [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) à la page.</span><span class="sxs-lookup"><span data-stu-id="d5776-521">In the SUT, the `/SecurePage` page uses an [AuthorizePage](/dotnet/api/microsoft.extensions.dependencyinjection.pageconventioncollectionextensions.authorizepage) convention to apply an [AuthorizeFilter](/dotnet/api/microsoft.aspnetcore.mvc.authorization.authorizefilter) to the page.</span></span> <span data-ttu-id="d5776-522">Pour plus d’informations, voir [les conventions d’autorisation de Razor Pages](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span><span class="sxs-lookup"><span data-stu-id="d5776-522">For more information, see [Razor Pages authorization conventions](xref:security/authorization/razor-pages-authorization#require-authorization-to-access-a-page).</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/src/RazorPagesProject/Startup.cs?name=snippet1)]

<span data-ttu-id="d5776-523">Dans `Get_SecurePageRedirectsAnUnauthenticatedUser` le test, un [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) est configuré pour refuser `false`les redirections en définissant [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) à :</span><span class="sxs-lookup"><span data-stu-id="d5776-523">In the `Get_SecurePageRedirectsAnUnauthenticatedUser` test, a [WebApplicationFactoryClientOptions](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions) is set to disallow redirects by setting [AllowAutoRedirect](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactoryclientoptions.allowautoredirect) to `false`:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet2)]

<span data-ttu-id="d5776-524">En interdisant au client de suivre la redirection, les vérifications suivantes peuvent être effectuées :</span><span class="sxs-lookup"><span data-stu-id="d5776-524">By disallowing the client to follow the redirect, the following checks can be made:</span></span>

* <span data-ttu-id="d5776-525">Le code d’état retourné par le SUT peut être vérifié par rapport au résultat [attendu httpStatusCode.Redirect,](/dotnet/api/system.net.httpstatuscode) et non au code d’état final après la redirection vers la page Login, qui serait [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span><span class="sxs-lookup"><span data-stu-id="d5776-525">The status code returned by the SUT can be checked against the expected [HttpStatusCode.Redirect](/dotnet/api/system.net.httpstatuscode) result, not the final status code after the redirect to the Login page, which would be [HttpStatusCode.OK](/dotnet/api/system.net.httpstatuscode).</span></span>
* <span data-ttu-id="d5776-526">La `Location` valeur d’en-tête dans les en-têtes de réponse est vérifiée pour confirmer qu’il commence par `http://localhost/Identity/Account/Login`, pas la réponse finale de la page Login, où l’en-tête `Location` ne serait pas présent.</span><span class="sxs-lookup"><span data-stu-id="d5776-526">The `Location` header value in the response headers is checked to confirm that it starts with `http://localhost/Identity/Account/Login`, not the final Login page response, where the `Location` header wouldn't be present.</span></span>

<span data-ttu-id="d5776-527">L’application de <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1> test peut se moquer d’un in [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) afin de tester les aspects de l’authentification et de l’autorisation.</span><span class="sxs-lookup"><span data-stu-id="d5776-527">The test app can mock an <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1> in [ConfigureTestServices](/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestservices) in order to test aspects of authentication and authorization.</span></span> <span data-ttu-id="d5776-528">Un scénario minimal renvoie un [AuthenticateResult.Success](xref:Microsoft.AspNetCore.Authentication.AuthenticateResult.Success*):</span><span class="sxs-lookup"><span data-stu-id="d5776-528">A minimal scenario returns an [AuthenticateResult.Success](xref:Microsoft.AspNetCore.Authentication.AuthenticateResult.Success*):</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet4&highlight=11-18)]

<span data-ttu-id="d5776-529">Le `TestAuthHandler` est appelé à authentifier un utilisateur `Test` `AddAuthentication` lorsque le `ConfigureTestServices`système d’authentification est réglé à l’endroit où est enregistré pour :</span><span class="sxs-lookup"><span data-stu-id="d5776-529">The `TestAuthHandler` is called to authenticate a user when the authentication scheme is set to `Test` where `AddAuthentication` is registered for `ConfigureTestServices`:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/IntegrationTests/AuthTests.cs?name=snippet3&highlight=7-12)]

<span data-ttu-id="d5776-530">Pour plus `WebApplicationFactoryClientOptions`d’informations sur , voir la section [options Client.](#client-options)</span><span class="sxs-lookup"><span data-stu-id="d5776-530">For more information on `WebApplicationFactoryClientOptions`, see the [Client options](#client-options) section.</span></span>

## <a name="set-the-environment"></a><span data-ttu-id="d5776-531">Définir l’environnement</span><span class="sxs-lookup"><span data-stu-id="d5776-531">Set the environment</span></span>

<span data-ttu-id="d5776-532">Par défaut, l’environnement d’hôte et d’application du SUT est configuré pour utiliser l’environnement de développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-532">By default, the SUT's host and app environment is configured to use the Development environment.</span></span> <span data-ttu-id="d5776-533">Pour remplacer l’environnement du SUT :</span><span class="sxs-lookup"><span data-stu-id="d5776-533">To override the SUT's environment:</span></span>

* <span data-ttu-id="d5776-534">Définissez `ASPNETCORE_ENVIRONMENT` la variable de `Staging` `Production`l’environnement (par exemple, , , ou toute autre valeur personnalisée, telle que `Testing`).</span><span class="sxs-lookup"><span data-stu-id="d5776-534">Set the `ASPNETCORE_ENVIRONMENT` environment variable (for example, `Staging`, `Production`, or other custom value, such as `Testing`).</span></span>
* <span data-ttu-id="d5776-535">Remplacer `CreateHostBuilder` dans l’application de test pour `ASPNETCORE`lire les variables de l’environnement préfixées avec .</span><span class="sxs-lookup"><span data-stu-id="d5776-535">Override `CreateHostBuilder` in the test app to read environment variables prefixed with `ASPNETCORE`.</span></span>

```csharp
protected override IHostBuilder CreateHostBuilder() => 
    base.CreateHostBuilder()
        .ConfigureHostConfiguration(
            config => config.AddEnvironmentVariables("ASPNETCORE"));
```

## <a name="how-the-test-infrastructure-infers-the-app-content-root-path"></a><span data-ttu-id="d5776-536">Comment l’infrastructure de test déduit le chemin de racine du contenu de l’application</span><span class="sxs-lookup"><span data-stu-id="d5776-536">How the test infrastructure infers the app content root path</span></span>

<span data-ttu-id="d5776-537">Le `WebApplicationFactory` constructeur déduit le chemin [de racine de contenu](xref:fundamentals/index#content-root) de l’application en recherchant un [WebApplicationFactoryContentRotentAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) sur l’assemblage contenant les tests d’intégration avec une clé égale à l’assemblage `TEntryPoint` `System.Reflection.Assembly.FullName`.</span><span class="sxs-lookup"><span data-stu-id="d5776-537">The `WebApplicationFactory` constructor infers the app [content root](xref:fundamentals/index#content-root) path by searching for a [WebApplicationFactoryContentRootAttribute](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactorycontentrootattribute) on the assembly containing the integration tests with a key equal to the `TEntryPoint` assembly `System.Reflection.Assembly.FullName`.</span></span> <span data-ttu-id="d5776-538">Dans le cas où un attribut `WebApplicationFactory` avec la clé correcte n’est pas trouvé, retombe à la recherche d’un fichier de solution (*.sln*) et joint le nom de l’assemblage `TEntryPoint` à l’annuaire de la solution.</span><span class="sxs-lookup"><span data-stu-id="d5776-538">In case an attribute with the correct key isn't found, `WebApplicationFactory` falls back to searching for a solution file (*.sln*) and appends the `TEntryPoint` assembly name to the solution directory.</span></span> <span data-ttu-id="d5776-539">Le répertoire racine de l’application (le chemin de racine de contenu) est utilisé pour découvrir les vues et les fichiers de contenu.</span><span class="sxs-lookup"><span data-stu-id="d5776-539">The app root directory (the content root path) is used to discover views and content files.</span></span>

## <a name="disable-shadow-copying"></a><span data-ttu-id="d5776-540">Copie d’ombre de désactiver</span><span class="sxs-lookup"><span data-stu-id="d5776-540">Disable shadow copying</span></span>

<span data-ttu-id="d5776-541">La copie d’ombre provoque l’exécution des tests dans un répertoire différent de celui du répertoire de sortie.</span><span class="sxs-lookup"><span data-stu-id="d5776-541">Shadow copying causes the tests to execute in a different directory than the output directory.</span></span> <span data-ttu-id="d5776-542">Pour que les tests fonctionnent correctement, la copie d’ombre doit être désactivée.</span><span class="sxs-lookup"><span data-stu-id="d5776-542">For tests to work properly, shadow copying must be disabled.</span></span> <span data-ttu-id="d5776-543">[L’application d’échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) utilise xUnit et désactive la copie d’ombre pour xUnit en incluant un fichier *xunit.runner.json* avec le réglage de configuration correct.</span><span class="sxs-lookup"><span data-stu-id="d5776-543">The [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) uses xUnit and disables shadow copying for xUnit by including an *xunit.runner.json* file with the correct configuration setting.</span></span> <span data-ttu-id="d5776-544">Pour plus d’informations, voir [Configuring xUnit avec JSON](https://xunit.github.io/docs/configuring-with-json.html).</span><span class="sxs-lookup"><span data-stu-id="d5776-544">For more information, see [Configuring xUnit with JSON](https://xunit.github.io/docs/configuring-with-json.html).</span></span>

<span data-ttu-id="d5776-545">Ajouter le fichier *xunit.runner.json* à la racine du projet de test avec le contenu suivant :</span><span class="sxs-lookup"><span data-stu-id="d5776-545">Add the *xunit.runner.json* file to root of the test project with the following content:</span></span>

```json
{
  "shadowCopy": false
}
```

<span data-ttu-id="d5776-546">Si vous utilisez Visual Studio, définissez la copie du fichier à la propriété **de l’annuaire de sortie** pour copier **toujours**.</span><span class="sxs-lookup"><span data-stu-id="d5776-546">If using Visual Studio, set the file's **Copy to Output Directory** property to **Copy always**.</span></span> <span data-ttu-id="d5776-547">Si vous n’utilisez `Content` pas Visual Studio, ajoutez une cible au fichier de projet de l’application de test :</span><span class="sxs-lookup"><span data-stu-id="d5776-547">If not using Visual Studio, add a `Content` target to the test app's project file:</span></span>

```xml
<ItemGroup>
  <Content Update="xunit.runner.json">
    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
  </Content>
</ItemGroup>
```

## <a name="disposal-of-objects"></a><span data-ttu-id="d5776-548">Élimination des objets</span><span class="sxs-lookup"><span data-stu-id="d5776-548">Disposal of objects</span></span>

<span data-ttu-id="d5776-549">Après l’exécution `IClassFixture` des tests de la mise en œuvre, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) et [HttpClient](/dotnet/api/system.net.http.httpclient) sont éliminés lorsque xUnit dispose de la [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1).</span><span class="sxs-lookup"><span data-stu-id="d5776-549">After the tests of the `IClassFixture` implementation are executed, [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver) and [HttpClient](/dotnet/api/system.net.http.httpclient) are disposed when xUnit disposes of the [WebApplicationFactory](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1).</span></span> <span data-ttu-id="d5776-550">Si les objets instantanés par le développeur nécessitent `IClassFixture` leur élimination, les disposer dans la mise en œuvre.</span><span class="sxs-lookup"><span data-stu-id="d5776-550">If objects instantiated by the developer require disposal, dispose of them in the `IClassFixture` implementation.</span></span> <span data-ttu-id="d5776-551">Pour plus d’informations, voir [Implementing a Dispose method](/dotnet/standard/garbage-collection/implementing-dispose).</span><span class="sxs-lookup"><span data-stu-id="d5776-551">For more information, see [Implementing a Dispose method](/dotnet/standard/garbage-collection/implementing-dispose).</span></span>

## <a name="integration-tests-sample"></a><span data-ttu-id="d5776-552">Échantillon de tests d’intégration</span><span class="sxs-lookup"><span data-stu-id="d5776-552">Integration tests sample</span></span>

<span data-ttu-id="d5776-553">[L’application échantillon](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) est composée de deux applications:</span><span class="sxs-lookup"><span data-stu-id="d5776-553">The [sample app](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples) is composed of two apps:</span></span>

| <span data-ttu-id="d5776-554">Application</span><span class="sxs-lookup"><span data-stu-id="d5776-554">App</span></span> | <span data-ttu-id="d5776-555">Répertoire du projet</span><span class="sxs-lookup"><span data-stu-id="d5776-555">Project directory</span></span> | <span data-ttu-id="d5776-556">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-556">Description</span></span> |
| --- | ----------------- | ----------- |
| <span data-ttu-id="d5776-557">Application de message (le SUT)</span><span class="sxs-lookup"><span data-stu-id="d5776-557">Message app (the SUT)</span></span> | <span data-ttu-id="d5776-558">*src/RazorPagesProjet*</span><span class="sxs-lookup"><span data-stu-id="d5776-558">*src/RazorPagesProject*</span></span> | <span data-ttu-id="d5776-559">Permet à un utilisateur d’en ajouter, de supprimer un, de supprimer tous et d’analyser des messages.</span><span class="sxs-lookup"><span data-stu-id="d5776-559">Allows a user to add, delete one, delete all, and analyze messages.</span></span> |
| <span data-ttu-id="d5776-560">Tester une application</span><span class="sxs-lookup"><span data-stu-id="d5776-560">Test app</span></span> | <span data-ttu-id="d5776-561">*tests/RazorPagesProject.Tests*</span><span class="sxs-lookup"><span data-stu-id="d5776-561">*tests/RazorPagesProject.Tests*</span></span> | <span data-ttu-id="d5776-562">Utilisé pour tester l’intégration du SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-562">Used to integration test the SUT.</span></span> |

<span data-ttu-id="d5776-563">Les tests peuvent être exécutés à l’aide des fonctionnalités de test intégrées d’un IDE, tels que [Visual Studio](https://visualstudio.microsoft.com).</span><span class="sxs-lookup"><span data-stu-id="d5776-563">The tests can be run using the built-in test features of an IDE, such as [Visual Studio](https://visualstudio.microsoft.com).</span></span> <span data-ttu-id="d5776-564">Si vous utilisez [visual Studio Code](https://code.visualstudio.com/) ou la ligne de commande, exécutez la commande suivante à une invite de commande dans le répertoire *tests/RazorPagesProject.Tests* :</span><span class="sxs-lookup"><span data-stu-id="d5776-564">If using [Visual Studio Code](https://code.visualstudio.com/) or the command line, execute the following command at a command prompt in the *tests/RazorPagesProject.Tests* directory:</span></span>

```dotnetcli
dotnet test
```

### <a name="message-app-sut-organization"></a><span data-ttu-id="d5776-565">Organisation de l’application de message (SUT)</span><span class="sxs-lookup"><span data-stu-id="d5776-565">Message app (SUT) organization</span></span>

<span data-ttu-id="d5776-566">Le SUT est un système de messages Razor Pages avec les caractéristiques suivantes :</span><span class="sxs-lookup"><span data-stu-id="d5776-566">The SUT is a Razor Pages message system with the following characteristics:</span></span>

* <span data-ttu-id="d5776-567">La page d’index de l’application *(Pages/Index.cshtml* et *Pages/Index.cshtml.cs*) fournit une interface utilisateur et des méthodes de modèle de page pour contrôler l’ajout, la suppression et l’analyse des messages (mots moyens par message).</span><span class="sxs-lookup"><span data-stu-id="d5776-567">The Index page of the app (*Pages/Index.cshtml* and *Pages/Index.cshtml.cs*) provides a UI and page model methods to control the addition, deletion, and analysis of messages (average words per message).</span></span>
* <span data-ttu-id="d5776-568">Un message est `Message` décrit par la classe (*Data/Message.cs*) avec deux propriétés: `Id` (clé) et `Text` (message).</span><span class="sxs-lookup"><span data-stu-id="d5776-568">A message is described by the `Message` class (*Data/Message.cs*) with two properties: `Id` (key) and `Text` (message).</span></span> <span data-ttu-id="d5776-569">La `Text` propriété est requise et limitée à 200 caractères.</span><span class="sxs-lookup"><span data-stu-id="d5776-569">The `Text` property is required and limited to 200 characters.</span></span>
* <span data-ttu-id="d5776-570">Les messages sont stockés [à l’aide de la base de données en mémoire d’Entity Framework](/ef/core/providers/in-memory/)&#8224;.</span><span class="sxs-lookup"><span data-stu-id="d5776-570">Messages are stored using [Entity Framework's in-memory database](/ef/core/providers/in-memory/)&#8224;.</span></span>
* <span data-ttu-id="d5776-571">L’application contient une couche d’accès aux `AppDbContext` données (DAL) dans sa classe de contexte de base de données, (*Data/AppDbContext.cs*).</span><span class="sxs-lookup"><span data-stu-id="d5776-571">The app contains a data access layer (DAL) in its database context class, `AppDbContext` (*Data/AppDbContext.cs*).</span></span>
* <span data-ttu-id="d5776-572">Si la base de données est vide sur le démarrage de l’application, le magasin de messages est paraséfié avec trois messages.</span><span class="sxs-lookup"><span data-stu-id="d5776-572">If the database is empty on app startup, the message store is initialized with three messages.</span></span>
* <span data-ttu-id="d5776-573">L’application `/SecurePage` comprend un qui ne peut être consulté que par un utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="d5776-573">The app includes a `/SecurePage` that can only be accessed by an authenticated user.</span></span>

<span data-ttu-id="d5776-574">&#8224;Le sujet EF, [Test with InMemory](/ef/core/miscellaneous/testing/in-memory), explique comment utiliser une base de données en mémoire pour les tests avec MSTest.</span><span class="sxs-lookup"><span data-stu-id="d5776-574">&#8224;The EF topic, [Test with InMemory](/ef/core/miscellaneous/testing/in-memory), explains how to use an in-memory database for tests with MSTest.</span></span> <span data-ttu-id="d5776-575">Ce sujet utilise le cadre de test [xUnit.](https://xunit.github.io/)</span><span class="sxs-lookup"><span data-stu-id="d5776-575">This topic uses the [xUnit](https://xunit.github.io/) test framework.</span></span> <span data-ttu-id="d5776-576">Les concepts de test et les implémentations de tests dans différents cadres de test sont similaires mais non identiques.</span><span class="sxs-lookup"><span data-stu-id="d5776-576">Test concepts and test implementations across different test frameworks are similar but not identical.</span></span>

<span data-ttu-id="d5776-577">Bien que l’application n’utilise pas le modèle de référentiel et n’est pas un exemple efficace du [modèle de l’Unité de travail (UoW),](https://martinfowler.com/eaaCatalog/unitOfWork.html)Razor Pages prend en charge ces modèles de développement.</span><span class="sxs-lookup"><span data-stu-id="d5776-577">Although the app doesn't use the repository pattern and isn't an effective example of the [Unit of Work (UoW) pattern](https://martinfowler.com/eaaCatalog/unitOfWork.html), Razor Pages supports these patterns of development.</span></span> <span data-ttu-id="d5776-578">Pour plus d’informations, voir [Concevoir la couche de persistance de l’infrastructure](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) et la logique du contrôleur de [test](/aspnet/core/mvc/controllers/testing) (l’échantillon implémente le modèle de dépôt).</span><span class="sxs-lookup"><span data-stu-id="d5776-578">For more information, see [Designing the infrastructure persistence layer](/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design) and [Test controller logic](/aspnet/core/mvc/controllers/testing) (the sample implements the repository pattern).</span></span>

### <a name="test-app-organization"></a><span data-ttu-id="d5776-579">Organisation d’applications de test</span><span class="sxs-lookup"><span data-stu-id="d5776-579">Test app organization</span></span>

<span data-ttu-id="d5776-580">L’application de test est une application console à l’intérieur du *répertoire tests/RazorPagesProject.Tests.*</span><span class="sxs-lookup"><span data-stu-id="d5776-580">The test app is a console app inside the *tests/RazorPagesProject.Tests* directory.</span></span>

| <span data-ttu-id="d5776-581">Annuaire d’applications de test</span><span class="sxs-lookup"><span data-stu-id="d5776-581">Test app directory</span></span> | <span data-ttu-id="d5776-582">Description</span><span class="sxs-lookup"><span data-stu-id="d5776-582">Description</span></span> |
| ------------------ | ----------- |
| <span data-ttu-id="d5776-583">*AuthTests*</span><span class="sxs-lookup"><span data-stu-id="d5776-583">*AuthTests*</span></span> | <span data-ttu-id="d5776-584">Contient des méthodes de test pour :</span><span class="sxs-lookup"><span data-stu-id="d5776-584">Contains test methods for:</span></span><ul><li><span data-ttu-id="d5776-585">Accès à une page sécurisée par un utilisateur non athéné.</span><span class="sxs-lookup"><span data-stu-id="d5776-585">Accessing a secure page by an unauthenticated user.</span></span></li><li><span data-ttu-id="d5776-586">Accéder à une page sécurisée par un <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1>utilisateur authentifié avec un simulacre .</span><span class="sxs-lookup"><span data-stu-id="d5776-586">Accessing a secure page by an authenticated user with a mock <xref:Microsoft.AspNetCore.Authentication.AuthenticationHandler`1>.</span></span></li><li><span data-ttu-id="d5776-587">Obtenir un profil d’utilisateur GitHub et vérifier la connexion utilisateur du profil.</span><span class="sxs-lookup"><span data-stu-id="d5776-587">Obtaining a GitHub user profile and checking the profile's user login.</span></span></li></ul> |
| <span data-ttu-id="d5776-588">*Tests de base*</span><span class="sxs-lookup"><span data-stu-id="d5776-588">*BasicTests*</span></span> | <span data-ttu-id="d5776-589">Contient une méthode de test pour le routage et le type de contenu.</span><span class="sxs-lookup"><span data-stu-id="d5776-589">Contains a test method for routing and content type.</span></span> |
| <span data-ttu-id="d5776-590">*IntegrationTests*</span><span class="sxs-lookup"><span data-stu-id="d5776-590">*IntegrationTests*</span></span> | <span data-ttu-id="d5776-591">Contient les tests d’intégration `WebApplicationFactory` pour la page Index à l’aide de la classe personnalisée.</span><span class="sxs-lookup"><span data-stu-id="d5776-591">Contains the integration tests for the Index page using custom `WebApplicationFactory` class.</span></span> |
| <span data-ttu-id="d5776-592">*Aides/Services publics*</span><span class="sxs-lookup"><span data-stu-id="d5776-592">*Helpers/Utilities*</span></span> | <ul><li><span data-ttu-id="d5776-593">*Utilities.cs* contient la `InitializeDbForTests` méthode utilisée pour ensemencer la base de données avec des données de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-593">*Utilities.cs* contains the `InitializeDbForTests` method used to seed the database with test data.</span></span></li><li><span data-ttu-id="d5776-594">*HtmlHelpers.cs* fournit une méthode pour retourner `IHtmlDocument` un AngleSharp pour une utilisation par les méthodes d’essai.</span><span class="sxs-lookup"><span data-stu-id="d5776-594">*HtmlHelpers.cs* provides a method to return an AngleSharp `IHtmlDocument` for use by the test methods.</span></span></li><li><span data-ttu-id="d5776-595">*HttpClientExtensions.cs* fournir des surcharges `SendAsync` pour soumettre des demandes au SUT.</span><span class="sxs-lookup"><span data-stu-id="d5776-595">*HttpClientExtensions.cs* provide overloads for `SendAsync` to submit requests to the SUT.</span></span></li></ul> |

<span data-ttu-id="d5776-596">Le cadre d’essai est [xUnit](https://xunit.github.io/).</span><span class="sxs-lookup"><span data-stu-id="d5776-596">The test framework is [xUnit](https://xunit.github.io/).</span></span> <span data-ttu-id="d5776-597">Les tests d’intégration sont effectués à l’aide de [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), qui comprend le [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span><span class="sxs-lookup"><span data-stu-id="d5776-597">Integration tests are conducted using the [Microsoft.AspNetCore.TestHost](/dotnet/api/microsoft.aspnetcore.testhost), which includes the [TestServer](/dotnet/api/microsoft.aspnetcore.testhost.testserver).</span></span> <span data-ttu-id="d5776-598">Étant donné que le package [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) est utilisé `TestHost` pour `TestServer` configurer l’hôte de test et le serveur de test, le paquet et les paquets ne nécessitent pas de références de paquets directs dans le fichier de projet ou la configuration du développeur de l’application de test dans l’application de test.</span><span class="sxs-lookup"><span data-stu-id="d5776-598">Because the [Microsoft.AspNetCore.Mvc.Testing](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Testing) package is used to configure the test host and test server, the `TestHost` and `TestServer` packages don't require direct package references in the test app's project file or developer configuration in the test app.</span></span>

<span data-ttu-id="d5776-599">**Ensemencement de la base de données pour les tests**</span><span class="sxs-lookup"><span data-stu-id="d5776-599">**Seeding the database for testing**</span></span>

<span data-ttu-id="d5776-600">Les tests d’intégration nécessitent généralement un petit jeu de données dans la base de données avant l’exécution du test.</span><span class="sxs-lookup"><span data-stu-id="d5776-600">Integration tests usually require a small dataset in the database prior to the test execution.</span></span> <span data-ttu-id="d5776-601">Par exemple, un test de suppression nécessite une suppression d’enregistrement de base de données, de sorte que la base de données doit avoir au moins un enregistrement pour que la demande de suppression réussisse.</span><span class="sxs-lookup"><span data-stu-id="d5776-601">For example, a delete test calls for a database record deletion, so the database must have at least one record for the delete request to succeed.</span></span>

<span data-ttu-id="d5776-602">L’application échantillon de graines de la base de données avec trois messages dans *Utilities.cs* que les tests peuvent utiliser quand ils exécutent:</span><span class="sxs-lookup"><span data-stu-id="d5776-602">The sample app seeds the database with three messages in *Utilities.cs* that tests can use when they execute:</span></span>

[!code-csharp[](integration-tests/samples/2.x/IntegrationTestsSample/tests/RazorPagesProject.Tests/Helpers/Utilities.cs?name=snippet1)]

::: moniker-end

## <a name="additional-resources"></a><span data-ttu-id="d5776-603">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="d5776-603">Additional resources</span></span>

* [<span data-ttu-id="d5776-604">Tests unitaires</span><span class="sxs-lookup"><span data-stu-id="d5776-604">Unit tests</span></span>](/dotnet/articles/core/testing/unit-testing-with-dotnet-test)
* <xref:test/razor-pages-tests>
* <xref:fundamentals/middleware/index>
* <xref:mvc/controllers/testing>
