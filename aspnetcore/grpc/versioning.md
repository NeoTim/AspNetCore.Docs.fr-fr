---
title: Contrôle de version des services gRPC
author: jamesnk
description: Apprenez à la version des services gRPC.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 01/09/2020
uid: grpc/versioning
ms.openlocfilehash: 9bd76009ba28a1abef25a98686afea6753d4a8f4
ms.sourcegitcommit: f7886fd2e219db9d7ce27b16c0dc5901e658d64e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/06/2020
ms.locfileid: "78664114"
---
# <a name="versioning-grpc-services"></a><span data-ttu-id="f4f94-103">Contrôle de version des services gRPC</span><span class="sxs-lookup"><span data-stu-id="f4f94-103">Versioning gRPC services</span></span>

<span data-ttu-id="f4f94-104">Par [James Newton-King](https://twitter.com/jamesnk)</span><span class="sxs-lookup"><span data-stu-id="f4f94-104">By [James Newton-King](https://twitter.com/jamesnk)</span></span>

<span data-ttu-id="f4f94-105">Les nouvelles fonctionnalités ajoutées à une application peuvent nécessiter des services gRPC fournis aux clients pour changer, parfois de manière inattendue et révolutionnaire.</span><span class="sxs-lookup"><span data-stu-id="f4f94-105">New features added to an app can require gRPC services provided to clients to change, sometimes in unexpected and breaking ways.</span></span> <span data-ttu-id="f4f94-106">Lorsque les services gRPC changent :</span><span class="sxs-lookup"><span data-stu-id="f4f94-106">When gRPC services change:</span></span>

* <span data-ttu-id="f4f94-107">Il faut tenir compte de l’impact des changements sur les clients.</span><span class="sxs-lookup"><span data-stu-id="f4f94-107">Consideration should be given on how changes impact clients.</span></span>
* <span data-ttu-id="f4f94-108">Une stratégie de version pour appuyer les changements devrait être mise en œuvre.</span><span class="sxs-lookup"><span data-stu-id="f4f94-108">A versioning strategy to support changes should be implemented.</span></span>

## <a name="backwards-compatibility"></a><span data-ttu-id="f4f94-109">Compatibilité descendante</span><span class="sxs-lookup"><span data-stu-id="f4f94-109">Backwards compatibility</span></span>

<span data-ttu-id="f4f94-110">Le protocole gRPC est conçu pour soutenir les services qui changent au fil du temps.</span><span class="sxs-lookup"><span data-stu-id="f4f94-110">The gRPC protocol is designed to support services that change over time.</span></span> <span data-ttu-id="f4f94-111">En général, les ajouts aux services et aux méthodes de gRPC ne sont pas révolutionnaires.</span><span class="sxs-lookup"><span data-stu-id="f4f94-111">Generally, additions to gRPC services and methods are non-breaking.</span></span> <span data-ttu-id="f4f94-112">Les modifications non-ruptures permettent aux clients existants de continuer à travailler sans modification.</span><span class="sxs-lookup"><span data-stu-id="f4f94-112">Non-breaking changes allow existing clients to continue working without changes.</span></span> <span data-ttu-id="f4f94-113">La modification ou la suppression des services gRPC brisent les changements.</span><span class="sxs-lookup"><span data-stu-id="f4f94-113">Changing or deleting gRPC services are breaking changes.</span></span> <span data-ttu-id="f4f94-114">Lorsque les services gRPC ont des changements de rupture, les clients utilisant ce service doivent être mis à jour et redéployés.</span><span class="sxs-lookup"><span data-stu-id="f4f94-114">When gRPC services have breaking changes, clients using that service have to be updated and redeployed.</span></span>

<span data-ttu-id="f4f94-115">L’apport de modifications non-révolutionnaires à un service présente un certain nombre d’avantages :</span><span class="sxs-lookup"><span data-stu-id="f4f94-115">Making non-breaking changes to a service has a number of benefits:</span></span>

* <span data-ttu-id="f4f94-116">Les clients existants continuent de fonctionner.</span><span class="sxs-lookup"><span data-stu-id="f4f94-116">Existing clients continue to run.</span></span>
* <span data-ttu-id="f4f94-117">Évite le travail consistant à informer les clients de briser les changements et à les mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="f4f94-117">Avoids work involved with notifying clients of breaking changes, and updating them.</span></span>
* <span data-ttu-id="f4f94-118">Une seule version du service doit être documentée et maintenue.</span><span class="sxs-lookup"><span data-stu-id="f4f94-118">Only one version of the service needs to be documented and maintained.</span></span>

### <a name="non-breaking-changes"></a><span data-ttu-id="f4f94-119">Changements non cassants</span><span class="sxs-lookup"><span data-stu-id="f4f94-119">Non-breaking changes</span></span>

<span data-ttu-id="f4f94-120">Ces modifications ne sont pas cassants à un niveau de protocole gRPC et .NET niveau binaire.</span><span class="sxs-lookup"><span data-stu-id="f4f94-120">These changes are non-breaking at a gRPC protocol level and .NET binary level.</span></span>

* <span data-ttu-id="f4f94-121">**Ajout d’un nouveau service**</span><span class="sxs-lookup"><span data-stu-id="f4f94-121">**Adding a new service**</span></span>
* <span data-ttu-id="f4f94-122">**Ajout d’une nouvelle méthode à un service**</span><span class="sxs-lookup"><span data-stu-id="f4f94-122">**Adding a new method to a service**</span></span>
* <span data-ttu-id="f4f94-123">**Ajout d’un champ à un message de demande** - Champs ajoutés à un message de demande sont déséialisés avec la valeur par [défaut](https://developers.google.com/protocol-buffers/docs/proto3#default) sur le serveur lorsqu’il n’est pas défini.</span><span class="sxs-lookup"><span data-stu-id="f4f94-123">**Adding a field to a request message** - Fields added to a request message are deserialized with the [default value](https://developers.google.com/protocol-buffers/docs/proto3#default) on the server when not set.</span></span> <span data-ttu-id="f4f94-124">Pour être un changement non-rupture, le service doit réussir lorsque le nouveau domaine n’est pas défini par des clients plus âgés.</span><span class="sxs-lookup"><span data-stu-id="f4f94-124">To be a non-breaking change, the service must succeed when the new field isn't set by older clients.</span></span>
* <span data-ttu-id="f4f94-125">**Ajout d’un champ à un message de réponse** - Champs ajoutés à un message de réponse sont déséialisés dans la collection de champs [inconnus](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) du message sur le client.</span><span class="sxs-lookup"><span data-stu-id="f4f94-125">**Adding a field to a response message** - Fields added to a response message are deserialized into the message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) collection on the client.</span></span>
* <span data-ttu-id="f4f94-126">**Ajout d’une valeur à un enum** - Enums sont sérialisés comme une valeur numérique.</span><span class="sxs-lookup"><span data-stu-id="f4f94-126">**Adding a value to an enum** - Enums are serialized as a numeric value.</span></span> <span data-ttu-id="f4f94-127">De nouvelles valeurs enum sont déséialisées sur le client à la valeur enum sans nom enum.</span><span class="sxs-lookup"><span data-stu-id="f4f94-127">New enum values are deserialized on the client to the enum value without an enum name.</span></span> <span data-ttu-id="f4f94-128">Pour être un changement non-rupture, les clients plus âgés doivent fonctionner correctement lors de la réception de la nouvelle valeur enum.</span><span class="sxs-lookup"><span data-stu-id="f4f94-128">To be a non-breaking change, older clients must run correctly when receiving the new enum value.</span></span>

### <a name="binary-breaking-changes"></a><span data-ttu-id="f4f94-129">Changements de rupture binaires</span><span class="sxs-lookup"><span data-stu-id="f4f94-129">Binary breaking changes</span></span>

<span data-ttu-id="f4f94-130">Les modifications suivantes ne sont pas rupture à un niveau de protocole gRPC, mais le client doit être mis à jour si elle se met à niveau vers le dernier contrat *.proto* ou client .NET assemblage.</span><span class="sxs-lookup"><span data-stu-id="f4f94-130">The following changes are non-breaking at a gRPC protocol level, but the client needs to be updated if it upgrades to the latest *.proto* contract or client .NET assembly.</span></span> <span data-ttu-id="f4f94-131">La compatibilité binaire est importante si vous prévoyez de publier une bibliothèque gRPC à NuGet.</span><span class="sxs-lookup"><span data-stu-id="f4f94-131">Binary compatibility is important if you plan to publish a gRPC library to NuGet.</span></span>

* <span data-ttu-id="f4f94-132">**Retrait d’un champ** - Les valeurs d’un champ supprimé sont déséialisées dans [les champs inconnus](https://developers.google.com/protocol-buffers/docs/proto3#unknowns)d’un message.</span><span class="sxs-lookup"><span data-stu-id="f4f94-132">**Removing a field** - Values from a removed field are deserialized to a message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns).</span></span> <span data-ttu-id="f4f94-133">Il ne s’agit pas d’un protocole gRPC brisant le changement, mais le client doit être mis à jour si elle met à niveau vers le dernier contrat.</span><span class="sxs-lookup"><span data-stu-id="f4f94-133">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="f4f94-134">Il est important qu’un numéro de champ supprimé ne soit pas accidentellement réutilisé à l’avenir.</span><span class="sxs-lookup"><span data-stu-id="f4f94-134">It's important that a removed field number isn't accidentally reused in the future.</span></span> <span data-ttu-id="f4f94-135">Pour s’assurer que cela ne se produise pas, spécifiez les numéros de champ supprimés et les noms sur le message à l’aide du mot clé [réservé](https://developers.google.com/protocol-buffers/docs/proto3#reserved) de Protobuf.</span><span class="sxs-lookup"><span data-stu-id="f4f94-135">To ensure this doesn't happen, specify deleted field numbers and names on the message using Protobuf's [reserved](https://developers.google.com/protocol-buffers/docs/proto3#reserved) keyword.</span></span>
* <span data-ttu-id="f4f94-136">**Renommer un message** - Les noms de messages ne sont généralement pas envoyés sur le réseau, donc ce n’est pas un protocole gRPC briser le changement.</span><span class="sxs-lookup"><span data-stu-id="f4f94-136">**Renaming a message** - Message names aren't typically sent on the network, so this isn't a gRPC protocol breaking change.</span></span> <span data-ttu-id="f4f94-137">Le client devra être mis à jour s’il passe à niveau vers le dernier contrat.</span><span class="sxs-lookup"><span data-stu-id="f4f94-137">The client will need to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="f4f94-138">Une situation où les noms de messages **sont** envoyés sur le réseau est avec [tous](https://developers.google.com/protocol-buffers/docs/proto3#any) les champs, lorsque le nom du message est utilisé pour identifier le type de message.</span><span class="sxs-lookup"><span data-stu-id="f4f94-138">One situation where message names **are** sent on the network is with [Any](https://developers.google.com/protocol-buffers/docs/proto3#any) fields, when the message name is used to identify the message type.</span></span>
* <span data-ttu-id="f4f94-139">**Changer csharp_namespace** - Changer `csharp_namespace` l’espace de nom des types générés .NET.</span><span class="sxs-lookup"><span data-stu-id="f4f94-139">**Changing csharp_namespace** - Changing `csharp_namespace` will change the namespace of generated .NET types.</span></span> <span data-ttu-id="f4f94-140">Il ne s’agit pas d’un protocole gRPC brisant le changement, mais le client doit être mis à jour si elle met à niveau vers le dernier contrat.</span><span class="sxs-lookup"><span data-stu-id="f4f94-140">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span>

### <a name="protocol-breaking-changes"></a><span data-ttu-id="f4f94-141">Modifications de rupture du protocole</span><span class="sxs-lookup"><span data-stu-id="f4f94-141">Protocol breaking changes</span></span>

<span data-ttu-id="f4f94-142">Les éléments suivants sont des changements de protocole et de rupture binaire :</span><span class="sxs-lookup"><span data-stu-id="f4f94-142">The following items are protocol and binary breaking changes:</span></span>

* <span data-ttu-id="f4f94-143">**Renommer un champ** - Avec le contenu Protobuf, les noms de champ ne sont utilisés que dans le code généré.</span><span class="sxs-lookup"><span data-stu-id="f4f94-143">**Renaming a field** - With Protobuf content, the field names are only used in generated code.</span></span> <span data-ttu-id="f4f94-144">Le numéro de champ est utilisé pour identifier les champs sur le réseau.</span><span class="sxs-lookup"><span data-stu-id="f4f94-144">The field number is used to identify fields on the network.</span></span> <span data-ttu-id="f4f94-145">Le changement de nom d’un champ n’est pas un changement de protocole pour Protobuf.</span><span class="sxs-lookup"><span data-stu-id="f4f94-145">Renaming a field isn't a protocol breaking change for Protobuf.</span></span> <span data-ttu-id="f4f94-146">Toutefois, si un serveur utilise du contenu JSON, le changement de champ est un changement de rupture.</span><span class="sxs-lookup"><span data-stu-id="f4f94-146">However, if a server is using JSON content then renaming a field is a breaking change.</span></span>
* <span data-ttu-id="f4f94-147">**Modification d’un type** de données sur le terrain - Changer le type de données d’un champ en un [type incompatible](https://developers.google.com/protocol-buffers/docs/proto3#updating) entraînera des erreurs lors du désétérialisation du message.</span><span class="sxs-lookup"><span data-stu-id="f4f94-147">**Changing a field data type** - Changing a field's data type to an [incompatible type](https://developers.google.com/protocol-buffers/docs/proto3#updating) will cause errors when deserializing the message.</span></span> <span data-ttu-id="f4f94-148">Même si le nouveau type de données est compatible, il est probable que le client doit être mis à jour pour prendre en charge le nouveau type s’il passe à la dernière période.</span><span class="sxs-lookup"><span data-stu-id="f4f94-148">Even if the new data type is compatible, it's likely the client needs to be updated to support the new type if it upgrades to the latest contract.</span></span>
* <span data-ttu-id="f4f94-149">**Modification d’un numéro de champ** - Avec les charges utiles Protobuf, le numéro de champ est utilisé pour identifier les champs sur le réseau.</span><span class="sxs-lookup"><span data-stu-id="f4f94-149">**Changing a field number** - With Protobuf payloads, the field number is used to identify fields on the network.</span></span>
* <span data-ttu-id="f4f94-150">**Renommer un paquet, un service ou une méthode** - gRPC utilise le nom du paquet, le nom de service et le nom de la méthode pour construire l’URL.</span><span class="sxs-lookup"><span data-stu-id="f4f94-150">**Renaming a package, service or method** - gRPC uses the package name, service name, and method name to build the URL.</span></span> <span data-ttu-id="f4f94-151">Le client obtient un statut *UNIMPLEMENTED* du serveur.</span><span class="sxs-lookup"><span data-stu-id="f4f94-151">The client gets an *UNIMPLEMENTED* status from the server.</span></span>
* <span data-ttu-id="f4f94-152">**Suppression d’un service ou d’une méthode** - Le client obtient un statut *UNIMPLEMENTED* du serveur lors de l’appel de la méthode supprimée.</span><span class="sxs-lookup"><span data-stu-id="f4f94-152">**Removing a service or method** - The client gets an *UNIMPLEMENTED* status from the server when calling the removed method.</span></span>

### <a name="behavior-breaking-changes"></a><span data-ttu-id="f4f94-153">Changements de rupture de comportement</span><span class="sxs-lookup"><span data-stu-id="f4f94-153">Behavior breaking changes</span></span>

<span data-ttu-id="f4f94-154">Lorsque vous modifiez les changements non-breaking, vous devez également vous demander si les clients plus âgés peuvent continuer à travailler avec le nouveau comportement de service.</span><span class="sxs-lookup"><span data-stu-id="f4f94-154">When making non-breaking changes, you must also consider whether older clients can continue working with the new service behavior.</span></span> <span data-ttu-id="f4f94-155">Par exemple, ajouter un nouveau champ à un message de demande :</span><span class="sxs-lookup"><span data-stu-id="f4f94-155">For example, adding a new field to a request message:</span></span>

* <span data-ttu-id="f4f94-156">Le protocole ne brise-t-il pas le changement.</span><span class="sxs-lookup"><span data-stu-id="f4f94-156">Isn't a protocol breaking change.</span></span>
* <span data-ttu-id="f4f94-157">Le retour d’un statut d’erreur sur le serveur si le nouveau champ n’est pas défini en fait un changement de rupture pour les anciens clients.</span><span class="sxs-lookup"><span data-stu-id="f4f94-157">Returning an error status on the server if the new field isn't set makes it a breaking change for old clients.</span></span>

<span data-ttu-id="f4f94-158">La compatibilité comportementale est déterminée par votre code spécifique à l’application.</span><span class="sxs-lookup"><span data-stu-id="f4f94-158">Behavior compatibility is determined by your app-specific code.</span></span>

## <a name="version-number-services"></a><span data-ttu-id="f4f94-159">Services de numéro de version</span><span class="sxs-lookup"><span data-stu-id="f4f94-159">Version number services</span></span>

<span data-ttu-id="f4f94-160">Les services doivent s’efforcer de rester compatibles avec les anciens clients.</span><span class="sxs-lookup"><span data-stu-id="f4f94-160">Services should strive to remain backwards compatible with old clients.</span></span> <span data-ttu-id="f4f94-161">Éventuellement, les modifications apportées à votre application peuvent nécessiter des modifications de rupture.</span><span class="sxs-lookup"><span data-stu-id="f4f94-161">Eventually changes to your app may require breaking changes.</span></span> <span data-ttu-id="f4f94-162">Briser les anciens clients et les forcer à être mis à jour avec votre service n’est pas une bonne expérience utilisateur.</span><span class="sxs-lookup"><span data-stu-id="f4f94-162">Breaking old clients and forcing them to be updated along with your service isn't a good user experience.</span></span> <span data-ttu-id="f4f94-163">Une façon de maintenir la compatibilité à l’envers tout en effectuant des modifications de rupture est de publier plusieurs versions d’un service.</span><span class="sxs-lookup"><span data-stu-id="f4f94-163">A way to maintain backwards compatibility while making breaking changes is to publish multiple versions of a service.</span></span>

<span data-ttu-id="f4f94-164">gRPC prend en charge un spécificateur [de paquet](https://developers.google.com/protocol-buffers/docs/proto3#packages) optionnel, qui fonctionne un peu comme un espace de nom .NET.</span><span class="sxs-lookup"><span data-stu-id="f4f94-164">gRPC supports an optional [package](https://developers.google.com/protocol-buffers/docs/proto3#packages) specifier, which functions much like a .NET namespace.</span></span> <span data-ttu-id="f4f94-165">En fait, `package` le sera utilisé comme l’espace de `option csharp_namespace` nom .NET généré pour les types générés .NET si n’est pas défini dans le fichier *.proto.*</span><span class="sxs-lookup"><span data-stu-id="f4f94-165">In fact, the `package` will be used as the .NET namespace for generated .NET types if `option csharp_namespace` is not set in the *.proto* file.</span></span> <span data-ttu-id="f4f94-166">Le paquet peut être utilisé pour spécifier un numéro de version pour votre service et ses messages :</span><span class="sxs-lookup"><span data-stu-id="f4f94-166">The package can be used to specify a version number for your service and its messages:</span></span>

[!code-protobuf[](versioning/sample/greet.v1.proto?highlight=3)]

<span data-ttu-id="f4f94-167">Le nom du forfait est combiné avec le nom de service pour identifier une adresse de service.</span><span class="sxs-lookup"><span data-stu-id="f4f94-167">The package name is combined with the service name to identify a service address.</span></span> <span data-ttu-id="f4f94-168">Une adresse de service permet d’héberger plusieurs versions d’un service côte à côte :</span><span class="sxs-lookup"><span data-stu-id="f4f94-168">A service address allows multiple versions of a service to be hosted side-by-side:</span></span>

* `greet.v1.Greeter`
* `greet.v2.Greeter`

<span data-ttu-id="f4f94-169">Les implémentations du service versionné sont enregistrées en *Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="f4f94-169">Implementations of the versioned service are registered in *Startup.cs*:</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Implements greet.v1.Greeter
    endpoints.MapGrpcService<GreeterServiceV1>();

    // Implements greet.v2.Greeter
    endpoints.MapGrpcService<GreeterServiceV2>();
});
```

<span data-ttu-id="f4f94-170">L’inclusion d’un numéro de version dans le nom du paquet vous donne la possibilité de publier une version *v2* de votre service avec des modifications de rupture, tout en continuant à soutenir les clients plus âgés qui appellent la version *v1.*</span><span class="sxs-lookup"><span data-stu-id="f4f94-170">Including a version number in the package name gives you the opportunity to publish a *v2* version of your service with breaking changes, while continuing to support older clients who call the *v1* version.</span></span> <span data-ttu-id="f4f94-171">Une fois que les clients ont mis à jour pour utiliser le service *v2,* vous pouvez choisir de supprimer l’ancienne version.</span><span class="sxs-lookup"><span data-stu-id="f4f94-171">Once clients have updated to use the *v2* service, you can choose to remove the old version.</span></span> <span data-ttu-id="f4f94-172">Lors de la planification de la publication de plusieurs versions d’un service:</span><span class="sxs-lookup"><span data-stu-id="f4f94-172">When planning to publish multiple versions of a service:</span></span>

* <span data-ttu-id="f4f94-173">Évitez de briser les changements si cela est raisonnable.</span><span class="sxs-lookup"><span data-stu-id="f4f94-173">Avoid breaking changes if reasonable.</span></span>
* <span data-ttu-id="f4f94-174">Ne mettez pas à jour le numéro de version à moins d’apporter des modifications de rupture.</span><span class="sxs-lookup"><span data-stu-id="f4f94-174">Don't update the version number unless making breaking changes.</span></span>
* <span data-ttu-id="f4f94-175">Mettez à jour le numéro de version lorsque vous effectuez des modifications de rupture.</span><span class="sxs-lookup"><span data-stu-id="f4f94-175">Do update the version number when you make breaking changes.</span></span>

<span data-ttu-id="f4f94-176">La publication de plusieurs versions d’un service le double.</span><span class="sxs-lookup"><span data-stu-id="f4f94-176">Publishing multiple versions of a service duplicates it.</span></span> <span data-ttu-id="f4f94-177">Pour réduire les chevauchements, envisagez de déplacer la logique commerciale des implémentations de services vers un emplacement centralisé qui peut être réutilisé par les anciennes et nouvelles implémentations :</span><span class="sxs-lookup"><span data-stu-id="f4f94-177">To reduce duplication, consider moving business logic from the service implementations to a centralized location that can be reused by the old and new implementations:</span></span>

[!code-csharp[](versioning/sample/GreeterServiceV1.cs?highlight=10,19)]

<span data-ttu-id="f4f94-178">Les services et les messages générés avec différents noms de paquets sont **différents types .NET**.</span><span class="sxs-lookup"><span data-stu-id="f4f94-178">Services and messages generated with different package names are **different .NET types**.</span></span> <span data-ttu-id="f4f94-179">Le déplacement de la logique d’entreprise vers un emplacement centralisé nécessite la cartographie des messages vers des types communs.</span><span class="sxs-lookup"><span data-stu-id="f4f94-179">Moving business logic to a centralized location requires mapping messages to common types.</span></span>
